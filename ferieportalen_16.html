<!DOCTYPE html>
<html lang="no">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ferieportalen ‚Äì Oslo Kommune</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Source+Serif+4:wght@300;400;600&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --ok-blue: #003087;
    --ok-red: #C8102E;
    --ok-light: #f5f6fa;
    --ok-border: #dde1ea;
    --ok-text: #1a1d2e;
    --ok-muted: #6b7080;
    --ok-card: #ffffff;
    --ok-accent: #e8ecf7;
    --ok-green: #1a7a4a;
    --ok-yellow: #f4a900;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--ok-light);
    color: var(--ok-text);
    min-height: 100vh;
  }

  /* ‚îÄ‚îÄ TOP BAR ‚îÄ‚îÄ */
  .topbar {
    background: var(--ok-blue);
    color: white;
    font-size: 12px;
    padding: 6px 24px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .topbar a { color: rgba(255,255,255,0.75); text-decoration: none; }
  .topbar a:hover { color: white; }

  /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
  header {
    background: white;
    border-bottom: 3px solid var(--ok-blue);
    padding: 0 24px;
  }
  .header-inner {
    max-width: 1100px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 0;
  }
  .logo-area { display: flex; align-items: center; gap: 14px; }
  .logo-shield {
    width: 44px; height: 44px;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
  }
  .logo-text h1 {
    font-family: 'Source Serif 4', serif;
    font-size: 20px;
    font-weight: 600;
    color: var(--ok-blue);
    line-height: 1.1;
  }
  .logo-text span {
    font-size: 11px;
    color: var(--ok-muted);
    font-weight: 300;
    text-transform: uppercase;
    letter-spacing: 1px;
  }
  nav { display: flex; gap: 8px; align-items: center; }
  nav button {
    background: none;
    border: 1px solid var(--ok-border);
    border-radius: 6px;
    padding: 7px 14px;
    font-size: 13px;
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
    color: var(--ok-text);
    transition: all .15s;
  }
  nav button:hover { background: var(--ok-accent); border-color: var(--ok-blue); }
  nav button.admin-btn {
    background: var(--ok-blue);
    color: white;
    border-color: var(--ok-blue);
  }
  nav button.admin-btn:hover { background: #00246b; }
  nav button.logout-btn {
    background: var(--ok-red);
    color: white;
    border-color: var(--ok-red);
  }

  /* ‚îÄ‚îÄ PAGES ‚îÄ‚îÄ */
  .page { display: none; }
  .page.active { display: block; }

  /* ‚îÄ‚îÄ HERO / SEARCH ‚îÄ‚îÄ */
  .hero {
    max-width: 700px;
    margin: 60px auto 40px;
    text-align: center;
    padding: 0 16px;
  }
  .hero h2 {
    font-family: 'Source Serif 4', serif;
    font-size: 32px;
    font-weight: 300;
    color: var(--ok-blue);
    margin-bottom: 8px;
  }
  .hero p {
    color: var(--ok-muted);
    font-size: 15px;
    margin-bottom: 28px;
  }
  .search-box {
    display: flex;
    background: white;
    border: 2px solid var(--ok-border);
    border-radius: 40px;
    overflow: hidden;
    box-shadow: 0 2px 16px rgba(0,48,135,.08);
    transition: border-color .2s;
  }
  .search-box:focus-within { border-color: var(--ok-blue); }
  .search-box input {
    flex: 1;
    border: none;
    outline: none;
    padding: 14px 22px;
    font-size: 16px;
    font-family: 'DM Sans', sans-serif;
    background: transparent;
  }
  .search-box button {
    background: var(--ok-blue);
    color: white;
    border: none;
    padding: 14px 26px;
    font-size: 15px;
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
    font-weight: 500;
    border-radius: 0 38px 38px 0;
    transition: background .15s;
  }
  .search-box button:hover { background: #00246b; }

  /* Quick filters */
  .quick-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    justify-content: center;
    margin-top: 16px;
  }
  .quick-tags button {
    background: white;
    border: 1px solid var(--ok-border);
    border-radius: 20px;
    padding: 5px 14px;
    font-size: 13px;
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
    color: var(--ok-blue);
    transition: all .15s;
  }
  .quick-tags button:hover {
    background: var(--ok-blue);
    color: white;
    border-color: var(--ok-blue);
  }

  /* ‚îÄ‚îÄ HOME LAYOUT (main + sidebar) ‚îÄ‚îÄ */
  .home-layout {
    max-width: 1200px;
    margin: 0 auto 60px;
    padding: 0 16px;
    display: grid;
    grid-template-columns: 1fr 300px;
    gap: 28px;
    align-items: start;
  }

  /* ‚îÄ‚îÄ ANNOUNCEMENTS PANEL ‚îÄ‚îÄ */
  .announcements-panel {
    background: white;
    border: 1px solid var(--ok-border);
    border-radius: 10px;
    overflow: hidden;
    position: sticky;
    top: 16px;
  }
  .ann-header {
    background: var(--ok-blue);
    color: white;
    padding: 12px 16px;
    font-size: 13.5px;
    font-weight: 500;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .ann-header span { font-size: 11px; opacity: .75; }
  .ann-list { padding: 0; }
  .ann-item {
    padding: 14px 16px;
    border-bottom: 1px solid var(--ok-border);
    font-size: 13px;
    line-height: 1.55;
  }
  .ann-item:last-child { border-bottom: none; }
  .ann-item-title {
    font-weight: 500;
    color: var(--ok-text);
    margin-bottom: 4px;
    display: flex;
    align-items: flex-start;
    gap: 6px;
  }
  .ann-item-body { color: var(--ok-muted); font-size: 12.5px; }
  .ann-item-meta { font-size: 11px; color: #aab0c0; margin-top: 5px; }
  .ann-badge {
    font-size: 10px;
    padding: 2px 7px;
    border-radius: 10px;
    font-weight: 600;
    white-space: nowrap;
    margin-top: 1px;
  }
  .ann-badge-red { background: #fde8ec; color: var(--ok-red); }
  .ann-badge-blue { background: #e0e8f7; color: var(--ok-blue); }
  .ann-badge-green { background: #e0f4ec; color: var(--ok-green); }
  .ann-badge-yellow { background: #fef3d8; color: #7a5200; }
  .ann-empty { padding: 20px 16px; font-size: 13px; color: var(--ok-muted); text-align: center; }
  .ann-admin-btn {
    display: block;
    width: 100%;
    background: var(--ok-accent);
    border: none;
    border-top: 1px solid var(--ok-border);
    padding: 10px;
    font-size: 12.5px;
    color: var(--ok-blue);
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
    transition: background .15s;
  }
  .ann-admin-btn:hover { background: #d4dcf0; }

  /* ‚îÄ‚îÄ CATEGORIES ‚îÄ‚îÄ */
  .categories {
    margin: 0;
  }
  .section-title {
    font-family: 'Source Serif 4', serif;
    font-size: 18px;
    font-weight: 400;
    color: var(--ok-blue);
    margin-bottom: 16px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--ok-border);
  }
  .card-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
    gap: 16px;
  }
  .card {
    background: white;
    border: 1px solid var(--ok-border);
    border-radius: 10px;
    padding: 22px 20px;
    cursor: pointer;
    transition: all .2s;
    text-align: left;
  }
  .card:hover {
    border-color: var(--ok-blue);
    box-shadow: 0 4px 16px rgba(0,48,135,.1);
    transform: translateY(-2px);
  }
  .card-icon {
    width: 38px; height: 38px;
    border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    font-size: 18px;
    margin-bottom: 12px;
  }
  .card h3 {
    font-size: 15px;
    font-weight: 500;
    margin-bottom: 5px;
  }
  .card p {
    font-size: 12.5px;
    color: var(--ok-muted);
    line-height: 1.5;
  }

  /* ‚îÄ‚îÄ FERIEKALKULATOR ‚îÄ‚îÄ */
  .calc-box {
    background: linear-gradient(135deg, #f0f4ff 0%, #e8f0fe 100%);
    border: 1.5px solid #c5d3f0;
    border-radius: 12px;
    padding: 24px 26px;
    margin: 28px 0;
  }
  .calc-box h3 {
    font-family: 'Source Serif 4', serif;
    font-size: 17px;
    color: var(--ok-blue);
    margin-bottom: 18px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .calc-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 14px;
    margin-bottom: 18px;
  }
  .calc-field label {
    display: block;
    font-size: 12px;
    font-weight: 500;
    color: var(--ok-muted);
    text-transform: uppercase;
    letter-spacing: .5px;
    margin-bottom: 5px;
  }
  .calc-field input, .calc-field select {
    width: 100%;
    border: 1px solid #c5d3f0;
    border-radius: 7px;
    padding: 9px 12px;
    font-size: 14px;
    font-family: 'DM Sans', sans-serif;
    background: white;
    outline: none;
    transition: border-color .15s;
  }
  .calc-field input:focus, .calc-field select:focus { border-color: var(--ok-blue); }
  .calc-run-btn {
    background: var(--ok-blue);
    color: white;
    border: none;
    padding: 10px 24px;
    border-radius: 7px;
    font-size: 14px;
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
    font-weight: 500;
    transition: background .15s;
  }
  .calc-run-btn:hover { background: #00246b; }
  .calc-result {
    display: none;
    margin-top: 18px;
    background: white;
    border-radius: 8px;
    padding: 18px 20px;
    border: 1px solid #c5d3f0;
  }
  .calc-result.show { display: block; }
  .calc-result-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 12px;
    margin-bottom: 14px;
  }
  .calc-stat {
    background: var(--ok-accent);
    border-radius: 8px;
    padding: 12px 14px;
  }
  .calc-stat .cs-label { font-size: 11px; color: var(--ok-muted); text-transform: uppercase; letter-spacing: .5px; margin-bottom: 4px; }
  .calc-stat .cs-value { font-size: 22px; font-weight: 600; color: var(--ok-blue); }
  .calc-stat .cs-sub { font-size: 11.5px; color: var(--ok-muted); margin-top: 2px; }
  .calc-note { font-size: 12px; color: var(--ok-muted); border-top: 1px solid var(--ok-border); padding-top: 10px; }

  /* ‚îÄ‚îÄ SEARCH RESULTS ‚îÄ‚îÄ */
  .results-wrap {
    max-width: 860px;
    margin: 0 auto;
    padding: 0 16px 60px;
  }
  .results-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }
  .results-header h3 {
    font-family: 'Source Serif 4', serif;
    font-size: 18px;
    font-weight: 400;
    color: var(--ok-text);
  }
  .results-header span { font-size: 13px; color: var(--ok-muted); }

  .result-item {
    background: white;
    border: 1px solid var(--ok-border);
    border-radius: 10px;
    padding: 20px 24px;
    margin-bottom: 12px;
    cursor: pointer;
    transition: border-color .15s;
  }
  .result-item:hover { border-color: var(--ok-blue); }
  .result-item h4 { font-size: 16px; font-weight: 500; color: var(--ok-blue); margin-bottom: 6px; }
  .result-item p { font-size: 13.5px; color: var(--ok-muted); line-height: 1.6; }
  .result-meta {
    display: flex; gap: 10px; margin-top: 10px;
    flex-wrap: wrap;
  }
  .tag {
    font-size: 11px;
    padding: 3px 10px;
    border-radius: 12px;
    font-weight: 500;
  }
  .tag-blue { background: #e0e8f7; color: var(--ok-blue); }
  .tag-green { background: #e0f4ec; color: var(--ok-green); }
  .tag-yellow { background: #fef3d8; color: #8a5e00; }
  .tag-red { background: #fde8ec; color: var(--ok-red); }

  /* ‚îÄ‚îÄ ARTICLE VIEW ‚îÄ‚îÄ */
  .article-wrap {
    max-width: 780px;
    margin: 0 auto;
    padding: 0 16px 80px;
  }
  .breadcrumb {
    font-size: 12.5px;
    color: var(--ok-muted);
    margin-bottom: 24px;
    display: flex; gap: 6px; align-items: center;
  }
  .breadcrumb a { color: var(--ok-blue); text-decoration: none; cursor: pointer; }
  .breadcrumb a:hover { text-decoration: underline; }
  .article-header {
    margin-bottom: 32px;
    padding-bottom: 20px;
    border-bottom: 2px solid var(--ok-blue);
  }
  .article-header h2 {
    font-family: 'Source Serif 4', serif;
    font-size: 28px;
    font-weight: 400;
    color: var(--ok-blue);
    margin-bottom: 10px;
  }
  .article-meta { font-size: 12.5px; color: var(--ok-muted); display: flex; gap: 16px; flex-wrap: wrap; }
  .article-body { font-size: 15px; line-height: 1.75; color: var(--ok-text); }
  .article-body h3 {
    font-family: 'Source Serif 4', serif;
    font-size: 18px;
    font-weight: 600;
    color: var(--ok-blue);
    margin: 28px 0 10px;
  }
  .article-body p { margin-bottom: 14px; }
  .article-body ul { margin: 10px 0 14px 20px; }
  .article-body li { margin-bottom: 6px; line-height: 1.65; }
  .info-box {
    background: var(--ok-accent);
    border-left: 4px solid var(--ok-blue);
    border-radius: 0 8px 8px 0;
    padding: 14px 18px;
    margin: 18px 0;
    font-size: 14px;
  }
  .warn-box {
    background: #fef3d8;
    border-left: 4px solid var(--ok-yellow);
    border-radius: 0 8px 8px 0;
    padding: 14px 18px;
    margin: 18px 0;
    font-size: 14px;
  }
  .source-box {
    background: #f0f0f5;
    border-radius: 8px;
    padding: 14px 18px;
    margin-top: 30px;
    font-size: 12.5px;
    color: var(--ok-muted);
  }
  .source-box strong { color: var(--ok-text); }

  /* ‚îÄ‚îÄ ADMIN PANEL ‚îÄ‚îÄ */
  .admin-wrap {
    max-width: 1000px;
    margin: 0 auto;
    padding: 0 16px 80px;
  }
  .admin-header {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 28px;
    padding-bottom: 16px;
    border-bottom: 2px solid var(--ok-blue);
  }
  .admin-header h2 {
    font-family: 'Source Serif 4', serif;
    font-size: 24px;
    font-weight: 400;
    color: var(--ok-blue);
  }
  .admin-grid { display: grid; grid-template-columns: 280px 1fr; gap: 20px; }
  .admin-sidebar { background: white; border: 1px solid var(--ok-border); border-radius: 10px; overflow: hidden; height: fit-content; }
  .admin-sidebar-item {
    padding: 12px 18px;
    font-size: 14px;
    cursor: pointer;
    border-bottom: 1px solid var(--ok-border);
    transition: background .1s;
    display: flex; justify-content: space-between; align-items: center;
  }
  .admin-sidebar-item:hover { background: var(--ok-accent); }
  .admin-sidebar-item.active { background: var(--ok-blue); color: white; }
  .admin-sidebar-item:last-child { border-bottom: none; }
  .admin-main { background: white; border: 1px solid var(--ok-border); border-radius: 10px; padding: 24px; }
  .form-group { margin-bottom: 18px; }
  .form-group label {
    display: block;
    font-size: 13px;
    font-weight: 500;
    margin-bottom: 6px;
    color: var(--ok-text);
  }
  .form-group input, .form-group textarea, .form-group select {
    width: 100%;
    border: 1px solid var(--ok-border);
    border-radius: 6px;
    padding: 10px 12px;
    font-size: 14px;
    font-family: 'DM Sans', sans-serif;
    outline: none;
    transition: border-color .15s;
  }
  .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
    border-color: var(--ok-blue);
  }
  .form-group textarea { min-height: 200px; resize: vertical; line-height: 1.6; }
  .btn-primary {
    background: var(--ok-blue);
    color: white;
    border: none;
    padding: 10px 22px;
    border-radius: 6px;
    font-size: 14px;
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
    font-weight: 500;
    transition: background .15s;
    margin-right: 8px;
  }
  .btn-primary:hover { background: #00246b; }
  .btn-danger {
    background: var(--ok-red);
    color: white;
    border: none;
    padding: 10px 22px;
    border-radius: 6px;
    font-size: 14px;
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
    font-weight: 500;
  }
  .btn-secondary {
    background: white;
    color: var(--ok-text);
    border: 1px solid var(--ok-border);
    padding: 10px 22px;
    border-radius: 6px;
    font-size: 14px;
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
  }
  .articles-table { width: 100%; border-collapse: collapse; font-size: 13.5px; }
  .articles-table th { text-align: left; padding: 10px 12px; background: var(--ok-light); font-weight: 500; border-bottom: 2px solid var(--ok-border); }
  .articles-table td { padding: 10px 12px; border-bottom: 1px solid var(--ok-border); vertical-align: middle; }
  .articles-table tr:hover td { background: var(--ok-accent); }
  .edit-link { color: var(--ok-blue); cursor: pointer; font-size: 12.5px; }
  .edit-link:hover { text-decoration: underline; }
  .delete-link { color: var(--ok-red); cursor: pointer; font-size: 12.5px; margin-left: 10px; }

  .admin-sidebar-section {
    padding: 8px 18px 4px;
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--ok-muted);
    font-weight: 600;
    background: var(--ok-light);
    border-bottom: 1px solid var(--ok-border);
  }
  .role-badge {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    font-size: 11.5px;
    padding: 3px 10px;
    border-radius: 20px;
    font-weight: 500;
  }
  .role-master { background: #1a1d2e; color: #fff; }
  .role-okf    { background: #e0e8f7; color: var(--ok-blue); }
  .role-hr     { background: #e0f4ec; color: var(--ok-green); }
  code {
    background: #eef0f5;
    padding: 1px 5px;
    border-radius: 4px;
    font-size: 11px;
    font-family: monospace;
  }
  .modal-overlay {
    display: none;
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.45);
    z-index: 1000;
    align-items: center; justify-content: center;
  }
  .modal-overlay.show { display: flex; }
  .modal {
    background: white;
    border-radius: 14px;
    padding: 36px 36px 28px;
    width: 360px;
    box-shadow: 0 20px 60px rgba(0,0,0,.2);
  }
  .modal h3 {
    font-family: 'Source Serif 4', serif;
    font-size: 22px;
    font-weight: 400;
    color: var(--ok-blue);
    margin-bottom: 6px;
  }
  .modal p { font-size: 13px; color: var(--ok-muted); margin-bottom: 22px; }
  .modal input {
    width: 100%;
    border: 1px solid var(--ok-border);
    border-radius: 6px;
    padding: 11px 14px;
    font-size: 14px;
    font-family: 'DM Sans', sans-serif;
    outline: none;
    margin-bottom: 12px;
    transition: border-color .15s;
  }
  .modal input:focus { border-color: var(--ok-blue); }
  .modal-err { font-size: 13px; color: var(--ok-red); margin-bottom: 10px; }
  .modal-actions { display: flex; gap: 10px; margin-top: 6px; }
  .modal-close { background: none; border: none; font-size: 20px; position: absolute; top: 12px; right: 16px; cursor: pointer; color: var(--ok-muted); }

  .inline-role-select {
    font-family: 'DM Sans', sans-serif;
    font-size: 12.5px;
    padding: 4px 8px;
    border: 1px solid var(--ok-border);
    border-radius: 5px;
    background: white;
    color: var(--ok-text);
    cursor: pointer;
    outline: none;
  }
  .inline-role-select:focus { border-color: var(--ok-blue); }

  /* ‚îÄ‚îÄ FEATURED ARTICLE SEARCH ‚îÄ‚îÄ */
  #feat-search-results > div:hover { background: var(--ok-accent); }
  #feat-search-results > div { transition: background .1s; }

  mark { background: #fff3c0; border-radius: 2px; padding: 0 2px; }

  /* ‚îÄ‚îÄ MASTER INLINE EDIT HINT ‚îÄ‚îÄ */
  #master-edit-hint {
    display: none;
    background: linear-gradient(90deg, #003087, #1a4fbd);
    color: white;
    font-size: 12px;
    padding: 7px 20px;
    text-align: center;
    letter-spacing: .2px;
  }
  #master-edit-hint a { color: rgba(255,255,255,.85); cursor: pointer; text-decoration: underline; }
  .block-panel {
    background: #f0f3fa;
    border-bottom: 1px solid var(--ok-border);
    padding: 10px 12px;
    display: flex;
    flex-direction: column;
    gap: 5px;
    max-height: 280px;
    overflow-y: auto;
  }
  .block-panel-header {
    font-size: 11.5px;
    font-weight: 600;
    color: var(--ok-muted);
    text-transform: uppercase;
    letter-spacing: .5px;
    margin-bottom: 4px;
    padding-bottom: 6px;
    border-bottom: 1px solid var(--ok-border);
  }
  .block-row {
    display: flex;
    align-items: center;
    gap: 6px;
    background: white;
    border: 1px solid var(--ok-border);
    border-radius: 6px;
    padding: 6px 10px;
    font-size: 12.5px;
    transition: border-color .1s, box-shadow .1s;
  }
  .block-row:hover { border-color: var(--ok-blue); box-shadow: 0 1px 6px rgba(0,48,135,.08); }
  .block-row.block-active { border-color: var(--ok-blue); background: #eef2fb; }
  .block-type-tag {
    font-size: 10.5px;
    padding: 2px 6px;
    border-radius: 4px;
    background: var(--ok-accent);
    color: var(--ok-blue);
    font-weight: 500;
    white-space: nowrap;
    flex-shrink: 0;
  }
  .block-preview {
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    color: var(--ok-text);
    font-size: 12.5px;
  }
  .block-btns {
    display: flex;
    gap: 3px;
    flex-shrink: 0;
  }
  .block-move-btn {
    background: white;
    border: 1px solid var(--ok-border);
    border-radius: 4px;
    width: 26px;
    height: 26px;
    cursor: pointer;
    font-size: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all .1s;
  }
  .block-move-btn:hover:not(:disabled) { background: var(--ok-blue); color: white; border-color: var(--ok-blue); }
  .block-move-btn:disabled { opacity: .3; cursor: default; }

  /* ‚îÄ‚îÄ RICH TEXT TOOLBAR ‚îÄ‚îÄ */
  .rte-wrap { border: 1px solid var(--ok-border); border-radius: 6px; overflow: hidden; }
  .rte-toolbar {
    display: flex; flex-wrap: wrap; gap: 2px;
    padding: 6px 8px; background: var(--ok-light);
    border-bottom: 1px solid var(--ok-border);
  }
  .rte-btn {
    background: white; border: 1px solid var(--ok-border);
    border-radius: 4px; padding: 4px 9px; font-size: 13px;
    cursor: pointer; line-height: 1; transition: all .1s;
    font-family: 'DM Sans', sans-serif; color: var(--ok-text);
  }
  .rte-btn:hover { background: var(--ok-accent); border-color: var(--ok-blue); }
  .rte-sep { width: 1px; background: var(--ok-border); margin: 2px 4px; align-self: stretch; display: inline-block; }
  .rte-editor {
    min-height: 220px; padding: 14px 16px; outline: none;
    font-size: 14px; line-height: 1.7; font-family: 'DM Sans', sans-serif; background: white;
  }
  .rte-editor h3 { font-size: 16px; margin: 12px 0 6px; color: var(--ok-blue); }
  .rte-editor ul, .rte-editor ol { margin: 6px 0 6px 20px; }
  .rte-editor blockquote { border-left: 3px solid var(--ok-blue); margin: 8px 0; padding: 6px 14px; background: var(--ok-accent); border-radius: 0 4px 4px 0; }

  /* ‚îÄ‚îÄ CATEGORY MANAGER ‚îÄ‚îÄ */
  .cat-list { margin-bottom: 20px; }
  .cat-item {
    display: flex; align-items: center; gap: 10px;
    background: white; border: 1px solid var(--ok-border);
    border-radius: 8px; padding: 10px 14px; margin-bottom: 8px;
    cursor: grab; transition: box-shadow .15s; user-select: none;
  }
  .cat-item.dragging { opacity: .4; }
  .cat-item.drag-over { border-color: var(--ok-blue); background: var(--ok-accent); }
  .cat-drag-handle { color: var(--ok-muted); font-size: 16px; cursor: grab; flex-shrink: 0; }
  .cat-icon-preview { width: 32px; height: 32px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 16px; flex-shrink: 0; }
  .cat-item-info { flex: 1; min-width: 0; }
  .cat-item-info strong { font-size: 13.5px; display: block; }
  .cat-item-info span { font-size: 12px; color: var(--ok-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; }
  .cat-item-actions { display: flex; gap: 6px; flex-shrink: 0; }
  .cat-action-btn { background: none; border: 1px solid var(--ok-border); border-radius: 5px; padding: 4px 9px; font-size: 12px; cursor: pointer; font-family: 'DM Sans', sans-serif; transition: all .1s; }
  .cat-action-btn:hover { background: var(--ok-accent); border-color: var(--ok-blue); }
  .cat-action-btn.danger:hover { background: #fde8ec; border-color: var(--ok-red); color: var(--ok-red); }
  .icon-picker { display: flex; flex-wrap: wrap; gap: 6px; max-height: 120px; overflow-y: auto; padding: 8px; background: var(--ok-light); border-radius: 6px; margin-top: 6px; }
  .icon-opt { width: 34px; height: 34px; border: 1px solid var(--ok-border); border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 18px; cursor: pointer; background: white; transition: all .1s; }
  .icon-opt:hover { border-color: var(--ok-blue); background: var(--ok-accent); }
  .icon-opt.selected { border-color: var(--ok-blue); background: var(--ok-accent); }
  .color-picker-row { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 6px; }
  .color-opt { width: 28px; height: 28px; border-radius: 6px; cursor: pointer; border: 2px solid transparent; transition: border .1s; }
  .color-opt.selected { border-color: var(--ok-blue); transform: scale(1.15); }

  /* ‚îÄ‚îÄ INLINE EDIT MODAL ‚îÄ‚îÄ */
  .inline-modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,.45); z-index: 1100; align-items: center; justify-content: center; }
  .inline-modal-overlay.show { display: flex; }
  .inline-modal { background: white; border-radius: 12px; padding: 28px 30px; width: min(540px, 95vw); box-shadow: 0 20px 60px rgba(0,0,0,.2); position: relative; max-height: 90vh; overflow-y: auto; }
  .inline-modal h3 { font-family: 'Source Serif 4', serif; font-size: 18px; color: var(--ok-blue); margin-bottom: 16px; }
  .inline-modal-close { position: absolute; top: 12px; right: 16px; background: none; border: none; font-size: 20px; cursor: pointer; color: var(--ok-muted); }

  /* ‚îÄ‚îÄ FOOTER ‚îÄ‚îÄ */
  footer {
    background: var(--ok-blue);
    color: rgba(255,255,255,.7);
    text-align: center;
    padding: 20px;
    font-size: 12.5px;
    margin-top: auto;
  }
  footer a { color: rgba(255,255,255,.85); text-decoration: none; }

  /* ‚îÄ‚îÄ PAGE PADDING ‚îÄ‚îÄ */
  .page-content { padding-top: 40px; }

  /* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
  .toast {
    position: fixed; bottom: 28px; right: 28px;
    background: var(--ok-green);
    color: white;
    padding: 12px 22px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    box-shadow: 0 4px 20px rgba(0,0,0,.2);
    transform: translateY(60px); opacity: 0;
    transition: all .3s;
    z-index: 2000;
  }
  .toast.show { transform: translateY(0); opacity: 1; }

  @media (max-width: 900px) {
    .home-layout { grid-template-columns: 1fr; }
    .announcements-panel { position: static; }
  }
  @media (max-width: 680px) {
    .admin-grid { grid-template-columns: 1fr; }
    .header-inner { flex-wrap: wrap; gap: 10px; }
    .hero h2 { font-size: 24px; }
    .calc-grid { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>

<!-- TOP BAR -->
<div class="topbar">
  <span>Oslo kommune ‚Äì Internt HR-verkt√∏y</span>
  <span id="topbar-status">üìã Ferieportalen v1.0 ¬∑ Basert p√• Dok 25 (2024‚Äì2026) og ferieloven</span>
</div>
<!-- MASTER INLINE EDIT HINT -->
<div id="master-edit-hint">‚úèÔ∏è Master-modus: Klikk p√• tekst med stiplet ramme for √• redigere direkte. <a onclick="adminTab('site', document.getElementById('tab-btn-site')); showPage('admin');">√Öpne nettstedinnstillinger ‚Üí</a></div>

<!-- HEADER -->
<header>
  <div class="header-inner">
    <div class="logo-area">
      <div class="logo-shield">
        <svg viewBox="0 0 60 60" width="44" height="44" xmlns="http://www.w3.org/2000/svg" aria-label="Oslo Kommune">
          <!-- Blue shield background -->
          <path d="M30 2 L54 12 L54 34 C54 46 42 56 30 58 C18 56 6 46 6 34 L6 12 Z" fill="#003087"/>
          <!-- White horizontal bars (Oslo's coat of arms simplified) -->
          <rect x="14" y="20" width="32" height="5" rx="1" fill="white"/>
          <rect x="14" y="29" width="32" height="5" rx="1" fill="white"/>
          <rect x="14" y="38" width="32" height="5" rx="1" fill="white"/>
        </svg>
      </div>
      <div class="logo-text">
        <h1>Ferieportalen</h1>
        <span>Oslo Kommune ¬∑ HR & L√∏nn</span>
      </div>
    </div>
    <nav>
      <button onclick="showPage('home')">Hjem</button>
      <button onclick="showPage('home'); document.getElementById('search-input').focus()">S√∏k</button>
      <button id="admin-nav-btn" class="admin-btn" onclick="openLoginModal()">Logg inn</button>
      <button id="header-profile-btn" class="btn-secondary" style="display:none;font-size:12px;padding:6px 14px" onclick="openProfileModal()">üë§ Min profil</button>
      <button id="admin-panel-btn" class="admin-btn" style="display:none" onclick="showPage('admin'); adminTab('list', document.getElementById('tab-btn-list'))">‚öôÔ∏è Panel</button>
      <button id="header-logout-btn" class="logout-btn" style="display:none" onclick="logout()">Logg ut</button>
    </nav>
  </div>
</header>

<!-- HOME PAGE -->
<div id="page-home" class="page active page-content">
  <div class="hero">
    <h2>Finn svar om ferie i Oslo kommune</h2>
    <p>S√∏k i reglement, Dok 25, ferieloven og interne retningslinjer for HR, ledere og l√∏nnstjenesten.</p>
    <div class="search-box">
      <input id="search-input" type="text" placeholder="S√∏k f.eks. ¬´feriepenger¬ª, ¬´ekstraferie 60 √•r¬ª, ¬´sykdom under ferie¬ª ‚Ä¶" onkeydown="if(event.key==='Enter')doSearch()">
      <button onclick="doSearch()">S√∏k</button>
    </div>
    <div class="quick-tags">
      <button onclick="quickSearch('Feriedager antall')">Antall feriedager</button>
      <button onclick="quickSearch('Feriepenger')">Feriepenger</button>
      <button onclick="quickSearch('Sykdom under ferie')">Sykdom under ferie</button>
      <button onclick="quickSearch('Ekstraferie over 60')">Ekstraferie 60+</button>
      <button onclick="quickSearch('Overf√∏ring ferie')">Overf√∏ring av ferie</button>
      <button onclick="quickSearch('Fastsettelse ferie')">Fastsettelse av ferie</button>
      <button onclick="quickSearch('Ny ansatt ferie')">Ny ansatt</button>
      <button onclick="quickSearch('Feriepenger utbetaling')">Utbetaling juni</button>
    </div>
  </div>

  <div class="home-layout">
    <!-- LEFT: categories -->
    <div>
      <div class="categories">
        <p class="section-title">Fremhevede artikler</p>
        <div class="card-grid" id="card-grid">
          <!-- rendered by JS from categories[] -->
        </div>
      </div>
    </div>

    <!-- RIGHT: announcements + recent articles -->
    <div>
      <div class="announcements-panel">
        <div class="ann-header">
          üì¢ Viktige beskjeder
          <span id="ann-count-label"></span>
        </div>
        <div class="ann-list" id="ann-list">
          <!-- filled by JS -->
        </div>
        <button class="ann-admin-btn" id="ann-admin-btn" style="display:none" onclick="adminTab('announcements', document.getElementById('admin-ann-tab')); showPage('admin');">+ Legg til beskjed</button>
      </div>

      <!-- Recent articles -->
      <div class="announcements-panel" style="margin-top:16px">
        <div class="ann-header" style="background:#1a7a4a">
          üìÑ Sist publiserte artikler
        </div>
        <div id="recent-articles-list"></div>
      </div>
    </div>
  </div>
</div>

<!-- SEARCH RESULTS PAGE -->
<div id="page-results" class="page page-content">
  <div class="results-wrap">
    <div style="max-width:700px;margin:0 auto 30px;">
      <div class="search-box">
        <input id="search-input2" type="text" placeholder="S√∏k p√• nytt ‚Ä¶" onkeydown="if(event.key==='Enter')doSearch2()">
        <button onclick="doSearch2()">S√∏k</button>
      </div>
    </div>
    <div class="results-header">
      <h3 id="results-heading">S√∏keresultater</h3>
      <span id="results-count"></span>
    </div>
    <div id="results-list"></div>
  </div>
</div>

<!-- ARTICLE PAGE -->
<div id="page-article" class="page page-content">
  <div class="article-wrap">
    <div class="breadcrumb">
      <a onclick="showPage('home')">Hjem</a> ‚Ä∫ <span id="article-breadcrumb">Artikkel</span>
    </div>
    <div id="article-content"></div>
  </div>
</div>

<!-- ADMIN PAGE -->
<div id="page-admin" class="page page-content">
  <div class="admin-wrap">
    <div class="admin-header">
      <div>
        <h2>‚öôÔ∏è Administrasjonspanel</h2>
        <div id="admin-role-badge" style="margin-top:4px;font-size:12.5px;color:var(--ok-muted)"></div>
      </div>
      <div style="display:flex;gap:10px;align-items:center">
        <span id="admin-user-label" style="font-size:13px;color:var(--ok-muted)"></span>
        <button class="btn-secondary" style="font-size:12px;padding:6px 14px" onclick="openProfileModal()">üë§ Min profil</button>
        <button class="btn-secondary" style="font-size:12px;padding:6px 14px" onclick="logout()">Logg ut</button>
      </div>
    </div>
    <div class="admin-grid">
      <div class="admin-sidebar">
        <div class="admin-sidebar-section">Innhold</div>
        <div class="admin-sidebar-item active" id="tab-btn-list" onclick="adminTab('list',this)">üìÑ Alle artikler</div>
        <div class="admin-sidebar-item" id="tab-btn-new" onclick="adminTab('new',this)">‚ûï Ny artikkel</div>
        <div class="admin-sidebar-item" id="tab-btn-edit" onclick="adminTab('edit',this)" id="admin-edit-tab" style="display:none">‚úèÔ∏è Rediger artikkel</div>
        <div class="admin-sidebar-item" id="tab-btn-categories" onclick="adminTab('categories',this)">‚≠ê Fremhevede artikler</div>
        <div class="admin-sidebar-section">Kommunikasjon</div>
        <div class="admin-sidebar-item" id="tab-btn-announcements" onclick="adminTab('announcements',this)">üì¢ Beskjeder</div>
        <div class="admin-sidebar-section" id="master-section" style="display:none">Master</div>
        <div class="admin-sidebar-item" id="tab-btn-site" onclick="adminTab('site',this)" style="display:none">üé® Nettstedinnstillinger</div>
        <div class="admin-sidebar-item" id="tab-btn-users" onclick="adminTab('users',this)" style="display:none">üë• Brukere</div>
      </div>
      <div class="admin-main">
        <!-- LIST -->
        <div id="admin-list">
          <h3 style="font-size:16px;margin-bottom:16px;">Eksisterende artikler</h3>
          <table class="articles-table">
            <thead><tr><th>Tittel</th><th>Kategori</th><th>Sist endret</th><th></th></tr></thead>
            <tbody id="articles-tbody"></tbody>
          </table>
        </div>
        <!-- NEW ARTICLE -->
        <div id="admin-new" style="display:none">
          <h3 style="font-size:16px;margin-bottom:18px;">Ny artikkel</h3>
          <div class="form-group">
            <label>Tittel</label>
            <input id="new-title" type="text" placeholder="F.eks. Feriedager for deltidsansatte">
          </div>
          <div class="form-group">
            <label>Kategori / emneord (kommaseparert)</label>
            <input id="new-tags" type="text" placeholder="ferie, deltid, feriedager">
          </div>
          <div class="form-group">
            <label>Innhold</label>
            <div class="rte-wrap">
              <div class="rte-toolbar" id="rte-new-toolbar">
                <button class="rte-btn" onclick="rteCmd('new','bold')" title="Fet"><b>B</b></button>
                <button class="rte-btn" onclick="rteCmd('new','italic')" title="Kursiv"><i>I</i></button>
                <button class="rte-btn" onclick="rteCmd('new','underline')" title="Understrek"><u>U</u></button>
                <span class="rte-sep"></span>
                <button class="rte-btn" onclick="rteHeading('new')" title="Overskrift">H3</button>
                <button class="rte-btn" onclick="rteCmd('new','insertUnorderedList')" title="Liste">‚Ä¢ Liste</button>
                <button class="rte-btn" onclick="rteCmd('new','insertOrderedList')" title="Nummerert">1. Liste</button>
                <span class="rte-sep"></span>
                <button class="rte-btn" onclick="rteInsertBox('new','info')" title="Inforamme">‚ÑπÔ∏è Info</button>
                <button class="rte-btn" onclick="rteInsertBox('new','warn')" title="Advarsel">‚ö†Ô∏è Advarsel</button>
                <span class="rte-sep"></span>
                <button class="rte-btn" onclick="rteCmd('new','removeFormat')" title="Fjern formatering">‚úï Format</button>
                <span class="rte-sep"></span>
                <button class="rte-btn" id="block-panel-btn-new" onclick="toggleBlockPanel('new')" title="Omorganiser avsnitt">‚áÖ Organiser avsnitt</button>
              </div>
              <div class="block-panel" id="block-panel-new" style="display:none"></div>
              <div class="rte-editor" id="rte-new" contenteditable="true" spellcheck="true"></div>
            </div>
          </div>
          <div class="form-group">
            <label>Kilder / referanser</label>
            <input id="new-sources" type="text" placeholder="Dok 25 ¬ß 3.1, Ferieloven ¬ß 5">
          </div>
          <button class="btn-primary" onclick="saveNewArticle()">Lagre artikkel</button>
          <button class="btn-secondary" onclick="adminTab('list', document.getElementById('tab-btn-list'))">Avbryt</button>
        </div>
        <!-- ANNOUNCEMENTS ADMIN -->
        <div id="admin-announcements" style="display:none">
          <h3 style="font-size:16px;margin-bottom:18px;">Viktige beskjeder</h3>
          <div id="ann-admin-list" style="margin-bottom:20px;"></div>
          <hr style="border:none;border-top:1px solid var(--ok-border);margin-bottom:20px">
          <h4 style="font-size:14px;margin-bottom:14px;font-weight:500;">Ny beskjed</h4>
          <div class="form-group">
            <label>Tittel</label>
            <input id="ann-new-title" type="text" placeholder="F.eks. Frist for ferie√∏nsker 2025">
          </div>
          <div class="form-group">
            <label>Innhold</label>
            <textarea id="ann-new-body" style="min-height:90px" placeholder="Skriv beskjeden her‚Ä¶"></textarea>
          </div>
          <div class="form-group">
            <label>Type</label>
            <select id="ann-new-type">
              <option value="info">‚ÑπÔ∏è Info (bl√•)</option>
              <option value="viktig">üî¥ Viktig (r√∏d)</option>
              <option value="ok">‚úÖ Bekreftet (gr√∏nn)</option>
              <option value="advarsel">‚ö†Ô∏è Advarsel (gul)</option>
            </select>
          </div>
          <div class="form-group">
            <label>Signert av (avdeling)</label>
            <input id="ann-new-author" type="text" placeholder="F.eks. HR-avdelingen">
          </div>
          <button class="btn-primary" onclick="saveAnnouncement()">Publiser beskjed</button>
        </div>
        <!-- EDIT ARTICLE -->
        <div id="admin-edit" style="display:none">
          <h3 style="font-size:16px;margin-bottom:18px;">Rediger artikkel</h3>
          <input type="hidden" id="edit-id">
          <div class="form-group">
            <label>Tittel</label>
            <input id="edit-title" type="text">
          </div>
          <div class="form-group">
            <label>Kategori / emneord</label>
            <input id="edit-tags" type="text">
          </div>
          <div class="form-group">
            <label>Innhold</label>
            <div class="rte-wrap">
              <div class="rte-toolbar">
                <button class="rte-btn" onclick="rteCmd('edit','bold')" title="Fet"><b>B</b></button>
                <button class="rte-btn" onclick="rteCmd('edit','italic')" title="Kursiv"><i>I</i></button>
                <button class="rte-btn" onclick="rteCmd('edit','underline')" title="Understrek"><u>U</u></button>
                <span class="rte-sep"></span>
                <button class="rte-btn" onclick="rteHeading('edit')" title="Overskrift">H3</button>
                <button class="rte-btn" onclick="rteCmd('edit','insertUnorderedList')" title="Liste">‚Ä¢ Liste</button>
                <button class="rte-btn" onclick="rteCmd('edit','insertOrderedList')" title="Nummerert">1. Liste</button>
                <span class="rte-sep"></span>
                <button class="rte-btn" onclick="rteInsertBox('edit','info')" title="Inforamme">‚ÑπÔ∏è Info</button>
                <button class="rte-btn" onclick="rteInsertBox('edit','warn')" title="Advarsel">‚ö†Ô∏è Advarsel</button>
                <span class="rte-sep"></span>
                <button class="rte-btn" onclick="rteCmd('edit','removeFormat')" title="Fjern formatering">‚úï Format</button>
                <span class="rte-sep"></span>
                <button class="rte-btn" id="block-panel-btn-edit" onclick="toggleBlockPanel('edit')" title="Omorganiser avsnitt">‚áÖ Organiser avsnitt</button>
              </div>
              <div class="block-panel" id="block-panel-edit" style="display:none"></div>
              <div class="rte-editor" id="rte-edit" contenteditable="true" spellcheck="true"></div>
            </div>
          </div>
          <div class="form-group">
            <label>Kilder / referanser</label>
            <input id="edit-sources" type="text">
          </div>
          <button class="btn-primary" onclick="saveEditArticle()">Lagre endringer</button>
          <button class="btn-danger" onclick="deleteArticle()">Slett artikkel</button>
          <button class="btn-secondary" onclick="adminTab('list', document.getElementById('tab-btn-list'))" style="margin-left:8px">Avbryt</button>
        </div>
        <!-- SITE SETTINGS (master only) -->
        <div id="admin-site" style="display:none">
          <h3 style="font-size:16px;margin-bottom:6px;">üé® Nettstedinnstillinger</h3>
          <p style="font-size:13px;color:var(--ok-muted);margin-bottom:22px">Rediger alle tekster, farger og seksjoner. Endringer er synlige umiddelbart etter lagring.</p>

          <!-- Colors -->
          <div style="background:var(--ok-accent);border-radius:8px;padding:16px 18px;margin-bottom:22px">
            <p style="font-size:12.5px;font-weight:600;color:var(--ok-blue);margin-bottom:12px">üé® Farger</p>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
              <div class="form-group" style="margin-bottom:0">
                <label>Prim√¶rfarge (bl√•)</label>
                <div style="display:flex;gap:8px;align-items:center">
                  <input id="site-color-blue" type="color" style="width:44px;height:34px;border:1px solid var(--ok-border);border-radius:5px;padding:2px;cursor:pointer">
                  <input id="site-color-blue-hex" type="text" style="flex:1" placeholder="#003087" oninput="syncColor('blue')">
                </div>
              </div>
              <div class="form-group" style="margin-bottom:0">
                <label>Sekund√¶rfarge (r√∏d)</label>
                <div style="display:flex;gap:8px;align-items:center">
                  <input id="site-color-red" type="color" style="width:44px;height:34px;border:1px solid var(--ok-border);border-radius:5px;padding:2px;cursor:pointer">
                  <input id="site-color-red-hex" type="text" style="flex:1" placeholder="#C8102E" oninput="syncColor('red')">
                </div>
              </div>
              <div class="form-group" style="margin-bottom:0">
                <label>Gr√∏nn (bekreftet/artikler)</label>
                <div style="display:flex;gap:8px;align-items:center">
                  <input id="site-color-green" type="color" style="width:44px;height:34px;border:1px solid var(--ok-border);border-radius:5px;padding:2px;cursor:pointer">
                  <input id="site-color-green-hex" type="text" style="flex:1" placeholder="#1a7a4a" oninput="syncColor('green')">
                </div>
              </div>
              <div class="form-group" style="margin-bottom:0">
                <label>Aksentfarge (bakgrunner)</label>
                <div style="display:flex;gap:8px;align-items:center">
                  <input id="site-color-accent" type="color" style="width:44px;height:34px;border:1px solid var(--ok-border);border-radius:5px;padding:2px;cursor:pointer">
                  <input id="site-color-accent-hex" type="text" style="flex:1" placeholder="#e8ecf7" oninput="syncColor('accent')">
                </div>
              </div>
            </div>
          </div>

          <!-- Topbar -->
          <div style="background:var(--ok-accent);border-radius:8px;padding:16px 18px;margin-bottom:22px">
            <p style="font-size:12.5px;font-weight:600;color:var(--ok-blue);margin-bottom:2px">üîµ Topptekst (bl√• linje √∏verst)</p>
            <div class="form-group" style="margin-top:10px;margin-bottom:0">
              <label>Venstre tekst</label>
              <input id="site-topbar-left" type="text">
            </div>
            <div class="form-group" style="margin-bottom:0;margin-top:10px">
              <label>H√∏yre tekst</label>
              <input id="site-topbar-right" type="text">
            </div>
          </div>

          <!-- Header/Logo -->
          <div style="background:var(--ok-accent);border-radius:8px;padding:16px 18px;margin-bottom:22px">
            <p style="font-size:12.5px;font-weight:600;color:var(--ok-blue);margin-bottom:2px">üèõ Header / Logo</p>
            <div class="form-group" style="margin-top:10px;margin-bottom:0">
              <label>Portalnavn (stor tittel)</label>
              <input id="site-portal-name" type="text">
            </div>
            <div class="form-group" style="margin-top:10px;margin-bottom:0">
              <label>Undertittel (liten tekst under navn)</label>
              <input id="site-portal-sub" type="text">
            </div>
          </div>

          <!-- Hero section -->
          <div style="background:var(--ok-accent);border-radius:8px;padding:16px 18px;margin-bottom:22px">
            <p style="font-size:12.5px;font-weight:600;color:var(--ok-blue);margin-bottom:2px">üîç Forsiden ‚Äì s√∏k</p>
            <div class="form-group" style="margin-top:10px;margin-bottom:0">
              <label>S√∏keboks-tittel</label>
              <input id="site-hero-title" type="text">
            </div>
            <div class="form-group" style="margin-top:10px;margin-bottom:0">
              <label>S√∏keboks-undertekst</label>
              <input id="site-hero-sub" type="text">
            </div>
            <div class="form-group" style="margin-top:10px;margin-bottom:0">
              <label>Hurtigs√∏k-knapper <span style="font-size:11.5px;color:var(--ok-muted);font-weight:400">(√©n per linje, format: Visningsnavn|S√∏keord)</span></label>
              <textarea id="site-quick-tags" style="min-height:130px;font-family:monospace;font-size:12px" placeholder="Antall feriedager|Feriedager antall&#10;Feriepenger|Feriepenger"></textarea>
            </div>
          </div>

          <!-- Home sections -->
          <div style="background:var(--ok-accent);border-radius:8px;padding:16px 18px;margin-bottom:22px">
            <p style="font-size:12.5px;font-weight:600;color:var(--ok-blue);margin-bottom:2px">üè† Forsidebokser</p>
            <div class="form-group" style="margin-top:10px;margin-bottom:0">
              <label>Tittel over fremhevede artikler</label>
              <input id="site-featured-title" type="text">
            </div>
            <div class="form-group" style="margin-top:10px;margin-bottom:0">
              <label>Tittel: Viktige beskjeder</label>
              <input id="site-ann-header" type="text">
            </div>
            <div class="form-group" style="margin-top:10px;margin-bottom:0">
              <label>Tittel: Sist publiserte artikler</label>
              <input id="site-recent-header" type="text">
            </div>
          </div>

          <!-- Footer -->
          <div style="background:var(--ok-accent);border-radius:8px;padding:16px 18px;margin-bottom:22px">
            <p style="font-size:12.5px;font-weight:600;color:var(--ok-blue);margin-bottom:2px">üìÑ Bunntekst (footer)</p>
            <div class="form-group" style="margin-top:10px;margin-bottom:0">
              <label>Linje 1</label>
              <input id="site-footer1" type="text">
            </div>
            <div class="form-group" style="margin-top:10px;margin-bottom:0">
              <label>Linje 2</label>
              <input id="site-footer2" type="text">
            </div>
          </div>

          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <button class="btn-primary" onclick="saveSiteSettings()">üíæ Lagre alle endringer</button>
            <button class="btn-secondary" onclick="loadSiteSettingsToForm()">‚Ü© Tilbakestill skjema</button>
            <button class="btn-danger" onclick="resetStorage()" style="margin-left:auto">üóë Slett alle lagrede endringer</button>
          </div>
        </div>

        <!-- USER MANAGEMENT (master only) -->
        <div id="admin-users" style="display:none">
          <h3 style="font-size:16px;margin-bottom:6px;">üë• Brukere og roller</h3>
          <p style="font-size:13px;color:var(--ok-muted);margin-bottom:20px">Administrer innloggingsbrukere og tilgangsniv√•.</p>
          <table class="articles-table" id="users-table">
            <thead><tr><th>Brukernavn</th><th>Tilganger</th><th>Handlinger</th></tr></thead>
            <tbody id="users-tbody"></tbody>
          </table>
          <hr style="border:none;border-top:1px solid var(--ok-border);margin:20px 0">
          <h4 style="font-size:14px;margin-bottom:14px;font-weight:500;">Legg til / endre bruker</h4>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:14px">
            <div class="form-group" style="margin-bottom:0">
              <label>Brukernavn</label>
              <input id="user-new-name" type="text" placeholder="F.eks. lise.hansen">
            </div>
            <div class="form-group" style="margin-bottom:0">
              <label>Passord</label>
              <input id="user-new-pass" type="text" placeholder="Midlertidig passord">
            </div>
          </div>
          <div class="form-group" style="margin-bottom:0">
            <label style="margin-bottom:10px;display:block">Tilganger <span style="font-size:11.5px;color:var(--ok-muted);font-weight:400">(ingenting valgt = kun portalbruk)</span></label>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
              <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer;background:var(--ok-light);padding:8px 12px;border-radius:6px;border:1px solid var(--ok-border)">
                <input type="checkbox" id="cap-articles" style="width:15px;height:15px"> üìÑ Artikler
              </label>
              <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer;background:var(--ok-light);padding:8px 12px;border-radius:6px;border:1px solid var(--ok-border)">
                <input type="checkbox" id="cap-announcements" style="width:15px;height:15px"> üì¢ Beskjeder
              </label>
              <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer;background:var(--ok-light);padding:8px 12px;border-radius:6px;border:1px solid var(--ok-border)">
                <input type="checkbox" id="cap-categories" style="width:15px;height:15px"> ‚≠ê Fremhevede artikler
              </label>
              <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer;background:var(--ok-light);padding:8px 12px;border-radius:6px;border:1px solid var(--ok-border)">
                <input type="checkbox" id="cap-site" style="width:15px;height:15px"> üé® Nettstedinnstillinger
              </label>
              <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer;background:var(--ok-light);padding:8px 12px;border-radius:6px;border:1px solid var(--ok-border)">
                <input type="checkbox" id="cap-users" style="width:15px;height:15px"> üë• Brukeradministrasjon
              </label>
            </div>
          </div>
          <button class="btn-primary" style="margin-top:16px" onclick="saveUser()">Lagre bruker</button>
        </div>

        <!-- CATEGORIES MANAGER -->
        <div id="admin-categories" style="display:none">
          <h3 style="font-size:16px;margin-bottom:6px;">‚≠ê Fremhevede artikler</h3>
          <p style="font-size:13px;color:var(--ok-muted);margin-bottom:18px">Disse artiklene vises som kort p√• forsiden. Dra og slipp for √• endre rekkef√∏lge.</p>
          <div class="cat-list" id="cat-list"></div>
          <hr style="border:none;border-top:1px solid var(--ok-border);margin:20px 0">
          <h4 style="font-size:14px;font-weight:500;margin-bottom:14px">Fremhev en artikkel</h4>

          <!-- Article search -->
          <div class="form-group">
            <label>S√∏k etter artikkel</label>
            <div style="position:relative">
              <input id="feat-search" type="text" placeholder="Skriv for √• s√∏ke blant artikler‚Ä¶" oninput="featSearch()" autocomplete="off" style="padding-right:36px">
              <span style="position:absolute;right:12px;top:50%;transform:translateY(-50%);color:var(--ok-muted);pointer-events:none">üîç</span>
            </div>
            <div id="feat-search-results" style="display:none;border:1px solid var(--ok-border);border-top:none;border-radius:0 0 6px 6px;background:white;max-height:200px;overflow-y:auto;margin-top:-1px"></div>
            <div id="feat-selected-article" style="display:none;margin-top:10px;padding:10px 14px;background:var(--ok-accent);border-radius:6px;border:1px solid var(--ok-blue);display:none">
              <div style="font-size:12px;color:var(--ok-blue);font-weight:600;margin-bottom:2px">Valgt artikkel:</div>
              <div id="feat-selected-label" style="font-size:13.5px;font-weight:500"></div>
            </div>
            <input type="hidden" id="feat-selected-id">
          </div>

          <!-- Icon and color pickers -->
          <div class="form-group">
            <label>Ikon</label>
            <div class="icon-picker" id="cat-new-icon-picker"></div>
            <input id="cat-new-icon-val" type="hidden" value="üìÑ">
          </div>
          <div class="form-group">
            <label>Ikonfarge (bakgrunn)</label>
            <div class="color-picker-row" id="cat-new-color-picker"></div>
            <input id="cat-new-color-val" type="hidden" value="#e0e8f7">
          </div>

          <button class="btn-primary" onclick="addFeatured()">‚≠ê Fremhev artikkel</button>
        </div>

      </div>
    </div>
  </div>
</div>

<!-- ANNOUNCEMENT EDIT MODAL -->
<div class="inline-modal-overlay" id="ann-edit-modal">
  <div class="inline-modal">
    <button class="inline-modal-close" onclick="closeAnnEditModal()">√ó</button>
    <h3>Rediger beskjed</h3>
    <input type="hidden" id="ann-edit-id">
    <div class="form-group">
      <label>Tittel</label>
      <input id="ann-edit-title" type="text">
    </div>
    <div class="form-group">
      <label>Innhold</label>
      <textarea id="ann-edit-body" style="min-height:90px"></textarea>
    </div>
    <div class="form-group">
      <label>Type</label>
      <select id="ann-edit-type">
        <option value="info">‚ÑπÔ∏è Info (bl√•)</option>
        <option value="viktig">üî¥ Viktig (r√∏d)</option>
        <option value="ok">‚úÖ Bekreftet (gr√∏nn)</option>
        <option value="advarsel">‚ö†Ô∏è Advarsel (gul)</option>
      </select>
    </div>
    <div class="form-group">
      <label>Signert av (avdeling)</label>
      <input id="ann-edit-author" type="text">
    </div>
    <div style="display:flex;gap:10px;margin-top:4px">
      <button class="btn-primary" onclick="saveAnnEdit()">Lagre endringer</button>
      <button class="btn-secondary" onclick="closeAnnEditModal()">Avbryt</button>
    </div>
  </div>
</div>

<!-- FEATURED ARTICLE EDIT MODAL -->
<div class="inline-modal-overlay" id="cat-edit-modal">
  <div class="inline-modal">
    <button class="inline-modal-close" onclick="closeCatEditModal()">√ó</button>
    <h3>Rediger fremhevet artikkel</h3>
    <input type="hidden" id="cat-edit-id">
    <div style="margin-bottom:14px;padding:10px 14px;background:var(--ok-accent);border-radius:6px;border-left:3px solid var(--ok-blue)">
      <div style="font-size:11.5px;color:var(--ok-blue);font-weight:600;margin-bottom:2px">Koblet artikkel</div>
      <div id="cat-edit-article-label" style="font-size:13.5px;font-weight:500;color:var(--ok-text)"></div>
    </div>
    <div class="form-group">
      <label>Ikon</label>
      <div class="icon-picker" id="cat-edit-icon-picker"></div>
      <input id="cat-edit-icon-val" type="hidden">
    </div>
    <div class="form-group">
      <label>Ikonfarge (bakgrunn)</label>
      <div class="color-picker-row" id="cat-edit-color-picker"></div>
      <input id="cat-edit-color-val" type="hidden">
    </div>
    <div style="display:flex;gap:10px;margin-top:4px">
      <button class="btn-primary" onclick="saveCatEdit()">Lagre</button>
      <button class="btn-secondary" onclick="closeCatEditModal()">Avbryt</button>
    </div>
  </div>
</div>
<!-- USER EDIT MODAL -->
<div class="inline-modal-overlay" id="user-edit-modal">
  <div class="inline-modal" style="max-width:420px">
    <button class="inline-modal-close" onclick="closeUserEditModal()">√ó</button>
    <h3>Rediger bruker: <span id="uedit-username" style="color:var(--ok-blue)"></span></h3>
    <input type="hidden" id="uedit-name">
    <div class="form-group">
      <label>Nytt passord (la st√• tomt for √• beholde)</label>
      <input id="uedit-pass" type="text" placeholder="Nytt passord (valgfritt)">
    </div>
    <div class="form-group" style="margin-bottom:0">
      <label style="margin-bottom:10px;display:block">Tilganger</label>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer;background:var(--ok-light);padding:8px 12px;border-radius:6px;border:1px solid var(--ok-border)">
          <input type="checkbox" id="uedit-cap-articles" style="width:15px;height:15px"> üìÑ Artikler
        </label>
        <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer;background:var(--ok-light);padding:8px 12px;border-radius:6px;border:1px solid var(--ok-border)">
          <input type="checkbox" id="uedit-cap-announcements" style="width:15px;height:15px"> üì¢ Beskjeder
        </label>
        <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer;background:var(--ok-light);padding:8px 12px;border-radius:6px;border:1px solid var(--ok-border)">
          <input type="checkbox" id="uedit-cap-categories" style="width:15px;height:15px"> üóÇ Kategorier
        </label>
        <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer;background:var(--ok-light);padding:8px 12px;border-radius:6px;border:1px solid var(--ok-border)">
          <input type="checkbox" id="uedit-cap-site" style="width:15px;height:15px"> üé® Nettstedinnstillinger
        </label>
        <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer;background:var(--ok-light);padding:8px 12px;border-radius:6px;border:1px solid var(--ok-border)">
          <input type="checkbox" id="uedit-cap-users" style="width:15px;height:15px"> üë• Brukeradministrasjon
        </label>
      </div>
    </div>
    <div style="display:flex;gap:10px;margin-top:18px">
      <button class="btn-primary" onclick="saveUserEdit()">Lagre endringer</button>
      <button class="btn-secondary" onclick="closeUserEditModal()">Avbryt</button>
    </div>
  </div>
</div>

<!-- PROFILE MODAL -->
<div class="inline-modal-overlay" id="profile-modal">
  <div class="inline-modal" style="max-width:420px">
    <button class="inline-modal-close" onclick="closeProfileModal()">√ó</button>
    <h3>üë§ Min profil</h3>
    <div style="background:var(--ok-accent);border-radius:8px;padding:12px 16px;margin-bottom:18px">
      <p style="font-size:12px;color:var(--ok-muted);margin-bottom:2px">Innlogget som</p>
      <p id="profile-username-display" style="font-size:15px;font-weight:600;color:var(--ok-blue)"></p>
      <div id="profile-caps-display" style="margin-top:8px;display:flex;flex-wrap:wrap;gap:5px"></div>
    </div>
    <div class="form-group">
      <label>Nytt passord</label>
      <input id="profile-new-pass" type="password" placeholder="Skriv nytt passord" autocomplete="new-password">
    </div>
    <div class="form-group">
      <label>Bekreft nytt passord</label>
      <input id="profile-confirm-pass" type="password" placeholder="Gjenta nytt passord" autocomplete="new-password">
    </div>
    <div id="profile-msg" style="font-size:13px;padding:8px 12px;border-radius:6px;margin-bottom:10px;display:none"></div>
    <div style="display:flex;gap:10px">
      <button class="btn-primary" onclick="saveProfilePassword()">Lagre nytt passord</button>
      <button class="btn-secondary" onclick="closeProfileModal()">Avbryt</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="login-modal">
  <div class="modal" style="position:relative;width:420px">
    <button class="modal-close" onclick="closeModal()">√ó</button>
    <h3>Innlogging</h3>
    <p>Ferieportalen ‚Äì Oslo Kommune administrasjon</p>
    <input id="login-user" type="text" placeholder="Brukernavn" autocomplete="username">
    <input id="login-pass" type="password" placeholder="Passord" autocomplete="current-password" onkeydown="if(event.key==='Enter')doLogin()">
    <div class="modal-err" id="login-err" style="display:none">Feil brukernavn eller passord.</div>
    <div class="modal-actions">
      <button class="btn-primary" onclick="doLogin()">Logg inn</button>
      <button class="btn-secondary" onclick="closeModal()">Avbryt</button>
    </div>
    <div style="margin-top:16px;padding-top:14px;border-top:1px solid var(--ok-border);font-size:11.5px;color:var(--ok-muted);line-height:1.7">
      <strong style="color:var(--ok-text)">Demo-brukere:</strong><br>
      OKF L√∏nn: <code>okf</code> / <code>okf2024</code><br>
      HR: <code>hr</code> / <code>hr2024</code><br>
      Master: <code>master</code> / <code>master2024</code>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<!-- FOOTER -->
<div id="last-updated-bar" style="background:#1a1d2e;color:rgba(255,255,255,0.75);font-size:12px;padding:7px 24px;display:none;justify-content:space-between;align-items:center">
  <span id="last-updated-text">üïê Sist oppdatert: ‚Äì</span>
  <span id="last-updated-who" style="color:rgba(255,255,255,0.45)"></span>
</div>
<footer>
  <p id="footer-line1">Ferieportalen ¬∑ Oslo Kommune ¬∑ HR og L√∏nn ¬∑ Basert p√• Dok 25 (2024‚Äì2026), Ferieloven og Oslo kommunes Personalh√•ndbok 2025</p>
  <p style="margin-top:6px"><a href="https://www.oslo.kommune.no" target="_blank">oslo.kommune.no</a> ¬∑ <span id="footer-line2">Innhold er veiledende ‚Äì kontakt l√∏nnstjenesten ved tvil</span></p>
</footer>

<script>
// ============================================================
//  DATA ‚Äì artikler (utfyllende innhold basert p√• Dok 25 + ferieloven)
// ============================================================
let articles = [
  {
    id: 'feriedager',
    title: 'Antall feriedager i Oslo kommune',
    tags: ['feriedager', 'ferie', 'virkedager', 'dok 25', 'femte ferieuke', 'avtalefestet'],
    sources: 'Ferieloven ¬ß 5 nr. 1‚Äì3 ¬∑ Dok 25 kap. 3 ¬∑ Oslo kommunes Personalh√•ndbok 2025 kap. 6',
    modified: '09.04.2025',
    body: `
      <h3>Oversikt over ferierettigheter</h3>
      <p>Alle ansatte i Oslo kommune har rett til <strong>25 virkedagers ferie</strong> per ferie√•r etter ferieloven ¬ß 5 nr. 1. Merk at virkedager inkluderer l√∏rdager, slik at 25 virkedager tilsvarer 4 uker og 1 dag.</p>
      <div class="info-box">üìå <strong>I Oslo kommune er det avtalt en femte ferieuke</strong> gjennom tariffoppgj√∏ret fra 2000/2001 (jf. Dok 25 kap. 3). Dette gir totalt <strong>30 virkedager</strong> (5 uker) ferierett. Men: <strong>kun de dagene det er opptjent feriepenger for, avvikles med l√∏nn.</strong> Rett til ferie og rett til betalt ferie er to separate sp√∏rsm√•l.</div>
      <h3>Betalt ferie ‚Äì avhenger av fjor√•rets opptjening</h3>
      <p>Feriepenger opptjenes i <strong>opptjenings√•ret</strong> (foreg√•ende kalender√•r) og utbetales i ferie√•ret. Antall betalte feriedager bestemmes av opptjeningsgrunnlaget:</p>
      <ul>
        <li>Full opptjening (hele opptjenings√•ret i Oslo kommune): 25 betalte virkedager (+ 5 avtalefestede)</li>
        <li>Delvis opptjening (f.eks. tiltredelse i april fjor√•ret): proporsjonal andel betalte dager</li>
        <li>Ingen opptjening (ny ansatt i innev√¶rende ferie√•r, ingen fjor√•rsopptjening i Oslo kommune): 0 betalte feriedager ‚Äì arbeidstaker kan nekte √• avvikle denne ferien</li>
      </ul>
      <div class="warn-box">‚ö†Ô∏è En ansatt som starter i Oslo kommune i <strong>innev√¶rende ferie√•r</strong> har rett til √• avvikle ferie, men arbeidsgiver kan ikke p√•legge ferieavvikling uten l√∏nn for de dagene det ikke er opptjent feriepenger (jf. ferieloven ¬ß 5 nr. 5).</div>
      <h3>Ferieuke nummer 5 ‚Äì avtalefestet ferie</h3>
      <p>Den femte ferieuken (5 virkedager) er en avtalefestet ordning etter Dok 25 kap. 3. Arbeidsgiver fastsetter tidspunktet etter dr√∏ftinger med tillitsvalgte eller den enkelte arbeidstaker, og dette skjer samtidig med fastsettingen av ordin√¶r ferie.</p>
      <h3>Deltidsansatte</h3>
      <p>Deltidsansatte har rett til samme antall virkedager ferie som fulltidsansatte. Antall faktiske arbeidsdager i ferien reduseres proporsjonalt etter stillingsbr√∏k, men ferie avvikles etter virkedager slik ferieloven fastsetter.</p>
      <div class="warn-box">‚ö†Ô∏è <strong>Merk:</strong> Ferieloven ¬ß 10 (3) 2. ledd kommer ikke til anvendelse i Oslo kommune, jf. Dok 25 kap. 3.</div>

      <div class="calc-box">
        <h3>üßÆ Feriekalkulator for ledere</h3>
        <p style="font-size:13px;color:var(--ok-muted);margin-bottom:16px;margin-top:-8px">
          Beregner ferierett, betalte feriedager og teknisk l√∏nnstrekk i juni basert p√• junil√∏nn.
        </p>
        <div class="calc-grid">
          <div class="calc-field">
            <label>Alder i ferie√•ret (√•r)</label>
            <input id="kalk-alder" type="number" value="35" min="16" max="75" placeholder="35">
          </div>
          <div class="calc-field">
            <label>Brutto m√•nedsl√∏nn i juni (kr)</label>
            <input id="kalk-lonn" type="number" placeholder="F.eks. 52 000" min="0">
          </div>
          <div class="calc-field">
            <label>Faste tillegg i juni (kr, valgfritt)</label>
            <input id="kalk-tillegg" type="number" placeholder="F.eks. 3 000" min="0" value="0">
          </div>
          <div class="calc-field">
            <label>Feriepengeopptjening fjor√•r (kr)</label>
            <input id="kalk-fpopptj" type="number" placeholder="F.eks. 62 400" min="0" title="Totale opptjente feriepenger fra opptjenings√•ret (fjor√•ret) ‚Äì fra l√∏nnssystemet">
          </div>
        </div>
        <button class="calc-run-btn" onclick="runKalkulator()">Beregn</button>
        <div class="calc-result" id="kalk-result"></div>
      </div>
    `
  },
  {
    id: 'feriepenger',
    title: 'Feriepenger ‚Äì beregning og utbetaling',
    tags: ['feriepenger', 'beregning', 'prosent', 'juni', 'utbetaling', 'l√∏nnstrekk', '12 prosent', '14.3 prosent'],
    sources: 'Ferieloven ¬ß¬ß 10‚Äì11 ¬∑ Dok 25 ¬ß 3.1 ¬∑ Oslo kommunes Personalh√•ndbok 2025',
    modified: '09.04.2025',
    body: `
      <h3>Prosentsatser for feriepenger</h3>
      <p>Feriepenger beregnes av feriepengegrunnlaget (l√∏nn utbetalt i opptjenings√•ret) og utgj√∏r:</p>
      <ul>
        <li><strong>12,0 %</strong> for ansatte som er omfattet av avtalefestet ferie (de fleste ansatte i Oslo kommune)</li>
        <li><strong>14,3 %</strong> for ansatte som fyller <strong>60 √•r</strong> i l√∏pet av ferie√•ret</li>
      </ul>
      <div class="info-box">üìå Disse satsene er h√∏yere enn lovens minstesatser (10,2 % / 12,5 %) nettopp fordi Oslo kommune har avtalefestet den femte ferieuken.</div>
      <h3>Utbetaling i juni</h3>
      <p>I Oslo kommune er det praksis at feriepenger utbetales i <strong>juni m√•ned</strong> i ferie√•ret. Dette er avtalt mellom partene og inneb√¶rer at feriel√∏nntillegget (den del av feriepengene som overstiger l√∏nn for vanlig arbeidstid) utbetales samlet med l√∏nnen for juni.</p>
      <h3>Teknisk l√∏nnstrekk</h3>
      <p>N√•r ferie avvikles gjennomf√∏res et teknisk l√∏nnstrekk i juni tilsvarende antall feriedager dividert p√• 26 l√∏nnsuker. For ansatte i Oslo kommune med full ferierett (25 lovfestede + 5 avtalefestede = 30 virkedager) beregnes trekket slik:</p>
      <ul>
        <li>Ansatte med avtalefestet ferie (30 virkedager totalt): trekk = <strong>30/26 av m√•nedsl√∏nn</strong></li>
        <li>Ansatte med kun lovfestet ferie (25 virkedager): trekk = <strong>25/26 av m√•nedsl√∏nn</strong></li>
      </ul>
      <p>Trekket gjennomf√∏res i junil√∏nnen, samme m√•ned som feriepengene utbetales. Netto effekt er at ansatte mottar feriepengene (12 % av fjor√•rets l√∏nn) minus ferietrekket ‚Äì dette gir et positivt ferietillegg i juni for de fleste.</p>
      <h3>Opptjenings√•r ‚Äì det avgj√∏rende prinsippet</h3>
      <p>Feriepenger opptjenes utelukkende i <strong>opptjenings√•ret</strong> (foreg√•ende kalender√•r) og baseres kun p√• l√∏nn utbetalt fra Oslo kommune i dette √•ret. Opptjening starter den dagen ansettelsen tiltrer ‚Äì ikke fra ansettelsesdatoen dersom disse er ulike.</p>
      <ul>
        <li>Ny ansatt 1. mars fjor√•ret: opptjener feriepenger for 10 m√•neder (mars‚Äìdesember)</li>
        <li>Ny ansatt 1. januar i ferie√•ret: har <em>ingen</em> opptjening i Oslo kommune ‚Äì ferietrekket i juni dekkes ikke av opptjente feriepenger</li>
      </ul>
    `
  },
  {
    id: 'fastsettelse',
    title: 'Fastsettelse og planlegging av ferie',
    tags: ['fastsettelse', 'planlegging', 'varsling', 'sommerferie', 'dr√∏fting', 'tillitsvalgt', 'to m√•neder'],
    sources: 'Ferieloven ¬ß¬ß 6‚Äì7 ¬∑ Dok 25 kap. 3 ¬∑ Oslo kommunes Personalh√•ndbok 2025',
    modified: '09.04.2025',
    body: `
      <h3>Hvem bestemmer n√•r ferie tas?</h3>
      <p>Arbeidsgiver fastsetter tidspunktet for ferie etter dr√∏ftinger med de tillitsvalgte eller den enkelte arbeidstaker. Den ansatte kan ikke fritt velge ferietidspunkt uten arbeidsgivers godkjenning, men arbeidsgiver skal ta hensyn til den ansattes √∏nsker og virksomhetens behov.</p>
      <h3>Varslingsfrister</h3>
      <ul>
        <li><strong>Arbeidsgiver</strong> skal varsle om ferietidspunkt <strong>tidligst mulig</strong> og senest <strong>2 m√•neder</strong> f√∏r ferien starter.</li>
        <li><strong>Arbeidstaker</strong> kan kreve √• f√• vite tidspunktet for ferien senest 2 m√•neder i forveien dersom de har konkrete planer.</li>
      </ul>
      <div class="info-box">üìå Jf. ferieloven ¬ß 6 nr. 2 kan arbeidstaker kreve √• bli varslet om feriefastsettingen senest 2 m√•neder f√∏r ferien starter.</div>
      <h3>Rett til 3 uker sammenhengende sommerferie</h3>
      <p>Arbeidstaker har rett til √• avvikle <strong>18 virkedager (3 uker) sammenhengende</strong> i perioden 1. juni‚Äì30. september (ferieloven ¬ß 7 nr. 1). Arbeidsgiver kan ikke avsl√• dette uten s√¶rlig grunn knyttet til driftsforhold.</p>
      <h3>Restferie</h3>
      <p>De resterende 7 virkedagene (+ 5 avtalefestede) kan arbeidstaker kreve avviklet samlet i l√∏pet av ferie√•ret (ferieloven ¬ß 7 nr. 2).</p>
      <h3>Avtalefestet ferie i Oslo kommune</h3>
      <p>Jf. Dok 25 kap. 3 fastsetter arbeidsgiver tidspunktet for den avtalefestede ferien etter dr√∏ftinger med tillitsvalgte eller den enkelte arbeidstaker ‚Äì dette skjer <em>samtidig</em> med fastsettelsen av den ordin√¶re ferien.</p>
      <h3>L√¶rere i Oslo kommune</h3>
      <p>For undervisningspersonell i Oslo kommune avvikles ferie med avslutning siste virkedag i juli. Avtalefestede feriedager anses for √• v√¶re avviklet i de deler av √•ret der det ikke er arbeidsplikt (jf. Dok 25 punkt 3.1.2.1).</p>
    `
  },
  {
    id: 'sykdom',
    title: 'Sykdom under ferie',
    tags: ['sykdom', 'sykemeldt', 'erstatningsferie', 'utsettelse', 'legeerkl√¶ring', 'sykdom ferie'],
    sources: 'Ferieloven ¬ß 9 ¬∑ Dok 25 kap. 3 ¬∑ Oslo kommunes Personalh√•ndbok 2025',
    modified: '09.04.2025',
    body: `
      <h3>Rett til erstatningsferie ved sykdom</h3>
      <p>Dersom en ansatt er <strong>100 % arbeidsuf√∏r</strong> (dvs. sykmeldt i fullt omfang) under ferie, har vedkommende rett til √• kreve tilsvarende feriedager erstattet etter ferien (ferieloven ¬ß 9 nr. 1).</p>
      <div class="warn-box">‚ö†Ô∏è Krav om utsettelse av ferie p√• grunn av sykdom <strong>m√• fremsettes senest f√∏rste arbeidsdag</strong> etter at arbeidstakeren er tilbake fra sykefrav√¶ret. Fristen er absolutt.</div>
      <h3>Dokumentasjonskrav</h3>
      <ul>
        <li>Arbeidstaker m√• fremlegge <strong>legeerkl√¶ring</strong> som dokumenterer arbeidsuf√∏rheten.</li>
        <li>Egenmeldingen gjelder ikke som grunnlag for krav om erstatningsferie.</li>
        <li>Legeerkl√¶ringen m√• dekke hele perioden som kreves erstattet.</li>
      </ul>
      <h3>Delvis sykmelding</h3>
      <p>Arbeidstaker som er gradert sykmeldt (f.eks. 50 %) under ferie har <em>ikke</em> rett til erstatningsferie. Retten forutsetter full arbeidsuf√∏rhet i hele ferieperioden.</p>
      <h3>Tilbakekalling fra ferie</h3>
      <p>Arbeidsgiver har <strong>ikke hjemmel i ferieloven</strong> til √• tilbakekalle en ansatt fra ferie. Dersom arbeidsforholdet krever dette i en n√∏dssituasjon, m√• dette avtales separat, og arbeidsgiver plikter da √• dekke alle merutgifter samt kompensere for velferdstapet.</p>
      <h3>Sykdom f√∏r feriestart</h3>
      <p>Dersom arbeidstaker er syk og sykmeldt <em>f√∏r</em> ferien starter, kan vedkommende kreve ferien utsatt til senere i ferie√•ret. Kravet m√• fremsettes senest siste arbeidsdag f√∏r feriestart (ferieloven ¬ß 9 nr. 2).</p>
    `
  },
  {
    id: 'overfoering',
    title: 'Overf√∏ring av ferie til neste √•r',
    tags: ['overf√∏ring', 'restferie', 'neste √•r', 'avtale', 'fremf√∏ring'],
    sources: 'Ferieloven ¬ß 7 nr. 3 og ¬ß 11 nr. 2 ¬∑ Dok 25 kap. 3 ¬∑ Personalh√•ndboken 2025',
    modified: '09.04.2025',
    body: `
      <h3>Utgangspunkt: plikt til √• avvikle ferie</h3>
      <p>Arbeidstaker har b√•de rett og <strong>plikt</strong> til √• avvikle ferien hvert ferie√•r. Arbeidsgiver har tilsvarende plikt til √• s√∏rge for at ansatte faktisk avvikler ferien sin (ferieloven ¬ß 5 nr. 3).</p>
      <h3>Lovfestet adgang til overf√∏ring</h3>
      <p>Inntil <strong>12 virkedager</strong> (2 uker) av den lovfestede ferien kan overf√∏res til neste ferie√•r ved skriftlig avtale mellom arbeidstaker og arbeidsgiver (ferieloven ¬ß 7 nr. 3).</p>
      <div class="info-box">üìå Overf√∏ring <strong>krever skriftlig avtale</strong>. Arbeidsgiver kan ikke ensidig bestemme at ferie skal overf√∏res, og arbeidstaker kan heller ikke alene kreve overf√∏ring utover grensene.</div>
      <h3>Overf√∏ring av avtalefestet ferie (Dok 25)</h3>
      <p>Den avtalefestede ferien (den femte ferieuken) f√∏lger tilsvarende regler. Dersom virksomhetsforhold hindret avvikling, b√∏r dette dokumenteres skriftlig og overf√∏ring avtales i god tid.</p>
      <h3>Manglende avvikling ‚Äì arbeidsgivers ansvar</h3>
      <p>Dersom arbeidsgiver ikke legger til rette for at ferien kan avvikles i ferie√•ret, har arbeidstaker krav p√• erstatning for det √∏konomiske tapet (feriepengene som ikke ble ¬´brukt¬ª). Arbeidsgiver kan ikke fraskrive seg ansvaret for manglende tilrettelegging.</p>
      <h3>Overf√∏ring ved sykdom eller permisjon</h3>
      <p>Ferie som ikke ble avviklet fordi arbeidstaker var sykmeldt eller i foreldrepermisjon gjennom hele ferie√•ret, kan overf√∏res til neste ferie√•r uten begrensning (ferieloven ¬ß 9 nr. 2).</p>
    `
  },
  {
    id: 'ekstraferie',
    title: 'Ekstraferie for arbeidstakere over 60 √•r',
    tags: ['ekstraferie', '60 √•r', 'senior', 'eldre', 'ekstra feriedager', '6 virkedager'],
    sources: 'Ferieloven ¬ß 5 nr. 2 ¬∑ Dok 25 kap. 3 ¬∑ Personalh√•ndboken 2025',
    modified: '09.04.2025',
    body: `
      <h3>Rett til 6 ekstra virkedager</h3>
      <p>Arbeidstaker som <strong>fyller 60 √•r i l√∏pet av ferie√•ret</strong> har krav p√• <strong>6 ekstra virkedager</strong> ferie (ferieloven ¬ß 5 nr. 2). Dette tilsvarer √©n ekstra uke. Retten gjelder fra og med det kalender√•ret arbeidstakeren fyller 60 √•r.</p>
      <p>Dok 25 kap. 3 opprettholder denne retten eksplisitt for ansatte i Oslo kommune.</p>
      <h3>Varslingsfrist</h3>
      <p>Arbeidstaker bestemmer selv n√•r ekstraferien skal tas. Arbeidsgiver <strong>m√• varsles minst 2 uker</strong> i forveien. Ekstraferien kan tas samlet eller en eller flere dager av gangen (jf. ferieloven ¬ß 6 nr. 2).</p>
      <div class="info-box">üìå Arbeidstaker kan alts√• ta ekstraferien uten at arbeidsgiver kan nekte, s√• lenge varslingsfristen p√• 2 uker overholdes.</div>
      <h3>Feriepenger for ekstraferien</h3>
      <p>Feriepengeprosenten √∏kes til <strong>14,3 %</strong> (mot 12 % for √∏vrige ansatte) for arbeidstakere over 60 √•r. Dette for √• dekke den ekstra uka.</p>
      <h3>Deling av ekstraferien</h3>
      <p>Deles ekstraferien opp, kan arbeidstaker bare kreve √• f√• fri s√• mange arbeidsdager som vedkommende normalt har i l√∏pet av en uke. En deltidsansatt som jobber 3 dager i uka kan alts√• bare kreve 3 dager fri dersom ekstraferien deles.</p>
    `
  },
  {
    id: 'nyansatt',
    title: 'Ferie for nye ansatte og ved sluttdato',
    tags: ['ny ansatt', 'tiltredelse', 'sluttdato', 'oppsigelse', 'ikke opptjent', 'f√∏rste √•r'],
    sources: 'Ferieloven ¬ß¬ß 5, 10, 11 ¬∑ Dok 25 kap. 3 ¬∑ Personalh√•ndboken 2025',
    modified: '09.04.2025',
    body: `
      <h3>Ny ansatt ‚Äì feriedager</h3>
      <p>Alle ansatte har rett til <strong>full ferie (25 / 30 virkedager)</strong> fra og med tiltredelsesdatoen, uavhengig av om de har opptjent feriepenger fra Oslo kommune.</p>
      <div class="warn-box">‚ö†Ô∏è Selv om retten til feriedager er til stede, er retten til <strong>feriepenger</strong> avhengig av opptjening. En ansatt som begynner 1. januar har ikke opptjent feriepenger i opptjenings√•ret og kan motta redusert eller ingen feriel√∏nn f√∏rste √•r. Arbeidstaker kan da <em>nekte</em> √• avvikle den del av ferien det ikke er opptjent feriepenger for (ferieloven ¬ß 5 nr. 5).</div>
      <h3>Tiltredelsestidspunktet</h3>
      <p>Etter Dok 25 er tiltredelsestidspunktet den dag ansettelsen gjelder fra og vedkommende kunne ha tiltr√•dt. Det er en forutsetning for rettigheter at arbeidstakeren har tiltr√•dt stillingen.</p>
      <h3>Ansatt fra annen arbeidsgiver</h3>
      <p>Feriepenger opptjent hos tidligere arbeidsgiver utbetales direkte fra den tidligere arbeidsgiveren og gjelder ferie√•rets avvikling hos Oslo kommune. Ansatte b√∏r s√∏rge for at feriepengeattest fra forrige arbeidsgiver er registrert.</p>
      <h3>Avslutning av arbeidsforhold</h3>
      <p>Ved fratreden skal opptjente og ikke-avviklede feriepenger utbetales. Dersom arbeidstaker har avviklet mer ferie enn opptjente feriepenger tilsier, kan arbeidsgiver trekke differansen i siste l√∏nnsutbetaling (ferieloven ¬ß 11 nr. 3).</p>
      <p>Restsaldo av avviklet ferie ved oppsigelse m√• alltid avklares mellom HR, leder og l√∏nnstjenesten.</p>
    `
  },
  {
    id: 'lonntrekk',
    title: 'L√∏nnstrekk og ferietrekkordningen',
    tags: ['l√∏nnstrekk', 'ferietrekk', 'l√∏nn under ferie', 'teknisk trekk', '30/26', 'juni utbetaling'],
    sources: 'Dok 25 ¬ß 3.1 ¬∑ Ferieloven ¬ß 10 ¬∑ Personalh√•ndboken 2025 kap. 6',
    modified: '09.04.2025',
    body: `
      <h3>Prinsippet bak trekkordningen</h3>
      <p>I Oslo kommune benyttes en trekkordningsmodell der vanlig l√∏nn utbetales under ferieavvikling, og det gjennomf√∏res et teknisk l√∏nnstrekk for √• balansere mot feriepengeutbetalingen i juni.</p>
      <h3>Teknisk l√∏nnstrekk</h3>
      <ul>
        <li>For ansatte med <strong>avtalefestet ferie (30 virkedager)</strong>: trekk = <strong>30/26 av m√•nedsl√∏nn</strong></li>
        <li>For ansatte med kun <strong>lovfestet ferie (25 virkedager)</strong>: trekk = <strong>25/26 av m√•nedsl√∏nn</strong></li>
      </ul>
      <div class="info-box">üìå Trekket gj√∏res i den m√•neden feriepengene utbetales (juni). Det tekniske trekket og feriepengeutbetalingen gjennomf√∏res samlet i junil√∏nnen. Ansatte mottar da feriepengene, men f√•r ogs√• trekket, slik at netto betalingen reflekterer normalt l√∏nnsniv√•.</div>
      <h3>Feriel√∏nntillegget</h3>
      <p>Den del av feriepengene som overstiger l√∏nn for vanlig arbeidstid (feriel√∏nnstillegget) utbetales separat i juni. For de fleste vil dette si at junil√∏nnen er noe h√∏yere enn normalt, ettersom feriepengeprosenten (12 %) er h√∏yere enn hva som dekker bare ordin√¶r l√∏nn.</p>
      <h3>Praktisk eksempel</h3>
      <p>En ansatt med m√•nedsl√∏nn p√• 50 000 kr:</p>
      <ul>
        <li>Feriepengegrunnlag (√•rsl√∏nn fra fjor√•ret): 600 000 kr √ó 12 % = 72 000 kr i feriepenger</li>
        <li>Teknisk l√∏nnstrekk i juni: 50 000 √ó (30/26) ‚âà 57 692 kr</li>
        <li>Netto ferietillegg i juni: 72 000 ‚àí 57 692 ‚âà 14 308 kr ekstra</li>
      </ul>
      <p>I tillegg mottar vedkommende vanlig l√∏nn gjennom √•ret, inkludert i feriem√•nedene.</p>
      <h3>Sp√∏rsm√•l til l√∏nnstjenesten</h3>
      <p>Dersom ansatte har sp√∏rsm√•l om konkrete trekk eller utbetalinger, skal dette rettes til <strong>Oslo kommunes l√∏nnstjeneste</strong> via Personalportalen eller leder.</p>
    `
  }
];

// ============================================================
//  STATE
// ============================================================
let currentUser = null;
let currentArticleId = null;

// ‚îÄ‚îÄ Available icons and colours for category picker ‚îÄ‚îÄ
const ICONS = ['üìÖ','üí∞','üìã','üè•','üîÑ','üéÇ','üë§','üìä','üìÅ','‚öñÔ∏è','üóì','üíº','üèñ','üìù','üîî','‚úÖ','‚ÑπÔ∏è','üìå','üîë','üèõ','üë•','üí°','üì£','üïê','üö®','üìÉ','üßÆ','üì§'];
const COLORS = ['#e0e8f7','#e0f4ec','#fef3d8','#fde8ec','#ede0f7','#e0f0f7','#f7ede0','#e8f7e0','#f0e0f7','#d8f0fe'];

// ‚îÄ‚îÄ Categories data (drives the card grid on home page) ‚îÄ‚îÄ
let categories = [
  { id: 'cat1', icon: 'üìÖ', color: '#e0e8f7', title: 'Antall feriedager',    desc: 'Lovfestet og avtalefestet ferie ‚Äì hvem har krav p√• hva etter Dok 25 og ferieloven?', link: 'feriedager' },
  { id: 'cat2', icon: 'üí∞', color: '#e0f4ec', title: 'Feriepenger',           desc: 'Beregning, prosentsatser, trekkordning og utbetaling i juni.',                         link: 'feriepenger' },
  { id: 'cat3', icon: 'üìã', color: '#fef3d8', title: 'Fastsettelse av ferie', desc: 'Regler om hvem som bestemmer, frister og dr√∏ftingskrav.',                              link: 'fastsettelse' },
  { id: 'cat4', icon: 'üè•', color: '#fde8ec', title: 'Sykdom under ferie',   desc: 'Rett til ny ferie ved sykdom, dokumentasjonskrav og prosedyre.',                       link: 'sykdom' },
  { id: 'cat5', icon: 'üîÑ', color: '#e0e8f7', title: 'Overf√∏ring av ferie',  desc: 'N√•r kan ferie overf√∏res til neste √•r? Avtalte og lovbestemte grenser.',                link: 'overfoering' },
  { id: 'cat6', icon: 'üéÇ', color: '#e0f4ec', title: 'Ekstraferie 60 √•r+',   desc: 'Rett til 6 ekstra virkedager, varslingsfrist og fleksibilitet.',                       link: 'ekstraferie' },
  { id: 'cat7', icon: 'üë§', color: '#fef3d8', title: 'Ny ansatt / slutt',    desc: 'Ferierettigheter ved tiltredelse, oppsigelse og √•rstall-overganger.',                  link: 'nyansatt' },
  { id: 'cat8', icon: 'üìä', color: '#fde8ec', title: 'L√∏nnstrekk og l√∏nn',   desc: 'Teknisk l√∏nnstrekk, ferietrekk og sammenhengen med feriepenger.',                      link: 'lonntrekk' },
];

// ‚îÄ‚îÄ User database (demo ‚Äì replace with server auth in production) ‚îÄ‚îÄ
let users = [
  { username: 'okf',    password: 'okf2024',    role: 'okf',    label: 'OKF L√∏nn',     caps: { articles: true,  announcements: true,  categories: true,  site: false, users: false } },
  { username: 'hr',     password: 'hr2024',     role: 'hr',     label: 'HR-avdelingen', caps: { articles: true,  announcements: true,  categories: true,  site: false, users: false } },
  { username: 'master', password: 'master2024', role: 'master', label: 'Master',         caps: { articles: true,  announcements: true,  categories: true,  site: true,  users: true  } },
];

// Role capabilities
const roleCapabilities = {
  okf:    { articles: true,  announcements: true,  site: false, users: false, label: 'OKF (L√∏nn)',    badge: 'role-okf' },
  hr:     { articles: true,  announcements: true,  site: false, users: false, label: 'HR',            badge: 'role-hr'  },
  master: { articles: true,  announcements: true,  site: true,  users: true,  label: 'Master',        badge: 'role-master' },
};

let announcements = [
  { id: 'ann1', title: 'Frist for ferie√∏nsker 2025', body: 'Alle ansatte m√• levere ferie√∏nsker til n√¶rmeste leder innen 1. mars 2025. Bruk Personalportalen.', type: 'viktig', date: '05.02.2025', author: 'HR-avdelingen' },
  { id: 'ann2', title: 'Ny veileder for l√¶rere',     body: 'Oppdatert veileder for ferieavvikling i skolen er n√• tilgjengelig. Se artikkel om fastsettelse.',   type: 'info',   date: '10.01.2025', author: 'L√∏nnstjenesten' }
];

// Site settings (editable by master)
let siteSettings = {
  topbarLeft:       'Oslo kommune ‚Äì Internt HR-verkt√∏y',
  topbarRight:      'üìã Ferieportalen v1.0 ¬∑ Basert p√• Dok 25 (2024‚Äì2026) og ferieloven',
  portalName:       'Ferieportalen',
  portalSub:        'Oslo Kommune ¬∑ HR & L√∏nn',
  logoLetter:       'O',
  heroTitle:        'Finn svar om ferie i Oslo kommune',
  heroSub:          'S√∏k i reglement, Dok 25, ferieloven og interne retningslinjer for HR, ledere og l√∏nnstjenesten.',
  featuredTitle:    'Fremhevede artikler',
  annHeader:        'üì¢ Viktige beskjeder',
  recentHeader:     'üìÑ Sist publiserte artikler',
  footer1:          'Ferieportalen ¬∑ Oslo Kommune ¬∑ HR og L√∏nn ¬∑ Basert p√• Dok 25 (2024‚Äì2026), Ferieloven og Oslo kommunes Personalh√•ndbok 2025',
  footer2:          'oslo.kommune.no ¬∑ Innhold er veiledende ‚Äì kontakt l√∏nnstjenesten ved tvil',
  colorBlue:        '#003087',
  colorRed:         '#C8102E',
  colorGreen:       '#1a7a4a',
  colorAccent:      '#e8ecf7',
  colorLight:       '#f5f6fa',
  quickTags: [
    { label: 'Antall feriedager',   query: 'Feriedager antall' },
    { label: 'Feriepenger',         query: 'Feriepenger' },
    { label: 'Sykdom under ferie',  query: 'Sykdom under ferie' },
    { label: 'Ekstraferie 60+',     query: 'Ekstraferie over 60' },
    { label: 'Overf√∏ring av ferie', query: 'Overf√∏ring ferie' },
    { label: 'Fastsettelse',        query: 'Fastsettelse ferie' },
    { label: 'Ny ansatt',           query: 'Ny ansatt ferie' },
    { label: 'Utbetaling juni',     query: 'Feriepenger utbetaling' },
  ],
};

// ============================================================
//  PAGES
// ============================================================
function showPage(name) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById('page-' + name).classList.add('active');
}

// ============================================================
//  SEARCH
// ============================================================
function doSearch() {
  const q = document.getElementById('search-input').value.trim();
  if (!q) return;
  document.getElementById('search-input2').value = q;
  runSearch(q);
}
function doSearch2() {
  const q = document.getElementById('search-input2').value.trim();
  if (!q) return;
  document.getElementById('search-input').value = q;
  runSearch(q);
}
function quickSearch(q) {
  document.getElementById('search-input').value = q;
  document.getElementById('search-input2').value = q;
  runSearch(q);
}

// Synonym map ‚Äî maps search words to related terms
const SYNONYMS = {
  'ferie':       ['ferie', 'feriedager', 'feriepenger', 'avspasering', 'fri'],
  'penger':      ['penger', 'feriepenger', 'l√∏nn', 'utbetaling', 'trekk', 'inntekt'],
  'syk':         ['syk', 'sykdom', 'sykmelding', 'sykemelding', 'sykefrav√¶r'],
  'overf√∏ring':  ['overf√∏ring', 'overf√∏re', 'restferie', 'neste √•r'],
  'ny ansatt':   ['ny ansatt', 'nyansatt', 'tiltredelse', 'begynte'],
  'slutt':       ['slutt', 'oppsigelse', 'slutter', 'avslutning'],
  'gammel':      ['gammel', 'senior', 'ekstraferie', '60', 'eldre'],
  'fastsettelse':['fastsettelse', 'fastsette', 'planlegge', 'plan', 'dr√∏fting'],
  'trekk':       ['trekk', 'l√∏nnstrekk', 'ferietrekk', 'trekkordning', 'juni'],
  'beregning':   ['beregning', 'beregne', 'kalkulator', 'kalkulere', 'regne'],
  'permisjon':   ['permisjon', 'foreldrepermisjon', 'f√∏dselspermisjon'],
  'delvis':      ['delvis', 'gradert', 'deltid', 'redusert'],
};

function expandQuery(q) {
  const terms = q.toLowerCase().split(/\s+/).filter(Boolean);
  const expanded = new Set(terms);
  terms.forEach(term => {
    Object.entries(SYNONYMS).forEach(([key, vals]) => {
      if (key.includes(term) || term.includes(key) || vals.some(v => v.includes(term))) {
        vals.forEach(v => expanded.add(v));
      }
    });
  });
  return { original: terms, expanded: [...expanded] };
}

function scoreArticle(a, terms, expanded) {
  const titleLow = a.title.toLowerCase();
  const tagsLow  = a.tags.join(' ').toLowerCase();
  const bodyLow  = stripTags(a.body).toLowerCase();
  let score = 0;
  let matchedTerms = 0;

  terms.forEach(term => {
    if (titleLow.includes(term)) { score += 10; matchedTerms++; }
    else if (tagsLow.includes(term)) { score += 5; matchedTerms++; }
    else if (bodyLow.includes(term)) { score += 2; matchedTerms++; }
  });
  // Bonus for synonym/expanded matches (softer)
  expanded.forEach(term => {
    if (!terms.includes(term)) {
      if (titleLow.includes(term)) score += 3;
      else if (tagsLow.includes(term)) score += 2;
      else if (bodyLow.includes(term)) score += 1;
    }
  });
  return { score, matchedTerms };
}

function runSearch(q) {
  const { original, expanded } = expandQuery(q);
  const results = articles
    .map(a => ({ a, ...scoreArticle(a, original, expanded) }))
    .filter(r => r.score > 0)
    .sort((x, y) => y.score - x.score);

  document.getElementById('results-heading').textContent = `Resultater for ¬´${q}¬ª`;
  document.getElementById('results-count').textContent =
    results.length === 0 ? 'Ingen treff' :
    results.length === 1 ? '1 treff' : `${results.length} treff`;

  const list = document.getElementById('results-list');
  if (results.length === 0) {
    list.innerHTML = `<div class="result-item">
      <h4>Ingen treff for ¬´${q}¬ª</h4>
      <p>Pr√∏v kortere s√∏keord, eller bla gjennom fremhevede artikler p√• forsiden.</p>
    </div>`;
  } else {
    list.innerHTML = results.map(({ a, score, matchedTerms }) => {
      // Highlight original search terms in excerpt
      let excerpt = stripTags(a.body).substring(0, 200);
      original.forEach(term => {
        const re = new RegExp('(' + term.replace(/[.*+?^${}()|[\]\\]/g,'\\$&') + ')', 'gi');
        excerpt = excerpt.replace(re, '<mark style="background:#fff3c0;border-radius:2px;padding:0 2px">$1</mark>');
      });
      return `
      <div class="result-item" onclick="openArticle('${a.id}')">
        <h4>${a.title}</h4>
        <p>${excerpt}‚Ä¶</p>
        <div class="result-meta">
          ${a.tags.slice(0,4).map(t => `<span class="tag tag-blue">${t}</span>`).join('')}
          <span class="tag tag-green">Oppdatert ${a.modified}</span>
        </div>
      </div>`;
    }).join('');
  }
  showPage('results');
}

function stripTags(html) {
  return html.replace(/<[^>]+>/g, ' ').replace(/\s+/g, ' ').trim();
}

// ============================================================
//  ARTICLE
// ============================================================
function openArticle(id) {
  const a = articles.find(x => x.id === id);
  if (!a) return;
  currentArticleId = id;
  document.getElementById('article-breadcrumb').textContent = a.title;
  const canEdit = currentUser && roleCapabilities[currentUser.role]?.articles;
  const adminEditBtn = canEdit ? `<button class="btn-primary" style="margin-top:20px" onclick="editArticleFromView('${id}')">‚úèÔ∏è Rediger denne artikkelen</button>` : '';
  document.getElementById('article-content').innerHTML = `
    <div class="article-header">
      <h2>${a.title}</h2>
      <div class="article-meta">
        <span>üìÖ Sist oppdatert: ${a.modified}</span>
        <span>üè∑ ${a.tags.slice(0,5).join(', ')}</span>
      </div>
    </div>
    <div class="article-body">${a.body}</div>
    <div class="source-box"><strong>Kilder og hjemler:</strong> ${a.sources}</div>
    <p style="margin-top:14px;font-size:12.5px;color:var(--ok-muted)">Innholdet er basert p√• gjeldende regelverk, men er veiledende. Kontakt l√∏nnstjenesten eller HR ved juridisk usikkerhet.</p>
    ${adminEditBtn}
  `;
  showPage('article');
}

function editArticleFromView(id) {
  showPage('admin');
  editArticle(id);
}

// ============================================================
//  ANNOUNCEMENTS
// ============================================================
const annBadgeMap = {
  viktig: ['ann-badge-red', 'üî¥ Viktig'],
  info:   ['ann-badge-blue', '‚ÑπÔ∏è Info'],
  ok:     ['ann-badge-green', '‚úÖ Bekreftet'],
  advarsel:['ann-badge-yellow','‚ö†Ô∏è Advarsel']
};

function renderRecentArticles() {
  const el = document.getElementById('recent-articles-list');
  if (!el) return;
  // Sort by modified date descending ‚Äî use articles array order as fallback (newest custom articles last)
  const sorted = [...articles].sort((a, b) => {
    // Parse Norwegian date format dd.mm.yyyy
    const parse = d => {
      const p = (d || '').split('.');
      if (p.length === 3) return new Date(p[2], p[1]-1, p[0]);
      return new Date(0);
    };
    return parse(b.modified) - parse(a.modified);
  }).slice(0, 6);

  el.innerHTML = sorted.map(a => `
    <div class="ann-item" onclick="openArticle('${a.id}')" style="cursor:pointer;transition:background .1s"
         onmouseover="this.style.background='var(--ok-light)'" onmouseout="this.style.background=''">
      <div class="ann-item-title" style="gap:0;flex-direction:column;align-items:flex-start">
        <span style="font-weight:500;color:var(--ok-blue)">${a.title}</span>
      </div>
      <div class="ann-item-body" style="margin-top:3px">${stripTags(a.body).substring(0, 80)}‚Ä¶</div>
      <div class="ann-item-meta" style="display:flex;justify-content:space-between;align-items:center">
        <span>${a.tags.slice(0,2).map(t => `<span style="background:var(--ok-accent);padding:1px 6px;border-radius:8px;font-size:10.5px;color:var(--ok-blue)">${t}</span>`).join(' ')}</span>
        <span>üìÖ ${a.modified}</span>
      </div>
    </div>`).join('');
}

function renderAnnouncements() {
  const list = document.getElementById('ann-list');
  const countLabel = document.getElementById('ann-count-label');
  if (!list) return;
  if (announcements.length === 0) {
    list.innerHTML = '<div class="ann-empty">Ingen aktive beskjeder</div>';
    countLabel.textContent = '';
    return;
  }
  countLabel.textContent = announcements.length + ' aktiv' + (announcements.length !== 1 ? 'e' : '');
  list.innerHTML = announcements.map(a => {
    const [badgeClass, badgeLabel] = annBadgeMap[a.type] || annBadgeMap.info;
    return `
      <div class="ann-item">
        <div class="ann-item-title">
          <span class="ann-badge ${badgeClass}">${badgeLabel}</span>
          <span>${a.title}</span>
        </div>
        <div class="ann-item-body">${a.body}</div>
        <div class="ann-item-meta">${a.author} ¬∑ ${a.date}</div>
      </div>`;
  }).join('');
}

function renderAnnAdminList() {
  const el = document.getElementById('ann-admin-list');
  if (!el) return;
  if (announcements.length === 0) {
    el.innerHTML = '<p style="font-size:13px;color:var(--ok-muted)">Ingen beskjeder lagt til enn√•.</p>';
    return;
  }
  el.innerHTML = announcements.map(a => {
    const [badgeClass, badgeLabel] = annBadgeMap[a.type] || annBadgeMap.info;
    return `
      <div style="display:flex;justify-content:space-between;align-items:flex-start;padding:12px 0;border-bottom:1px solid var(--ok-border)">
        <div>
          <span class="ann-badge ${badgeClass}" style="margin-right:6px">${badgeLabel}</span>
          <strong style="font-size:13.5px">${a.title}</strong>
          <div style="font-size:12.5px;color:var(--ok-muted);margin-top:3px">${a.body}</div>
          <div style="font-size:11px;color:#aab0c0;margin-top:2px">${a.author} ¬∑ ${a.date}</div>
        </div>
        <span class="edit-link" onclick="openAnnEdit('${a.id}')" style="margin-left:0">Rediger</span>
        <span class="delete-link" onclick="deleteAnnouncement('${a.id}')" style="margin-left:10px">Slett</span>
      </div>`;
  }).join('');
}

function saveAnnouncement() {
  const title = document.getElementById('ann-new-title').value.trim();
  const body = document.getElementById('ann-new-body').value.trim();
  if (!title || !body) { alert('Tittel og innhold er p√•krevd'); return; }
  const authorInput = document.getElementById('ann-new-author').value.trim();
  announcements.unshift({
    id: 'ann_' + Date.now(),
    title, body,
    type: document.getElementById('ann-new-type').value,
    date: new Date().toLocaleDateString('nb-NO'),
    author: authorInput || (currentUser ? roleCapabilities[currentUser.role].label : 'Administrator')
  });
  document.getElementById('ann-new-title').value = '';
  document.getElementById('ann-new-body').value = '';
  document.getElementById('ann-new-author').value = '';
  renderAnnouncements();
  renderAnnAdminList();
  recordActivity(`publiserte beskjed ¬´${title}¬ª`);
  showToast('üì¢ Beskjed publisert p√• forsiden');
  logActivity('Ny beskjed publisert: ' + title);
}

function deleteAnnouncement(id) {
  if (confirm('Slett denne beskjeden?')) {
    announcements = announcements.filter(a => a.id !== id);
    renderAnnouncements();
    renderAnnAdminList();
    logActivity('Beskjed slettet');
    showToast('üóë Beskjed slettet');
  }
}

// ============================================================
//  FERIEKALKULATOR
// ============================================================
function runKalkulator() {
  const alder    = parseInt(document.getElementById('kalk-alder').value) || 35;
  const lonn     = parseFloat(document.getElementById('kalk-lonn').value) || 0;
  const tillegg  = parseFloat(document.getElementById('kalk-tillegg').value) || 0;
  const fpOpptj  = parseFloat(document.getElementById('kalk-fpopptj').value) || 0;

  if (!lonn) {
    document.getElementById('kalk-result').classList.add('show');
    document.getElementById('kalk-result').innerHTML = '<div class="warn-box">‚ö†Ô∏è Fyll inn brutto m√•nedsl√∏nn i juni for √• beregne.</div>';
    return;
  }

  // ‚îÄ‚îÄ Ferierett (formell) ‚îÄ‚îÄ
  const ferierettDager = alder >= 60 ? 30 : 25;
  const fepieProsent   = alder >= 60 ? 14.3 : 12.0;
  const seniorLabel    = alder >= 60 ? '30 virkedager (over 60 √•r)' : '25 virkedager (under 60 √•r)';

  // ‚îÄ‚îÄ Dagsats: (m√•nedsl√∏nn + faste tillegg) / 22 arbeidsdager ‚îÄ‚îÄ
  const grunnlag  = lonn + tillegg;
  const dagsats   = grunnlag / 22;

  // ‚îÄ‚îÄ Teknisk l√∏nnstrekk: dagsats √ó ferierettdager ‚îÄ‚îÄ
  const trekkBeloep = dagsats * ferierettDager;

  // ‚îÄ‚îÄ Betalte feriedager: feriepenger / dagsats ‚îÄ‚îÄ
  // Antall dager ferieopptjeningen dekker
  let betalteDager = null;
  let betaltLabel  = '';
  if (fpOpptj > 0) {
    betalteDager = Math.min(Math.round((fpOpptj / dagsats) * 10) / 10, ferierettDager);
    betaltLabel  = betalteDager >= ferierettDager
      ? `${betalteDager} dager (full l√∏nn under all ferie)`
      : `${betalteDager} av ${ferierettDager} dager dekket av opptjente feriepenger`;
  }

  // ‚îÄ‚îÄ Render ‚îÄ‚îÄ
  const res = document.getElementById('kalk-result');
  res.classList.add('show');
  res.innerHTML = `
    <div class="calc-result-grid">
      <div class="calc-stat">
        <div class="cs-label">Ferierett (formell)</div>
        <div class="cs-value">${ferierettDager}</div>
        <div class="cs-sub">${seniorLabel}</div>
      </div>

      ${betalteDager !== null ? `
      <div class="calc-stat" style="background:#e0f4ec">
        <div class="cs-label">Betalte feriedager</div>
        <div class="cs-value" style="color:var(--ok-green)">${betalteDager}</div>
        <div class="cs-sub">${betaltLabel}</div>
      </div>` : ''}

      <div class="calc-stat">
        <div class="cs-label">Feriepengeprosent</div>
        <div class="cs-value">${fepieProsent} %</div>
        <div class="cs-sub">${alder >= 60 ? 'Senior (60+ √•r)' : 'Standard (under 60 √•r)'}</div>
      </div>

      <div class="calc-stat" style="background:#fde8ec">
        <div class="cs-label">Teknisk l√∏nnstrekk juni</div>
        <div class="cs-value" style="color:var(--ok-red)">‚àí ${Math.round(trekkBeloep).toLocaleString('nb-NO')}</div>
        <div class="cs-sub">kr &nbsp;¬∑&nbsp; dagsats ${Math.round(dagsats).toLocaleString('nb-NO')} kr √ó ${ferierettDager} dager</div>
      </div>
    </div>

    <div class="calc-note" style="margin-top:14px">
      <strong>Slik er trekket beregnet:</strong><br>
      Grunnlag juni: ${grunnlag.toLocaleString('nb-NO')} kr
      ${tillegg > 0 ? ` (l√∏nn ${lonn.toLocaleString('nb-NO')} + tillegg ${tillegg.toLocaleString('nb-NO')})` : ''} &nbsp;√∑&nbsp;
      22 arbeidsdager = <strong>${Math.round(dagsats).toLocaleString('nb-NO')} kr/dag</strong>
      &nbsp;√ó&nbsp; ${ferierettDager} feriedager = <strong>${Math.round(trekkBeloep).toLocaleString('nb-NO')} kr trekk</strong>.
      ${fpOpptj > 0 ? ` Feriepengeopptjening: ${fpOpptj.toLocaleString('nb-NO')} kr dekker ${betalteDager} dager.` : ''}
      <br>Kilde: Ferieloven ¬ß¬ß 5 og 10, Dok 25 kap. 3. Alle tall er veiledende.
    </div>
  `;
}

// ============================================================
//  ADMIN TAB
// ============================================================
function adminTab(tab, el) {
  document.querySelectorAll('.admin-sidebar-item').forEach(i => i.classList.remove('active'));
  if (el) el.classList.add('active');
  ['admin-list','admin-new','admin-edit','admin-announcements','admin-site','admin-users','admin-categories'].forEach(id => {
    const el2 = document.getElementById(id);
    if (el2) el2.style.display = 'none';
  });
  const panel = document.getElementById('admin-' + tab);
  if (panel) panel.style.display = 'block';
  if (tab === 'list') renderArticlesTable();
  if (tab === 'announcements') renderAnnAdminList();
  if (tab === 'site') loadSiteSettingsToForm();
  if (tab === 'users') renderUsersTable();
  if (tab === 'categories') renderCatAdmin();
}

function renderArticlesTable() {
  const tbody = document.getElementById('articles-tbody');
  tbody.innerHTML = articles.map(a => `
    <tr>
      <td><strong>${a.title}</strong></td>
      <td><span class="tag tag-blue">${a.tags[0]}</span></td>
      <td>${a.modified}</td>
      <td>
        <span class="edit-link" onclick="editArticle('${a.id}')">Rediger</span>
        <span class="delete-link" onclick="confirmDelete('${a.id}')">Slett</span>
      </td>
    </tr>`).join('');
}

function editArticle(id) {
  const a = articles.find(x => x.id === id);
  if (!a) return;
  document.getElementById('edit-id').value = a.id;
  document.getElementById('edit-title').value = a.title;
  document.getElementById('edit-tags').value = a.tags.join(', ');
  document.getElementById('rte-edit').innerHTML = a.body;
  document.getElementById('edit-sources').value = a.sources;
  const editTabBtn = document.getElementById('tab-btn-edit');
  editTabBtn.style.display = 'flex';
  adminTab('edit', editTabBtn);
}

function saveEditArticle() {
  const id = document.getElementById('edit-id').value;
  const a = articles.find(x => x.id === id);
  if (!a) return;
  a.title    = document.getElementById('edit-title').value;
  a.tags     = document.getElementById('edit-tags').value.split(',').map(t => t.trim());
  a.body     = document.getElementById('rte-edit').innerHTML;
  a.sources  = document.getElementById('edit-sources').value;
  a.modified = new Date().toLocaleDateString('nb-NO');
  recordActivity(`redigerte artikkelen ¬´${a.title}¬ª`);
  showToast('‚úÖ Artikkelen er oppdatert');
  renderRecentArticles();
  logActivity('Artikkel redigert: ' + a.title);
  document.getElementById('tab-btn-edit').style.display = 'none';
  adminTab('list', document.getElementById('tab-btn-list'));
}

function saveNewArticle() {
  const title = document.getElementById('new-title').value.trim();
  if (!title) { alert('Tittel er p√•krevd'); return; }
  articles.push({
    id: 'custom_' + Date.now(),
    title,
    tags:     document.getElementById('new-tags').value.split(',').map(t => t.trim()),
    body:     document.getElementById('rte-new').innerHTML,
    sources:  document.getElementById('new-sources').value,
    modified: new Date().toLocaleDateString('nb-NO')
  });
  document.getElementById('new-title').value = '';
  document.getElementById('new-tags').value  = '';
  document.getElementById('rte-new').innerHTML = '';
  document.getElementById('new-sources').value = '';
  showToast('‚úÖ Ny artikkel er lagt til');
  logActivity('Ny artikkel: ' + title);
  recordActivity(`la til ny artikkel ¬´${title}¬ª`);
  renderRecentArticles();
  adminTab('list', document.getElementById('tab-btn-list'));
}

function confirmDelete(id) {
  if (confirm('Er du sikker p√• at du vil slette denne artikkelen?')) {
    articles = articles.filter(a => a.id !== id);
    renderArticlesTable();
    renderRecentArticles();
    showToast('üóë Artikkelen er slettet');
  }
}

function deleteArticle() {
  const id = document.getElementById('edit-id').value;
  confirmDelete(id);
  document.getElementById('tab-btn-edit').style.display = 'none';
  adminTab('list', document.getElementById('tab-btn-list'));
}

// ============================================================
//  SITE SETTINGS
// ============================================================
function loadSiteSettingsToForm() {
  const s = siteSettings;
  document.getElementById('site-topbar-left').value   = s.topbarLeft;
  document.getElementById('site-topbar-right').value  = s.topbarRight;
  document.getElementById('site-portal-name').value   = s.portalName;
  document.getElementById('site-portal-sub').value    = s.portalSub;
  document.getElementById('site-hero-title').value    = s.heroTitle;
  document.getElementById('site-hero-sub').value      = s.heroSub;
  document.getElementById('site-featured-title').value = s.featuredTitle;
  document.getElementById('site-ann-header').value    = s.annHeader;
  document.getElementById('site-recent-header').value = s.recentHeader;
  document.getElementById('site-footer1').value       = s.footer1;
  document.getElementById('site-footer2').value       = s.footer2;
  // Color pickers + hex fields
  const colors = { blue: s.colorBlue, red: s.colorRed, green: s.colorGreen, accent: s.colorAccent };
  Object.entries(colors).forEach(([name, val]) => {
    const pick = document.getElementById('site-color-' + name);
    const hex  = document.getElementById('site-color-' + name + '-hex');
    if (pick) pick.value = val;
    if (hex)  hex.value  = val;
  });
  // Quick tags as pipe-separated lines
  document.getElementById('site-quick-tags').value    = (s.quickTags || []).map(t => `${t.label}|${t.query}`).join('\n');
}

function saveSiteSettings() {
  const s = siteSettings;
  s.topbarLeft     = document.getElementById('site-topbar-left').value;
  s.topbarRight    = document.getElementById('site-topbar-right').value;
  s.portalName     = document.getElementById('site-portal-name').value;
  s.portalSub      = document.getElementById('site-portal-sub').value;
  s.heroTitle      = document.getElementById('site-hero-title').value;
  s.heroSub        = document.getElementById('site-hero-sub').value;
  s.featuredTitle  = document.getElementById('site-featured-title').value;
  s.annHeader      = document.getElementById('site-ann-header').value;
  s.recentHeader   = document.getElementById('site-recent-header').value;
  s.footer1        = document.getElementById('site-footer1').value;
  s.footer2        = document.getElementById('site-footer2').value;
  s.colorBlue      = document.getElementById('site-color-blue').value;
  s.colorRed       = document.getElementById('site-color-red').value;
  s.colorGreen     = document.getElementById('site-color-green').value;
  s.colorAccent    = document.getElementById('site-color-accent').value;
  // Parse quick tags
  const rawTags = document.getElementById('site-quick-tags').value;
  s.quickTags = rawTags.split('\n').map(line => {
    const [label, ...rest] = line.split('|');
    return { label: label.trim(), query: rest.join('|').trim() || label.trim() };
  }).filter(t => t.label);
  applySiteSettings();
  recordActivity('oppdaterte nettstedinnstillinger');
  showToast('‚úÖ Nettstedinnstillinger lagret og aktivert');
  logActivity('Nettstedinnstillinger oppdatert');
}

function applySiteSettings() {
  const s = siteSettings;

  // CSS variables (colors)
  const root = document.documentElement.style;
  root.setProperty('--ok-blue',   s.colorBlue);
  root.setProperty('--ok-red',    s.colorRed);
  root.setProperty('--ok-green',  s.colorGreen);
  root.setProperty('--ok-accent', s.colorAccent);
  root.setProperty('--ok-light',  s.colorLight);

  // Topbar
  const tbChildren = document.querySelector('.topbar').children;
  if (tbChildren[0]) tbChildren[0].textContent = s.topbarLeft;
  if (tbChildren[1]) tbChildren[1].textContent = s.topbarRight;

  // Logo
  document.querySelector('.logo-text h1').textContent = s.portalName;
  document.querySelector('.logo-text span').textContent = s.portalSub;

  // Hero
  document.querySelector('.hero h2').textContent = s.heroTitle;
  document.querySelector('.hero > p').textContent = s.heroSub;

  // Quick tags
  const qt = document.querySelector('.quick-tags');
  if (qt && s.quickTags) {
    qt.innerHTML = s.quickTags.map(t =>
      `<button onclick="quickSearch('${t.query.replace(/'/g,"\\'")}')"> ${t.label}</button>`
    ).join('');
  }

  // Section titles
  const featTitle = document.querySelector('.categories .section-title');
  if (featTitle) featTitle.textContent = s.featuredTitle;

  // Announcements + recent headers (only first child text node)
  const annHeader = document.querySelector('#ann-list')?.closest('.announcements-panel')?.querySelector('.ann-header');
  if (annHeader) {
    const countSpan = annHeader.querySelector('span');
    annHeader.childNodes.forEach(n => { if (n.nodeType === 3) n.textContent = s.annHeader + ' '; });
  }
  const recentHeader = document.querySelector('#recent-articles-list')?.closest('.announcements-panel')?.querySelector('.ann-header');
  if (recentHeader) recentHeader.textContent = s.recentHeader;

  // Footer
  const f1 = document.getElementById('footer-line1');
  const f2 = document.getElementById('footer-line2');
  if (f1) f1.textContent = s.footer1;
  if (f2) f2.textContent = s.footer2;

  // Page title
  document.title = s.portalName + ' ‚Äì Oslo Kommune';

  // Refresh inline editables if master is viewing
  if (currentUser && getUserCaps(currentUser).site) renderInlineEditors();
}

// Sync color picker ‚Üî hex input
function syncColor(name) {
  const hex  = document.getElementById('site-color-' + name + '-hex');
  const pick = document.getElementById('site-color-' + name);
  if (!hex || !pick) return;
  const val = hex.value.trim();
  if (/^#[0-9a-fA-F]{6}$/.test(val)) pick.value = val;
}

// When color picker changes, update hex field
document.addEventListener('input', e => {
  const m = e.target?.id?.match(/^site-color-(blue|red|green|accent)$/);
  if (m) {
    const hex = document.getElementById('site-color-' + m[1] + '-hex');
    if (hex) hex.value = e.target.value;
  }
});

// ‚îÄ‚îÄ Load color hex fields when opening site settings ‚îÄ‚îÄ
const _origLoadSettings = loadSiteSettingsToForm;
// (already defined inline ‚Äî hex sync happens inside loadSiteSettingsToForm)

// ‚îÄ‚îÄ Inline editing for master users ‚îÄ‚îÄ
// Add .site-editable wrappers to key elements so master can click-to-edit
const INLINE_EDITABLE = [
  { selector: '.topbar > span:first-child',  key: 'topbarLeft' },
  { selector: '#topbar-status',              key: 'topbarRight' },
  { selector: '.logo-text h1',               key: 'portalName' },
  { selector: '.logo-text span',             key: 'portalSub' },
  { selector: '.hero h2',                    key: 'heroTitle' },
  { selector: '.hero > p',                   key: 'heroSub' },
  { selector: '.categories .section-title',  key: 'featuredTitle' },
];

function renderInlineEditors() {
  const isMaster = currentUser && getUserCaps(currentUser).site;
  const hint = document.getElementById('master-edit-hint');
  if (hint) hint.style.display = isMaster ? 'block' : 'none';
  INLINE_EDITABLE.forEach(({ selector, key }) => {
    const el = document.querySelector(selector);
    if (!el) return;
    if (isMaster) {
      el.title = '‚úèÔ∏è Klikk for √• redigere';
      el.style.cursor = 'pointer';
      el.style.outline = '1.5px dashed rgba(255,255,255,.45)';
      el.style.borderRadius = '3px';
      el.onclick = (e) => { e.stopPropagation(); startInlineEdit(el, key); };
    } else {
      el.title = '';
      el.style.cursor = '';
      el.style.outline = '';
      el.onclick = null;
    }
  });
}

function startInlineEdit(el, key) {
  if (el.dataset.editing) return;
  el.dataset.editing = '1';
  const original = el.textContent;
  const input = document.createElement('input');
  input.value = original;
  input.style.cssText = `font:inherit;color:inherit;background:rgba(255,255,255,.15);border:none;
    border-bottom:2px solid white;outline:none;padding:2px 4px;width:max(160px,${original.length}ch);
    max-width:100%;border-radius:3px 3px 0 0`;
  el.textContent = '';
  el.appendChild(input);
  input.focus(); input.select();
  const commit = () => {
    const val = input.value.trim() || original;
    siteSettings[key] = val;
    delete el.dataset.editing;
    el.removeChild(input);
    el.textContent = val;
    applySiteSettings();
    showToast(`‚úÖ ¬´${key}¬ª oppdatert`);
  };
  input.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); commit(); } if (e.key === 'Escape') { delete el.dataset.editing; el.removeChild(input); el.textContent = original; } });
  input.addEventListener('blur', commit);
}
// ============================================================
function formatCaps(u) {
  const capNames = {
    articles: 'Artikler', announcements: 'Beskjeder',
    categories: 'Kategorier', site: 'Nettsted', users: 'Brukere'
  };
  if (!u.caps) return roleCapabilities[u.role]?.label || u.role;
  const active = Object.entries(u.caps).filter(([,v]) => v).map(([k]) => capNames[k] || k);
  return active.length ? active.join(' ¬∑ ') : 'Ingen tilganger';
}

function getUserCaps(u) {
  // Explicitly set caps always win
  if (u.caps) return u.caps;
  // Built-in named roles keep their capabilities
  if (u.role === 'master') return roleCapabilities.master;
  if (u.role === 'okf')    return roleCapabilities.okf;
  if (u.role === 'hr')     return roleCapabilities.hr;
  // No caps set and no named role = portal-only
  return { articles: false, announcements: false, categories: false, site: false, users: false };
}

function renderUsersTable() {
  const tbody = document.getElementById('users-tbody');
  tbody.innerHTML = users.map(u => {
    const caps = getUserCaps(u);
    const isMasterProtected = u.username === 'master';
    const capBadges = [
      caps.articles      ? 'üìÑ Artikler' : null,
      caps.announcements ? 'üì¢ Beskjeder' : null,
      caps.categories    ? 'üóÇ Kategorier' : null,
      caps.site          ? 'üé® Nettsted' : null,
      caps.users         ? 'üë• Brukere' : null,
    ].filter(Boolean).map(t => `<span class="tag tag-blue" style="font-size:11px">${t}</span>`).join(' ');

    return `
    <tr id="user-row-${u.username}">
      <td><strong>${u.username}</strong></td>
      <td style="font-size:12px">${capBadges || '<span style="color:var(--ok-muted)">Ingen</span>'}</td>
      <td style="display:flex;gap:6px;align-items:center;flex-wrap:wrap">
        ${!isMasterProtected ? `
          <button class="cat-action-btn" onclick="openUserEdit('${u.username}')">Rediger</button>
          <span class="delete-link" onclick="deleteUser('${u.username}')">Slett</span>
        ` : '<span style="font-size:12px;color:var(--ok-muted)">Beskyttet</span>'}
      </td>
    </tr>`;
  }).join('');
}

function saveUser() {
  const name = document.getElementById('user-new-name').value.trim();
  const pass = document.getElementById('user-new-pass').value.trim();
  if (!name || !pass) { alert('Brukernavn og passord er p√•krevd'); return; }
  const caps = {
    articles:      document.getElementById('cap-articles').checked,
    announcements: document.getElementById('cap-announcements').checked,
    categories:    document.getElementById('cap-categories').checked,
    site:          document.getElementById('cap-site').checked,
    users:         document.getElementById('cap-users').checked,
  };
  const existing = users.findIndex(u => u.username === name);
  if (existing >= 0) {
    users[existing].password = pass;
    users[existing].caps     = caps;
    users[existing].role     = caps.users ? 'master' : 'okf';
    showToast(`‚úÖ Bruker ¬´${name}¬ª oppdatert`);
  } else {
    users.push({ username: name, password: pass, caps, role: caps.users ? 'master' : 'okf', label: name });
    showToast(`‚úÖ Bruker ¬´${name}¬ª opprettet`);
  }
  document.getElementById('user-new-name').value = '';
  document.getElementById('user-new-pass').value = '';
  // Default: no capabilities (portal-only user)
  document.getElementById('cap-articles').checked      = false;
  document.getElementById('cap-announcements').checked = false;
  document.getElementById('cap-categories').checked    = false;
  document.getElementById('cap-site').checked          = false;
  document.getElementById('cap-users').checked         = false;
  renderUsersTable();
}

function openUserEdit(username) {
  const u = users.find(x => x.username === username);
  if (!u) return;
  const caps = getUserCaps(u);
  document.getElementById('uedit-username').textContent = username;
  document.getElementById('uedit-name').value  = username;
  document.getElementById('uedit-pass').value  = '';
  document.getElementById('uedit-cap-articles').checked      = !!caps.articles;
  document.getElementById('uedit-cap-announcements').checked = !!caps.announcements;
  document.getElementById('uedit-cap-categories').checked    = !!caps.categories;
  document.getElementById('uedit-cap-site').checked          = !!caps.site;
  document.getElementById('uedit-cap-users').checked         = !!caps.users;
  document.getElementById('user-edit-modal').classList.add('show');
}
function closeUserEditModal() { document.getElementById('user-edit-modal').classList.remove('show'); }
function saveUserEdit() {
  const oldName = document.getElementById('uedit-name').value;
  const u = users.find(x => x.username === oldName);
  if (!u) return;
  const newPass = document.getElementById('uedit-pass').value.trim();
  if (newPass) u.password = newPass;
  u.caps = {
    articles:      document.getElementById('uedit-cap-articles').checked,
    announcements: document.getElementById('uedit-cap-announcements').checked,
    categories:    document.getElementById('uedit-cap-categories').checked,
    site:          document.getElementById('uedit-cap-site').checked,
    users:         document.getElementById('uedit-cap-users').checked,
  };
  u.role = u.caps.users ? 'master' : 'okf';
  closeUserEditModal();
  renderUsersTable();
  showToast(`‚úÖ Bruker ¬´${oldName}¬ª oppdatert`);
}

function previewRoleChange(username) {} // stub kept for compatibility
function saveInlineRole(username) {}    // stub kept for compatibility

// Profile modal
function openProfileModal() {
  if (!currentUser) return;
  document.getElementById('profile-username-display').textContent = currentUser.username;
  const caps = getUserCaps(currentUser);
  const capNames = { articles: 'üìÑ Artikler', announcements: 'üì¢ Beskjeder', categories: 'üóÇ Kategorier', site: 'üé® Nettsted', users: 'üë• Brukere' };
  document.getElementById('profile-caps-display').innerHTML = Object.entries(caps)
    .filter(([,v]) => v)
    .map(([k]) => `<span class="tag tag-blue" style="font-size:11px">${capNames[k]||k}</span>`)
    .join('');
  document.getElementById('profile-new-pass').value     = '';
  document.getElementById('profile-confirm-pass').value = '';
  const msg = document.getElementById('profile-msg');
  msg.style.display = 'none';
  document.getElementById('profile-modal').classList.add('show');
}
function closeProfileModal() { document.getElementById('profile-modal').classList.remove('show'); }
function saveProfilePassword() {
  const np = document.getElementById('profile-new-pass').value;
  const cp = document.getElementById('profile-confirm-pass').value;
  const msg = document.getElementById('profile-msg');
  if (!np) { showMsg(msg, 'Skriv inn et nytt passord.', 'warn'); return; }
  if (np !== cp) { showMsg(msg, 'Passordene stemmer ikke overens.', 'warn'); return; }
  if (np.length < 6) { showMsg(msg, 'Passordet m√• v√¶re minst 6 tegn.', 'warn'); return; }
  const u = users.find(x => x.username === currentUser.username);
  if (u) u.password = np;
  showMsg(msg, '‚úÖ Passord endret.', 'ok');
  document.getElementById('profile-new-pass').value     = '';
  document.getElementById('profile-confirm-pass').value = '';
}
function showMsg(el, text, type) {
  el.textContent = text;
  el.style.display = 'block';
  el.style.background = type === 'ok' ? '#e0f4ec' : '#fde8ec';
  el.style.color      = type === 'ok' ? 'var(--ok-green)' : 'var(--ok-red)';
}

function deleteUser(username) {
  if (username === currentUser?.username) { alert('Du kan ikke slette din egen bruker.'); return; }
  if (confirm(`Slett bruker ¬´${username}¬ª?`)) {
    users = users.filter(u => u.username !== username);
    renderUsersTable();
    logActivity('Bruker slettet: ' + username);
    showToast('üóë Bruker slettet');
  }
}

// ============================================================
//  AUTH
// ============================================================
function openLoginModal() {
  if (currentUser) { showPage('admin'); renderArticlesTable(); return; }
  document.getElementById('login-modal').classList.add('show');
  setTimeout(() => document.getElementById('login-user').focus(), 100);
}

function closeModal() {
  document.getElementById('login-modal').classList.remove('show');
  document.getElementById('login-err').style.display = 'none';
}

function doLogin() {
  const u = document.getElementById('login-user').value.trim().toLowerCase();
  const p = document.getElementById('login-pass').value;
  const found = users.find(x => x.username === u && x.password === p);
  if (found) {
    currentUser = found;
    const caps = getUserCaps(found);
    closeModal();

    const hasAnyAdminCap = caps.articles || caps.announcements || caps.categories || caps.site || caps.users;

    // Always show profile + logout in header
    document.getElementById('admin-nav-btn').style.display       = 'none';
    document.getElementById('header-profile-btn').style.display  = '';
    document.getElementById('header-logout-btn').style.display   = '';

    // Only show ‚öôÔ∏è Panel button if the user has at least one admin capability
    document.getElementById('admin-panel-btn').style.display = hasAnyAdminCap ? '' : 'none';

    // Announcements shortcut on home page
    document.getElementById('ann-admin-btn').style.display = caps.announcements ? 'block' : 'none';

    // Show/hide sidebar tabs based on individual caps
    document.getElementById('tab-btn-list').style.display          = caps.articles      ? 'flex' : 'none';
    document.getElementById('tab-btn-new').style.display           = caps.articles      ? 'flex' : 'none';
    document.getElementById('tab-btn-categories').style.display    = caps.categories    ? 'flex' : 'none';
    document.getElementById('tab-btn-announcements').style.display = caps.announcements ? 'flex' : 'none';
    document.getElementById('tab-btn-site').style.display          = caps.site          ? 'flex' : 'none';
    document.getElementById('tab-btn-users').style.display         = caps.users         ? 'flex' : 'none';

    // Section headers
    const contentSection = document.querySelector('.admin-sidebar-section');
    if (contentSection) contentSection.style.display = (caps.articles || caps.categories) ? 'block' : 'none';
    document.getElementById('master-section').style.display = (caps.site || caps.users) ? 'block' : 'none';

    // Update admin header identity
    document.getElementById('admin-user-label').textContent = `Innlogget som: ${found.username}`;
    const roleCap = roleCapabilities[found.role];
    document.getElementById('admin-role-badge').innerHTML =
      `<span class="role-badge ${roleCap?.badge || 'role-okf'}">${found.label || found.username}</span>`;

    renderActivityFooter();
    renderInlineEditors();

    if (hasAnyAdminCap) {
      // Send to admin panel, land on first available tab
      showPage('admin');
      if (caps.articles)      adminTab('list',          document.getElementById('tab-btn-list'));
      else if (caps.announcements) adminTab('announcements', document.getElementById('tab-btn-announcements'));
      else if (caps.categories)    adminTab('categories',    document.getElementById('tab-btn-categories'));
      else if (caps.site)          adminTab('site',          document.getElementById('tab-btn-site'));
      else if (caps.users)         adminTab('users',         document.getElementById('tab-btn-users'));
    } else {
      // Portal-only user ‚Äî stay on home page
      showPage('home');
      showToast(`‚úÖ Innlogget som ${found.username}`);
    }

    if (hasAnyAdminCap) showToast(`‚úÖ Innlogget som ${found.username}`);
  } else {
    document.getElementById('login-err').style.display = 'block';
  }
}

function logout() {
  currentUser = null;
  // Header nav
  document.getElementById('admin-nav-btn').style.display      = '';
  document.getElementById('header-profile-btn').style.display = 'none';
  document.getElementById('admin-panel-btn').style.display    = 'none';
  document.getElementById('header-logout-btn').style.display  = 'none';
  document.getElementById('ann-admin-btn').style.display      = 'none';
  // Restore all sidebar tabs to default visible state
  ['tab-btn-list','tab-btn-new','tab-btn-categories','tab-btn-announcements'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.style.display = 'flex';
  });
  document.getElementById('tab-btn-edit').style.display   = 'none';
  document.getElementById('tab-btn-site').style.display   = 'none';
  document.getElementById('tab-btn-users').style.display  = 'none';
  document.getElementById('master-section').style.display = 'none';
  const contentSection = document.querySelector('.admin-sidebar-section');
  if (contentSection) contentSection.style.display = 'block';
  renderActivityFooter();
  renderInlineEditors();
  showPage('home');
  showToast('Du er n√• logget ut');
}

// ============================================================
//  RICH TEXT EDITOR
// ============================================================
function rteCmd(which, cmd) {
  document.getElementById('rte-' + which).focus();
  document.execCommand(cmd, false, null);
}
function rteHeading(which) {
  const editor = document.getElementById('rte-' + which);
  editor.focus();
  const sel = window.getSelection();
  if (sel.rangeCount) {
    const range = sel.getRangeAt(0);
    const h3 = document.createElement('h3');
    h3.appendChild(range.extractContents());
    range.insertNode(h3);
    range.setStartAfter(h3); range.collapse(true);
    sel.removeAllRanges(); sel.addRange(range);
  }
}
function rteInsertBox(which, type) {
  const editor = document.getElementById('rte-' + which);
  editor.focus();
  const cls = type === 'info' ? 'info-box' : 'warn-box';
  const prefix = type === 'info' ? 'üìå ' : '‚ö†Ô∏è ';
  const div = document.createElement('div');
  div.className = cls;
  div.innerHTML = prefix + 'Skriv tekst her...';
  div.contentEditable = 'true';
  const sel = window.getSelection();
  if (sel.rangeCount) {
    const range = sel.getRangeAt(0);
    range.collapse(false);
    range.insertNode(div);
    range.setStartAfter(div); range.collapse(true);
    sel.removeAllRanges(); sel.addRange(range);
  } else {
    editor.appendChild(div);
  }
}

// ============================================================
//  BLOCK PANEL ‚Äì inline avsnittorganisering
// ============================================================
// Assigns each top-level child of the editor a stable data-bid attribute
// so we can track identity across re-renders.
let _bidCounter = 0;
function ensureBids(editor) {
  Array.from(editor.children).forEach(el => {
    if (!el.dataset.bid) el.dataset.bid = ++_bidCounter;
  });
}

function getBlockMeta(el) {
  const tag = el.tagName ? el.tagName.toLowerCase() : '';
  const cls = el.className || '';
  const text = (el.textContent || '').trim().replace(/\s+/g, ' ').substring(0, 55);
  if (cls.includes('calc-box'))     return { icon: 'üßÆ', type: 'Kalkulator', label: 'Feriekalkulator' };
  if (cls.includes('info-box'))     return { icon: '‚ÑπÔ∏è', type: 'Inforamme',  label: text || 'Inforamme' };
  if (cls.includes('warn-box'))     return { icon: '‚ö†Ô∏è', type: 'Advarsel',   label: text || 'Advarselboks' };
  if (tag === 'h3')                 return { icon: 'üî†', type: 'Overskrift', label: text || 'Overskrift' };
  if (tag === 'ul' || tag === 'ol') return { icon: 'üìã', type: 'Liste',      label: text || 'Listeelement' };
  if (tag === 'table')              return { icon: 'üóÉ', type: 'Tabell',     label: text || 'Tabell' };
  return                                   { icon: '¬∂',  type: 'Avsnitt',    label: text || '(tomt avsnitt)' };
}

function toggleBlockPanel(which) {
  const panel  = document.getElementById('block-panel-' + which);
  const btn    = document.getElementById('block-panel-btn-' + which);
  const editor = document.getElementById('rte-' + which);
  if (!panel || !editor) return;

  const isOpen = panel.style.display !== 'none';
  if (isOpen) {
    panel.style.display = 'none';
    btn.style.background = '';
    btn.style.color = '';
  } else {
    renderBlockPanel(which);
    panel.style.display = 'flex';
    btn.style.background = 'var(--ok-blue)';
    btn.style.color = 'white';
  }
}

function renderBlockPanel(which) {
  const panel  = document.getElementById('block-panel-' + which);
  const editor = document.getElementById('rte-' + which);
  if (!panel || !editor) return;

  ensureBids(editor);
  const blocks = Array.from(editor.children).filter(el => el.nodeType === 1);
  if (blocks.length === 0) {
    panel.innerHTML = '<div class="block-panel-header">Ingen avsnitt enn√• ‚Äî skriv noe i editoren f√∏rst.</div>';
    return;
  }

  panel.innerHTML = '<div class="block-panel-header">‚áÖ Klikk ‚Üë ‚Üì for √• flytte et avsnitt opp eller ned. Endringer skjer umiddelbart i editoren.</div>' +
    blocks.map((el, i) => {
      const { icon, type, label } = getBlockMeta(el);
      const safe = label.replace(/</g, '&lt;').replace(/>/g, '&gt;');
      return `
      <div class="block-row" id="brow-${which}-${i}">
        <button class="block-move-btn" onclick="blockPanelMove('${which}',${i},-1)" ${i === 0 ? 'disabled' : ''} title="Flytt opp">‚Üë</button>
        <button class="block-move-btn" onclick="blockPanelMove('${which}',${i},1)"  ${i === blocks.length - 1 ? 'disabled' : ''} title="Flytt ned">‚Üì</button>
        <span class="block-type-tag">${icon} ${type}</span>
        <span class="block-preview">${safe || '<em style="color:var(--ok-muted)">tomt avsnitt</em>'}</span>
      </div>`;
    }).join('');
}

function blockPanelMove(which, idx, dir) {
  const editor = document.getElementById('rte-' + which);
  if (!editor) return;
  const blocks = Array.from(editor.children).filter(el => el.nodeType === 1);
  const newIdx = idx + dir;
  if (newIdx < 0 || newIdx >= blocks.length) return;

  // Swap the two DOM nodes live ‚Äî no need for apply step
  const a = blocks[idx];
  const b = blocks[newIdx];
  if (dir === -1) {
    editor.insertBefore(a, b);   // move a before b
  } else {
    editor.insertBefore(b, a);   // move b before a
  }

  // Re-render the panel to reflect new order
  renderBlockPanel(which);

  // Flash highlight the moved row
  const newRow = document.getElementById('brow-' + which + '-' + idx);
  if (newRow) {
    newRow.classList.add('block-active');
    setTimeout(() => newRow.classList.remove('block-active'), 600);
  }
}

// ============================================================
//  CATEGORIES ‚Äì CARD GRID
// ============================================================
function renderCardGrid() {
  const grid = document.getElementById('card-grid');
  if (!grid) return;
  grid.innerHTML = categories.map(c => `
    <div class="card" onclick="openArticle('${c.link}')">
      <div class="card-icon" style="background:${c.color}">${c.icon}</div>
      <h3>${c.title}</h3>
      <p>${c.desc}</p>
    </div>`).join('');
}

function renderCatAdmin() {
  const list = document.getElementById('cat-list');
  if (!list) return;

  if (categories.length === 0) {
    list.innerHTML = '<p style="font-size:13px;color:var(--ok-muted);padding:8px 0">Ingen fremhevede artikler enn√•. Legg til en nedenfor.</p>';
  } else {
    list.innerHTML = categories.map((c, i) => `
      <div class="cat-item" draggable="true" data-id="${c.id}"
           ondragstart="catDragStart(event,'${c.id}')"
           ondragover="catDragOver(event)"
           ondrop="catDrop(event,'${c.id}')"
           ondragleave="catDragLeave(event)">
        <span class="cat-drag-handle">‚†ø</span>
        <div class="cat-icon-preview" style="background:${c.color}">${c.icon}</div>
        <div class="cat-item-info">
          <strong>${c.title}</strong>
          <span>${c.desc}</span>
        </div>
        <div class="cat-item-actions">
          <button class="cat-action-btn" onclick="openCatEdit('${c.id}')">Endre ikon</button>
          <button class="cat-action-btn danger" onclick="deleteCategory('${c.id}')">Fjern</button>
        </div>
      </div>`).join('');
  }

  // Build icon + color pickers only once
  if (!document.getElementById('cat-new-icon-picker').dataset.built) {
    buildIconPicker('cat-new-icon-picker', 'cat-new-icon-val', 'üìÑ');
    buildColorPicker('cat-new-color-picker', 'cat-new-color-val', '#e0e8f7');
    document.getElementById('cat-new-icon-val').value  = 'üìÑ';
    document.getElementById('cat-new-color-val').value = '#e0e8f7';
    document.getElementById('cat-new-icon-picker').dataset.built = '1';
  }
}

// ‚îÄ‚îÄ Article search for featured panel ‚îÄ‚îÄ
function featSearch() {
  const q = document.getElementById('feat-search').value.trim().toLowerCase();
  const resultsEl = document.getElementById('feat-search-results');
  if (!q) { resultsEl.style.display = 'none'; return; }

  const alreadyFeatured = new Set(categories.map(c => c.link));
  const matches = articles.filter(a => {
    const hay = (a.title + ' ' + a.tags.join(' ')).toLowerCase();
    return hay.includes(q);
  });

  if (matches.length === 0) {
    resultsEl.innerHTML = '<div style="padding:10px 14px;font-size:13px;color:var(--ok-muted)">Ingen artikler funnet</div>';
  } else {
    resultsEl.innerHTML = matches.map(a => {
      const isFeatured = alreadyFeatured.has(a.id);
      return `<div onclick="${isFeatured ? '' : `selectFeatArticle('${a.id}','${a.title.replace(/'/g,"\\'")}','${a.tags[0] || ''}')`}"
        style="padding:10px 14px;cursor:${isFeatured ? 'default' : 'pointer'};border-bottom:1px solid var(--ok-border);
               font-size:13px;display:flex;align-items:center;justify-content:space-between;
               ${isFeatured ? 'opacity:.5' : 'hover:background:var(--ok-accent)'}">
        <span><strong>${a.title}</strong><br><span style="font-size:11.5px;color:var(--ok-muted)">${a.tags.slice(0,3).join(' ¬∑ ')}</span></span>
        ${isFeatured ? '<span style="font-size:11px;color:var(--ok-blue);font-weight:600">Allerede fremhevet</span>' : '<span style="font-size:11px;color:var(--ok-green)">Velg ‚Üí</span>'}
      </div>`;
    }).join('');
  }
  resultsEl.style.display = 'block';
}

function selectFeatArticle(id, title, tag) {
  document.getElementById('feat-search').value = title;
  document.getElementById('feat-selected-id').value = id;
  document.getElementById('feat-selected-label').textContent = title;
  const selBox = document.getElementById('feat-selected-article');
  selBox.style.display = 'block';
  document.getElementById('feat-search-results').style.display = 'none';
}

function addFeatured() {
  const articleId = document.getElementById('feat-selected-id').value.trim();
  if (!articleId) { showToast('‚ö†Ô∏è Velg en artikkel fra s√∏ket f√∏rst'); return; }

  if (categories.find(c => c.link === articleId)) {
    showToast('‚ö†Ô∏è Denne artikkelen er allerede fremhevet'); return;
  }

  const article = articles.find(a => a.id === articleId);
  if (!article) { showToast('Artikkel ikke funnet'); return; }

  categories.push({
    id: 'cat_' + Date.now(),
    icon:  document.getElementById('cat-new-icon-val').value  || 'üìÑ',
    color: document.getElementById('cat-new-color-val').value || '#e0e8f7',
    title: article.title,
    desc:  stripTags(article.body).substring(0, 100) + '‚Ä¶',
    link:  article.id
  });

  // Reset form
  document.getElementById('feat-search').value = '';
  document.getElementById('feat-selected-id').value = '';
  document.getElementById('feat-selected-label').textContent = '';
  document.getElementById('feat-selected-article').style.display = 'none';
  document.getElementById('feat-search-results').style.display = 'none';
  document.getElementById('cat-new-icon-picker').dataset.built = '';
  buildIconPicker('cat-new-icon-picker', 'cat-new-icon-val', 'üìÑ');
  buildColorPicker('cat-new-color-picker', 'cat-new-color-val', '#e0e8f7');
  document.getElementById('cat-new-icon-val').value  = 'üìÑ';
  document.getElementById('cat-new-color-val').value = '#e0e8f7';
  document.getElementById('cat-new-icon-picker').dataset.built = '1';

  renderCardGrid();
  renderCatAdmin();
  recordActivity(`fremhevet artikkel ¬´${article.title}¬ª`);
  showToast(`‚≠ê ¬´${article.title}¬ª er n√• fremhevet p√• forsiden`);
}

function buildIconPicker(pickerId, valId, current) {
  const el = document.getElementById(pickerId);
  if (!el) return;
  el.innerHTML = ICONS.map(ic => `
    <div class="icon-opt${ic === current ? ' selected' : ''}"
         data-val="${ic}" data-picker="${pickerId}" data-target="${valId}"
         onclick="selectIcon(this)">${ic}</div>
  `).join('');
}
function buildColorPicker(pickerId, valId, current) {
  const el = document.getElementById(pickerId);
  if (!el) return;
  el.innerHTML = COLORS.map(cl => `
    <div class="color-opt${cl === current ? ' selected' : ''}"
         style="background:${cl}" data-val="${cl}" data-picker="${pickerId}" data-target="${valId}"
         onclick="selectColor(this)"></div>
  `).join('');
}
function selectIcon(el) {
  const pickerId = el.dataset.picker;
  const valId    = el.dataset.target;
  document.getElementById(valId).value = el.dataset.val;
  document.querySelectorAll('#' + pickerId + ' .icon-opt').forEach(e => e.classList.remove('selected'));
  el.classList.add('selected');
}
function selectColor(el) {
  const pickerId = el.dataset.picker;
  const valId    = el.dataset.target;
  document.getElementById(valId).value = el.dataset.val;
  document.querySelectorAll('#' + pickerId + ' .color-opt').forEach(e => e.classList.remove('selected'));
  el.classList.add('selected');
}

function deleteCategory(id) {
  if (!confirm('Fjerne denne artikkelen fra fremhevede?')) return;
  const c = categories.find(x => x.id === id);
  categories = categories.filter(c => c.id !== id);
  renderCardGrid();
  renderCatAdmin();
  showToast('üóë Artikkel fjernet fra fremhevede');
}

function openCatEdit(id) {
  const c = categories.find(x => x.id === id);
  if (!c) return;
  document.getElementById('cat-edit-id').value = c.id;
  document.getElementById('cat-edit-article-label').textContent = c.title;
  buildIconPicker('cat-edit-icon-picker', 'cat-edit-icon-val', c.icon);
  document.getElementById('cat-edit-icon-val').value  = c.icon;
  buildColorPicker('cat-edit-color-picker', 'cat-edit-color-val', c.color);
  document.getElementById('cat-edit-color-val').value = c.color;
  document.getElementById('cat-edit-modal').classList.add('show');
}
function closeCatEditModal() { document.getElementById('cat-edit-modal').classList.remove('show'); }
function saveCatEdit() {
  const id = document.getElementById('cat-edit-id').value;
  const c = categories.find(x => x.id === id);
  if (!c) return;
  c.icon  = document.getElementById('cat-edit-icon-val').value;
  c.color = document.getElementById('cat-edit-color-val').value;
  closeCatEditModal();
  renderCardGrid();
  renderCatAdmin();
  recordActivity(`endret ikon p√• ¬´${c.title}¬ª`);
  showToast('‚úÖ Ikon oppdatert');
}

// ‚îÄ‚îÄ Drag & drop reorder ‚îÄ‚îÄ
let dragSrcId = null;
function catDragStart(e, id) { dragSrcId = id; e.target.classList.add('dragging'); e.dataTransfer.effectAllowed = 'move'; }
function catDragOver(e) { e.preventDefault(); e.currentTarget.classList.add('drag-over'); return false; }
function catDragLeave(e) { e.currentTarget.classList.remove('drag-over'); }
function catDrop(e, targetId) {
  e.stopPropagation(); e.preventDefault();
  e.currentTarget.classList.remove('drag-over');
  if (dragSrcId === targetId) return;
  const srcIdx = categories.findIndex(c => c.id === dragSrcId);
  const tgtIdx = categories.findIndex(c => c.id === targetId);
  const [moved] = categories.splice(srcIdx, 1);
  categories.splice(tgtIdx, 0, moved);
  renderCardGrid();
  renderCatAdmin();
  saveToStorage();
}

// ============================================================
//  ANNOUNCEMENT EDIT
// ============================================================
function openAnnEdit(id) {
  const a = announcements.find(x => x.id === id);
  if (!a) return;
  document.getElementById('ann-edit-id').value     = a.id;
  document.getElementById('ann-edit-title').value  = a.title;
  document.getElementById('ann-edit-body').value   = a.body;
  document.getElementById('ann-edit-type').value   = a.type;
  document.getElementById('ann-edit-author').value = a.author;
  document.getElementById('ann-edit-modal').classList.add('show');
}
function closeAnnEditModal() { document.getElementById('ann-edit-modal').classList.remove('show'); }
function saveAnnEdit() {
  const id = document.getElementById('ann-edit-id').value;
  const a = announcements.find(x => x.id === id);
  if (!a) return;
  a.title  = document.getElementById('ann-edit-title').value;
  a.body   = document.getElementById('ann-edit-body').value;
  a.type   = document.getElementById('ann-edit-type').value;
  a.author = document.getElementById('ann-edit-author').value;
  closeAnnEditModal();
  renderAnnouncements();
  renderAnnAdminList();
  recordActivity(`redigerte beskjed ¬´${a.title}¬ª`);
  showToast('‚úÖ Beskjed oppdatert');
  logActivity('Beskjed redigert: ' + a.title);
}

// ============================================================
//  ACTIVITY LOG
// ============================================================
let lastActivity = null; // { user, action, time }

function recordActivity(action) {
  const now = new Date();
  const timeStr = now.toLocaleDateString('nb-NO') + ' kl. ' + now.toLocaleTimeString('nb-NO', { hour: '2-digit', minute: '2-digit' });
  lastActivity = { user: currentUser?.username || 'ukjent', action, time: timeStr };
  renderActivityFooter();
}

function renderActivityFooter() {
  const el = document.getElementById('footer-activity');
  if (!el || !lastActivity) return;
  const isLoggedIn = !!currentUser;
  if (isLoggedIn) {
    el.textContent = `üïê Sist oppdatert: ${lastActivity.time} av ${lastActivity.user} (${lastActivity.action})`;
  } else {
    el.textContent = `üïê Sist oppdatert: ${lastActivity.time}`;
  }
  el.style.display = 'block';
}

// ============================================================
//  ACTIVITY LOG ‚Äì sist oppdatert
// ============================================================
let activityLog = []; // { time, action, user }

function logActivity(action) {
  if (!currentUser) return;
  const now = new Date();
  const timeStr = now.toLocaleDateString('nb-NO') + ' kl. ' + now.toLocaleTimeString('nb-NO', { hour: '2-digit', minute: '2-digit' });
  const entry = { time: timeStr, action, user: currentUser.username, role: currentUser.role };
  activityLog.unshift(entry);
  if (activityLog.length > 50) activityLog.pop();
  updateLastUpdatedBar();
}

function updateLastUpdatedBar() {
  if (!currentUser || activityLog.length === 0) return;
  const bar = document.getElementById('last-updated-bar');
  const textEl = document.getElementById('last-updated-text');
  const whoEl  = document.getElementById('last-updated-who');
  if (!bar) return;
  const latest = activityLog[0];
  bar.style.display = 'flex';
  textEl.textContent = 'üïê Sist oppdatert: ' + latest.time + ' ‚Äì ' + latest.action;
  // All logged-in roles (okf, hr, master) can see who updated
  whoEl.textContent = 'av ' + latest.user + ' (' + roleCapabilities[latest.role]?.label + ')';
}

// ============================================================
//  TOAST
// ============================================================
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
  // Auto-save on any action that shows a toast (except warnings/login/logout)
  const skip = ['‚ö†Ô∏è', 'Logg', 'Innlogget', 'Passord', 'Allerede'];
  if (!skip.some(s => msg.startsWith(s))) {
    saveToStorage();
  }
}

// ============================================================
//  LOCALSTORAGE PERSISTENCE
// ============================================================
const LS_KEY = 'ferieportalen_v1';

function saveToStorage() {
  try {
    localStorage.setItem(LS_KEY, JSON.stringify({
      articles,
      categories,
      users,
      announcements,
      siteSettings,
    }));
  } catch(e) {
    console.warn('localStorage ikke tilgjengelig:', e);
  }
}

function loadFromStorage() {
  try {
    const raw = localStorage.getItem(LS_KEY);
    if (!raw) return false;
    const data = JSON.parse(raw);
    if (data.articles)      articles      = data.articles;
    if (data.categories)    categories    = data.categories;
    if (data.users)         users         = data.users;
    if (data.announcements) announcements = data.announcements;
    if (data.siteSettings)  Object.assign(siteSettings, data.siteSettings);
    return true;
  } catch(e) {
    console.warn('Feil ved lasting fra localStorage:', e);
    return false;
  }
}

function resetStorage() {
  if (!confirm('Dette sletter alle dine endringer og tilbakestiller portalen til original innhold. Er du sikker?')) return;
  localStorage.removeItem(LS_KEY);
  location.reload();
}

// ============================================================
//  INIT
// ============================================================
loadFromStorage();
applySiteSettings();
renderArticlesTable();
renderAnnouncements();
renderCardGrid();
renderRecentArticles();
</script>
</body>
</html>
