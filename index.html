<!DOCTYPE html>
<html lang="no">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ferieportalen ‚Äì Oslo Kommune</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Source+Serif+4:wght@300;400;600&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --ok-blue: #003087;
    --ok-red: #C8102E;
    --ok-light: #f5f6fa;
    --ok-border: #dde1ea;
    --ok-text: #1a1d2e;
    --ok-muted: #6b7080;
    --ok-card: #ffffff;
    --ok-accent: #e8ecf7;
    --ok-green: #1a7a4a;
    --ok-yellow: #f4a900;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--ok-light);
    color: var(--ok-text);
    min-height: 100vh;
  }

  /* ‚îÄ‚îÄ TOP BAR ‚îÄ‚îÄ */
  .topbar {
    background: var(--ok-blue);
    color: white;
    font-size: 12px;
    padding: 6px 24px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .topbar a { color: rgba(255,255,255,0.75); text-decoration: none; }
  .topbar a:hover { color: white; }

  /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
  header {
    background: white;
    border-bottom: 3px solid var(--ok-blue);
    padding: 0 24px;
  }
  .header-inner {
    max-width: 1100px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 0;
  }
  .logo-area { display: flex; align-items: center; gap: 14px; }
  .logo-shield {
    width: 44px; height: 44px;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
  }
  .logo-text h1 {
    font-family: 'Source Serif 4', serif;
    font-size: 20px;
    font-weight: 600;
    color: var(--ok-blue);
    line-height: 1.1;
  }
  .logo-text span {
    font-size: 11px;
    color: var(--ok-muted);
    font-weight: 300;
    text-transform: uppercase;
    letter-spacing: 1px;
  }
  nav { display: flex; gap: 8px; align-items: center; }
  nav button {
    background: none;
    border: 1px solid var(--ok-border);
    border-radius: 6px;
    padding: 7px 14px;
    font-size: 13px;
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
    color: var(--ok-text);
    transition: all .15s;
  }
  nav button:hover { background: var(--ok-accent); border-color: var(--ok-blue); }
  nav button.admin-btn {
    background: var(--ok-blue);
    color: white;
    border-color: var(--ok-blue);
  }
  nav button.admin-btn:hover { background: #00246b; }
  nav button.logout-btn {
    background: var(--ok-red);
    color: white;
    border-color: var(--ok-red);
  }

  /* ‚îÄ‚îÄ PAGES ‚îÄ‚îÄ */
  .page { display: none; }
  .page.active { display: block; }

  /* ‚îÄ‚îÄ HERO / SEARCH ‚îÄ‚îÄ */
  .hero {
    max-width: 700px;
    margin: 60px auto 40px;
    text-align: center;
    padding: 0 16px;
  }
  .hero h2 {
    font-family: 'Source Serif 4', serif;
    font-size: 32px;
    font-weight: 300;
    color: var(--ok-blue);
    margin-bottom: 8px;
  }
  .hero p {
    color: var(--ok-muted);
    font-size: 15px;
    margin-bottom: 28px;
  }
  .search-box {
    display: flex;
    background: white;
    border: 2px solid var(--ok-border);
    border-radius: 40px;
    overflow: hidden;
    box-shadow: 0 2px 16px rgba(0,48,135,.08);
    transition: border-color .2s;
  }
  .search-box:focus-within { border-color: var(--ok-blue); }
  .search-box input {
    flex: 1;
    border: none;
    outline: none;
    padding: 14px 22px;
    font-size: 16px;
    font-family: 'DM Sans', sans-serif;
    background: transparent;
  }
  .search-box button {
    background: var(--ok-blue);
    color: white;
    border: none;
    padding: 14px 26px;
    font-size: 15px;
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
    font-weight: 500;
    border-radius: 0 38px 38px 0;
    transition: background .15s;
  }
  .search-box button:hover { background: #00246b; }

  /* Quick filters */
  .quick-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    justify-content: center;
    margin-top: 16px;
  }
  .quick-tags button {
    background: white;
    border: 1px solid var(--ok-border);
    border-radius: 20px;
    padding: 5px 14px;
    font-size: 13px;
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
    color: var(--ok-blue);
    transition: all .15s;
  }
  .quick-tags button:hover {
    background: var(--ok-blue);
    color: white;
    border-color: var(--ok-blue);
  }

  /* ‚îÄ‚îÄ HOME LAYOUT (main + sidebar) ‚îÄ‚îÄ */
  .home-layout {
    max-width: 1200px;
    margin: 0 auto 60px;
    padding: 0 16px;
    display: grid;
    grid-template-columns: 1fr 300px;
    gap: 28px;
    align-items: start;
  }

  /* ‚îÄ‚îÄ ANNOUNCEMENTS PANEL ‚îÄ‚îÄ */
  .announcements-panel {
    background: white;
    border: 1px solid var(--ok-border);
    border-radius: 10px;
    overflow: hidden;
    position: sticky;
    top: 16px;
  }
  .ann-header {
    background: var(--ok-blue);
    color: white;
    padding: 12px 16px;
    font-size: 13.5px;
    font-weight: 500;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .ann-header span { font-size: 11px; opacity: .75; }
  .ann-list { padding: 0; }
  .ann-item {
    padding: 14px 16px;
    border-bottom: 1px solid var(--ok-border);
    font-size: 13px;
    line-height: 1.55;
  }
  .ann-item:last-child { border-bottom: none; }
  .ann-item-title {
    font-weight: 500;
    color: var(--ok-text);
    margin-bottom: 4px;
    display: flex;
    align-items: flex-start;
    gap: 6px;
  }
  .ann-item-body { color: var(--ok-muted); font-size: 12.5px; }
  .ann-item-meta { font-size: 11px; color: #aab0c0; margin-top: 5px; }
  .ann-badge {
    font-size: 10px;
    padding: 2px 7px;
    border-radius: 10px;
    font-weight: 600;
    white-space: nowrap;
    margin-top: 1px;
  }
  .ann-badge-red { background: #fde8ec; color: var(--ok-red); }
  .ann-badge-blue { background: #e0e8f7; color: var(--ok-blue); }
  .ann-badge-green { background: #e0f4ec; color: var(--ok-green); }
  .ann-badge-yellow { background: #fef3d8; color: #7a5200; }
  .ann-empty { padding: 20px 16px; font-size: 13px; color: var(--ok-muted); text-align: center; }
  .ann-admin-btn {
    display: block;
    width: 100%;
    background: var(--ok-accent);
    border: none;
    border-top: 1px solid var(--ok-border);
    padding: 10px;
    font-size: 12.5px;
    color: var(--ok-blue);
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
    transition: background .15s;
  }
  .ann-admin-btn:hover { background: #d4dcf0; }

  /* ‚îÄ‚îÄ CATEGORIES ‚îÄ‚îÄ */
  .categories {
    margin: 0;
  }
  .section-title {
    font-family: 'Source Serif 4', serif;
    font-size: 18px;
    font-weight: 400;
    color: var(--ok-blue);
    margin-bottom: 16px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--ok-border);
  }
  .card-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
    gap: 16px;
  }
  .card {
    background: white;
    border: 1px solid var(--ok-border);
    border-radius: 10px;
    padding: 22px 20px;
    cursor: pointer;
    transition: all .2s;
    text-align: left;
  }
  .card:hover {
    border-color: var(--ok-blue);
    box-shadow: 0 4px 16px rgba(0,48,135,.1);
    transform: translateY(-2px);
  }
  .card-icon {
    width: 38px; height: 38px;
    border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    font-size: 18px;
    margin-bottom: 12px;
  }
  .card h3 {
    font-size: 15px;
    font-weight: 500;
    margin-bottom: 5px;
  }
  .card p {
    font-size: 12.5px;
    color: var(--ok-muted);
    line-height: 1.5;
  }

  /* ‚îÄ‚îÄ FERIEKALKULATOR ‚îÄ‚îÄ */
  .calc-box {
    background: linear-gradient(135deg, #f0f4ff 0%, #e8f0fe 100%);
    border: 1.5px solid #c5d3f0;
    border-radius: 12px;
    padding: 24px 26px;
    margin: 28px 0;
  }
  .calc-box h3 {
    font-family: 'Source Serif 4', serif;
    font-size: 17px;
    color: var(--ok-blue);
    margin-bottom: 18px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .calc-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 14px;
    margin-bottom: 18px;
  }
  .calc-field label {
    display: block;
    font-size: 12px;
    font-weight: 500;
    color: var(--ok-muted);
    text-transform: uppercase;
    letter-spacing: .5px;
    margin-bottom: 5px;
  }
  .calc-field input, .calc-field select {
    width: 100%;
    border: 1px solid #c5d3f0;
    border-radius: 7px;
    padding: 9px 12px;
    font-size: 14px;
    font-family: 'DM Sans', sans-serif;
    background: white;
    outline: none;
    transition: border-color .15s;
  }
  .calc-field input:focus, .calc-field select:focus { border-color: var(--ok-blue); }
  .calc-run-btn {
    background: var(--ok-blue);
    color: white;
    border: none;
    padding: 10px 24px;
    border-radius: 7px;
    font-size: 14px;
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
    font-weight: 500;
    transition: background .15s;
  }
  .calc-run-btn:hover { background: #00246b; }
  .calc-result {
    display: none;
    margin-top: 18px;
    background: white;
    border-radius: 8px;
    padding: 18px 20px;
    border: 1px solid #c5d3f0;
  }
  .calc-result.show { display: block; }
  .calc-result-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 12px;
    margin-bottom: 14px;
  }
  .calc-stat {
    background: var(--ok-accent);
    border-radius: 8px;
    padding: 12px 14px;
  }
  .calc-stat .cs-label { font-size: 11px; color: var(--ok-muted); text-transform: uppercase; letter-spacing: .5px; margin-bottom: 4px; }
  .calc-stat .cs-value { font-size: 22px; font-weight: 600; color: var(--ok-blue); }
  .calc-stat .cs-sub { font-size: 11.5px; color: var(--ok-muted); margin-top: 2px; }
  .calc-note { font-size: 12px; color: var(--ok-muted); border-top: 1px solid var(--ok-border); padding-top: 10px; }

  /* ‚îÄ‚îÄ SEARCH RESULTS ‚îÄ‚îÄ */
  .results-wrap {
    max-width: 860px;
    margin: 0 auto;
    padding: 0 16px 60px;
  }
  .results-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }
  .results-header h3 {
    font-family: 'Source Serif 4', serif;
    font-size: 18px;
    font-weight: 400;
    color: var(--ok-text);
  }
  .results-header span { font-size: 13px; color: var(--ok-muted); }

  .result-item {
    background: white;
    border: 1px solid var(--ok-border);
    border-radius: 10px;
    padding: 20px 24px;
    margin-bottom: 12px;
    cursor: pointer;
    transition: border-color .15s;
  }
  .result-item:hover { border-color: var(--ok-blue); }
  .result-item h4 { font-size: 16px; font-weight: 500; color: var(--ok-blue); margin-bottom: 6px; }
  .result-item p { font-size: 13.5px; color: var(--ok-muted); line-height: 1.6; }
  .result-meta {
    display: flex; gap: 10px; margin-top: 10px;
    flex-wrap: wrap;
  }
  .tag {
    font-size: 11px;
    padding: 3px 10px;
    border-radius: 12px;
    font-weight: 500;
  }
  .tag-blue { background: #e0e8f7; color: var(--ok-blue); }
  .tag-green { background: #e0f4ec; color: var(--ok-green); }
  .tag-yellow { background: #fef3d8; color: #8a5e00; }
  .tag-red { background: #fde8ec; color: var(--ok-red); }

  /* ‚îÄ‚îÄ ARTICLE VIEW ‚îÄ‚îÄ */
  .article-wrap {
    max-width: 780px;
    margin: 0 auto;
    padding: 0 16px 80px;
  }
  .breadcrumb {
    font-size: 12.5px;
    color: var(--ok-muted);
    margin-bottom: 24px;
    display: flex; gap: 6px; align-items: center;
  }
  .breadcrumb a { color: var(--ok-blue); text-decoration: none; cursor: pointer; }
  .breadcrumb a:hover { text-decoration: underline; }
  .article-header {
    margin-bottom: 32px;
    padding-bottom: 20px;
    border-bottom: 2px solid var(--ok-blue);
  }
  .article-header h2 {
    font-family: 'Source Serif 4', serif;
    font-size: 28px;
    font-weight: 400;
    color: var(--ok-blue);
    margin-bottom: 10px;
  }
  .article-meta { font-size: 12.5px; color: var(--ok-muted); display: flex; gap: 16px; flex-wrap: wrap; }
  .article-body { font-size: 15px; line-height: 1.75; color: var(--ok-text); }
  .article-body h3 {
    font-family: 'Source Serif 4', serif;
    font-size: 18px;
    font-weight: 600;
    color: var(--ok-blue);
    margin: 28px 0 10px;
  }
  .article-body p { margin-bottom: 14px; }
  .article-body ul { margin: 10px 0 14px 20px; }
  .article-body li { margin-bottom: 6px; line-height: 1.65; }
  .info-box {
    background: var(--ok-accent);
    border-left: 4px solid var(--ok-blue);
    border-radius: 0 8px 8px 0;
    padding: 14px 18px;
    margin: 18px 0;
    font-size: 14px;
  }
  .warn-box {
    background: #fef3d8;
    border-left: 4px solid var(--ok-yellow);
    border-radius: 0 8px 8px 0;
    padding: 14px 18px;
    margin: 18px 0;
    font-size: 14px;
  }
  .source-box {
    background: #f0f0f5;
    border-radius: 8px;
    padding: 14px 18px;
    margin-top: 30px;
    font-size: 12.5px;
    color: var(--ok-muted);
  }
  .source-box strong { color: var(--ok-text); }

  /* ‚îÄ‚îÄ ADMIN PANEL ‚îÄ‚îÄ */
  .admin-wrap {
    max-width: 1000px;
    margin: 0 auto;
    padding: 0 16px 80px;
  }
  .admin-header {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 28px;
    padding-bottom: 16px;
    border-bottom: 2px solid var(--ok-blue);
  }
  .admin-header h2 {
    font-family: 'Source Serif 4', serif;
    font-size: 24px;
    font-weight: 400;
    color: var(--ok-blue);
  }
  .admin-grid { display: grid; grid-template-columns: 280px 1fr; gap: 20px; }
  .admin-sidebar { background: white; border: 1px solid var(--ok-border); border-radius: 10px; overflow: hidden; height: fit-content; }
  .admin-sidebar-item {
    padding: 12px 18px;
    font-size: 14px;
    cursor: pointer;
    border-bottom: 1px solid var(--ok-border);
    transition: background .1s;
    display: flex; justify-content: space-between; align-items: center;
  }
  .admin-sidebar-item:hover { background: var(--ok-accent); }
  .admin-sidebar-item.active { background: var(--ok-blue); color: white; }
  .admin-sidebar-item:last-child { border-bottom: none; }
  .admin-main { background: white; border: 1px solid var(--ok-border); border-radius: 10px; padding: 24px; }
  .form-group { margin-bottom: 18px; }
  .form-group label {
    display: block;
    font-size: 13px;
    font-weight: 500;
    margin-bottom: 6px;
    color: var(--ok-text);
  }
  .form-group input, .form-group textarea, .form-group select {
    width: 100%;
    border: 1px solid var(--ok-border);
    border-radius: 6px;
    padding: 10px 12px;
    font-size: 14px;
    font-family: 'DM Sans', sans-serif;
    outline: none;
    transition: border-color .15s;
  }
  .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
    border-color: var(--ok-blue);
  }
  .form-group textarea { min-height: 200px; resize: vertical; line-height: 1.6; }
  .btn-primary {
    background: var(--ok-blue);
    color: white;
    border: none;
    padding: 10px 22px;
    border-radius: 6px;
    font-size: 14px;
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
    font-weight: 500;
    transition: background .15s;
    margin-right: 8px;
  }
  .btn-primary:hover { background: #00246b; }
  .btn-danger {
    background: var(--ok-red);
    color: white;
    border: none;
    padding: 10px 22px;
    border-radius: 6px;
    font-size: 14px;
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
    font-weight: 500;
  }
  .btn-secondary {
    background: white;
    color: var(--ok-text);
    border: 1px solid var(--ok-border);
    padding: 10px 22px;
    border-radius: 6px;
    font-size: 14px;
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
  }
  .articles-table { width: 100%; border-collapse: collapse; font-size: 13.5px; }
  .articles-table th { text-align: left; padding: 10px 12px; background: var(--ok-light); font-weight: 500; border-bottom: 2px solid var(--ok-border); }
  .articles-table td { padding: 10px 12px; border-bottom: 1px solid var(--ok-border); vertical-align: middle; }
  .articles-table tr:hover td { background: var(--ok-accent); }
  .edit-link { color: var(--ok-blue); cursor: pointer; font-size: 12.5px; }
  .edit-link:hover { text-decoration: underline; }
  .delete-link { color: var(--ok-red); cursor: pointer; font-size: 12.5px; margin-left: 10px; }

  .admin-sidebar-section {
    padding: 8px 18px 4px;
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--ok-muted);
    font-weight: 600;
    background: var(--ok-light);
    border-bottom: 1px solid var(--ok-border);
  }
  .role-badge {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    font-size: 11.5px;
    padding: 3px 10px;
    border-radius: 20px;
    font-weight: 500;
  }
  .role-master { background: #1a1d2e; color: #fff; }
  .role-okf    { background: #e0e8f7; color: var(--ok-blue); }
  .role-hr     { background: #e0f4ec; color: var(--ok-green); }
  code {
    background: #eef0f5;
    padding: 1px 5px;
    border-radius: 4px;
    font-size: 11px;
    font-family: monospace;
  }
  .modal-overlay {
    display: none;
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.45);
    z-index: 1000;
    align-items: center; justify-content: center;
  }
  .modal-overlay.show { display: flex; }
  .modal {
    background: white;
    border-radius: 14px;
    padding: 36px 36px 28px;
    width: 360px;
    box-shadow: 0 20px 60px rgba(0,0,0,.2);
  }
  .modal h3 {
    font-family: 'Source Serif 4', serif;
    font-size: 22px;
    font-weight: 400;
    color: var(--ok-blue);
    margin-bottom: 6px;
  }
  .modal p { font-size: 13px; color: var(--ok-muted); margin-bottom: 22px; }
  .modal input {
    width: 100%;
    border: 1px solid var(--ok-border);
    border-radius: 6px;
    padding: 11px 14px;
    font-size: 14px;
    font-family: 'DM Sans', sans-serif;
    outline: none;
    margin-bottom: 12px;
    transition: border-color .15s;
  }
  .modal input:focus { border-color: var(--ok-blue); }
  .modal-err { font-size: 13px; color: var(--ok-red); margin-bottom: 10px; }
  .modal-actions { display: flex; gap: 10px; margin-top: 6px; }
  .modal-close { background: none; border: none; font-size: 20px; position: absolute; top: 12px; right: 16px; cursor: pointer; color: var(--ok-muted); }

  .inline-role-select {
    font-family: 'DM Sans', sans-serif;
    font-size: 12.5px;
    padding: 4px 8px;
    border: 1px solid var(--ok-border);
    border-radius: 5px;
    background: white;
    color: var(--ok-text);
    cursor: pointer;
    outline: none;
  }
  .inline-role-select:focus { border-color: var(--ok-blue); }

  /* ‚îÄ‚îÄ FEATURED ARTICLE SEARCH ‚îÄ‚îÄ */
  #feat-search-results > div:hover { background: var(--ok-accent); }
  #feat-search-results > div { transition: background .1s; }

  mark { background: #fff3c0; border-radius: 2px; padding: 0 2px; }

  /* ‚îÄ‚îÄ MASTER INLINE EDIT HINT ‚îÄ‚îÄ */
  #master-edit-hint {
    display: none;
    background: linear-gradient(90deg, #003087, #1a4fbd);
    color: white;
    font-size: 12px;
    padding: 7px 20px;
    text-align: center;
    letter-spacing: .2px;
  }
  #master-edit-hint a { color: rgba(255,255,255,.85); cursor: pointer; text-decoration: underline; }
  .block-panel {
    background: #f0f3fa;
    border-bottom: 1px solid var(--ok-border);
    padding: 10px 12px;
    display: flex;
    flex-direction: column;
    gap: 5px;
    max-height: 280px;
    overflow-y: auto;
  }
  .block-panel-header {
    font-size: 11.5px;
    font-weight: 600;
    color: var(--ok-muted);
    text-transform: uppercase;
    letter-spacing: .5px;
    margin-bottom: 4px;
    padding-bottom: 6px;
    border-bottom: 1px solid var(--ok-border);
  }
  .block-row {
    display: flex;
    align-items: center;
    gap: 6px;
    background: white;
    border: 1px solid var(--ok-border);
    border-radius: 6px;
    padding: 6px 10px;
    font-size: 12.5px;
    transition: border-color .1s, box-shadow .1s;
  }
  .block-row:hover { border-color: var(--ok-blue); box-shadow: 0 1px 6px rgba(0,48,135,.08); }
  .block-row.block-active { border-color: var(--ok-blue); background: #eef2fb; }
  .block-type-tag {
    font-size: 10.5px;
    padding: 2px 6px;
    border-radius: 4px;
    background: var(--ok-accent);
    color: var(--ok-blue);
    font-weight: 500;
    white-space: nowrap;
    flex-shrink: 0;
  }
  .block-preview {
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    color: var(--ok-text);
    font-size: 12.5px;
  }
  .block-btns {
    display: flex;
    gap: 3px;
    flex-shrink: 0;
  }
  .block-move-btn {
    background: white;
    border: 1px solid var(--ok-border);
    border-radius: 4px;
    width: 26px;
    height: 26px;
    cursor: pointer;
    font-size: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all .1s;
  }
  .block-move-btn:hover:not(:disabled) { background: var(--ok-blue); color: white; border-color: var(--ok-blue); }
  .block-move-btn:disabled { opacity: .3; cursor: default; }

  /* ‚îÄ‚îÄ RICH TEXT TOOLBAR ‚îÄ‚îÄ */
  .rte-wrap { border: 1px solid var(--ok-border); border-radius: 6px; overflow: hidden; }
  .rte-toolbar {
    display: flex; flex-wrap: wrap; gap: 2px;
    padding: 6px 8px; background: var(--ok-light);
    border-bottom: 1px solid var(--ok-border);
  }
  .rte-btn {
    background: white; border: 1px solid var(--ok-border);
    border-radius: 4px; padding: 4px 9px; font-size: 13px;
    cursor: pointer; line-height: 1; transition: all .1s;
    font-family: 'DM Sans', sans-serif; color: var(--ok-text);
  }
  .rte-btn:hover { background: var(--ok-accent); border-color: var(--ok-blue); }
  .rte-sep { width: 1px; background: var(--ok-border); margin: 2px 4px; align-self: stretch; display: inline-block; }
  .rte-editor {
    min-height: 220px; padding: 14px 16px; outline: none;
    font-size: 14px; line-height: 1.7; font-family: 'DM Sans', sans-serif; background: white;
  }
  .rte-editor h3 { font-size: 16px; margin: 12px 0 6px; color: var(--ok-blue); }
  .rte-editor ul, .rte-editor ol { margin: 6px 0 6px 20px; }
  .rte-editor blockquote { border-left: 3px solid var(--ok-blue); margin: 8px 0; padding: 6px 14px; background: var(--ok-accent); border-radius: 0 4px 4px 0; }

  /* ‚îÄ‚îÄ CATEGORY MANAGER ‚îÄ‚îÄ */
  .cat-list { margin-bottom: 20px; }
  .cat-item {
    display: flex; align-items: center; gap: 10px;
    background: white; border: 1px solid var(--ok-border);
    border-radius: 8px; padding: 10px 14px; margin-bottom: 8px;
    cursor: grab; transition: box-shadow .15s; user-select: none;
  }
  .cat-item.dragging { opacity: .4; }
  .cat-item.drag-over { border-color: var(--ok-blue); background: var(--ok-accent); }
  .cat-drag-handle { color: var(--ok-muted); font-size: 16px; cursor: grab; flex-shrink: 0; }
  .cat-icon-preview { width: 32px; height: 32px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 16px; flex-shrink: 0; }
  .cat-item-info { flex: 1; min-width: 0; }
  .cat-item-info strong { font-size: 13.5px; display: block; }
  .cat-item-info span { font-size: 12px; color: var(--ok-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; }
  .cat-item-actions { display: flex; gap: 6px; flex-shrink: 0; }
  .cat-action-btn { background: none; border: 1px solid var(--ok-border); border-radius: 5px; padding: 4px 9px; font-size: 12px; cursor: pointer; font-family: 'DM Sans', sans-serif; transition: all .1s; }
  .cat-action-btn:hover { background: var(--ok-accent); border-color: var(--ok-blue); }
  .cat-action-btn.danger:hover { background: #fde8ec; border-color: var(--ok-red); color: var(--ok-red); }
  .icon-picker { display: flex; flex-wrap: wrap; gap: 6px; max-height: 120px; overflow-y: auto; padding: 8px; background: var(--ok-light); border-radius: 6px; margin-top: 6px; }
  .icon-opt { width: 34px; height: 34px; border: 1px solid var(--ok-border); border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 18px; cursor: pointer; background: white; transition: all .1s; }
  .icon-opt:hover { border-color: var(--ok-blue); background: var(--ok-accent); }
  .icon-opt.selected { border-color: var(--ok-blue); background: var(--ok-accent); }
  .color-picker-row { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 6px; }
  .color-opt { width: 28px; height: 28px; border-radius: 6px; cursor: pointer; border: 2px solid transparent; transition: border .1s; }
  .color-opt.selected { border-color: var(--ok-blue); transform: scale(1.15); }

  /* ‚îÄ‚îÄ INLINE EDIT MODAL ‚îÄ‚îÄ */
  .inline-modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,.45); z-index: 1100; align-items: center; justify-content: center; }
  .inline-modal-overlay.show { display: flex; }
  .inline-modal { background: white; border-radius: 12px; padding: 28px 30px; width: min(540px, 95vw); box-shadow: 0 20px 60px rgba(0,0,0,.2); position: relative; max-height: 90vh; overflow-y: auto; }
  .inline-modal h3 { font-family: 'Source Serif 4', serif; font-size: 18px; color: var(--ok-blue); margin-bottom: 16px; }
  .inline-modal-close { position: absolute; top: 12px; right: 16px; background: none; border: none; font-size: 20px; cursor: pointer; color: var(--ok-muted); }

  /* ‚îÄ‚îÄ FOOTER ‚îÄ‚îÄ */
  footer {
    background: var(--ok-blue);
    color: rgba(255,255,255,.7);
    text-align: center;
    padding: 20px;
    font-size: 12.5px;
    margin-top: auto;
  }
  footer a { color: rgba(255,255,255,.85); text-decoration: none; }

  /* ‚îÄ‚îÄ PAGE PADDING ‚îÄ‚îÄ */
  .page-content { padding-top: 40px; }

  /* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
  .toast {
    position: fixed; bottom: 28px; right: 28px;
    background: var(--ok-green);
    color: white;
    padding: 12px 22px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    box-shadow: 0 4px 20px rgba(0,0,0,.2);
    transform: translateY(60px); opacity: 0;
    transition: all .3s;
    z-index: 2000;
  }
  .toast.show { transform: translateY(0); opacity: 1; }

  /* ‚îÄ‚îÄ SKIP TO CONTENT ‚îÄ‚îÄ */
  .skip-link { position: absolute; top: -100px; left: 16px; background: var(--ok-blue); color: white; padding: 8px 16px; border-radius: 0 0 6px 6px; font-size: 13px; z-index: 9999; transition: top .2s; text-decoration: none; }
  .skip-link:focus { top: 0; }

  /* ‚îÄ‚îÄ MOBILE NAV ‚îÄ‚îÄ */
  .mobile-menu-btn { display: none; background: none; border: 1px solid var(--ok-border); border-radius: 6px; padding: 7px 10px; cursor: pointer; font-size: 18px; color: var(--ok-text); }
  .mobile-nav-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,.5); z-index: 500; }
  .mobile-nav-overlay.open { display: block; }
  .mobile-nav-panel { position: fixed; top: 0; right: -280px; width: 280px; height: 100vh; background: white; z-index: 600; box-shadow: -4px 0 20px rgba(0,0,0,.15); transition: right .25s ease; display: flex; flex-direction: column; overflow-y: auto; }
  .mobile-nav-panel.open { right: 0; }
  .mobile-nav-header { background: var(--ok-blue); color: white; padding: 18px 20px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
  .mobile-nav-close { background: none; border: none; color: white; font-size: 22px; cursor: pointer; }
  .mobile-nav-item { padding: 14px 20px; border-bottom: 1px solid var(--ok-border); font-size: 15px; cursor: pointer; display: flex; align-items: center; gap: 10px; color: var(--ok-text); }
  .mobile-nav-item:hover { background: var(--ok-accent); }

  /* ‚îÄ‚îÄ FAQ SECTION ‚îÄ‚îÄ */
  .faq-section { max-width: 860px; margin: 0 auto 60px; padding: 0 16px; }
  .faq-section h2 { font-family: 'Source Serif 4', serif; font-size: 22px; font-weight: 400; color: var(--ok-blue); margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid var(--ok-blue); }
  .faq-item { border: 1px solid var(--ok-border); border-radius: 8px; margin-bottom: 8px; overflow: hidden; background: white; }
  .faq-q { padding: 16px 20px; font-size: 14px; font-weight: 500; cursor: pointer; display: flex; justify-content: space-between; align-items: center; gap: 10px; user-select: none; transition: background .15s; }
  .faq-q:hover { background: var(--ok-accent); }
  .faq-q .faq-arrow { font-size: 12px; color: var(--ok-muted); transition: transform .2s; flex-shrink: 0; }
  .faq-q.open .faq-arrow { transform: rotate(90deg); }
  .faq-a { display: none; padding: 0 20px 16px; font-size: 13.5px; color: var(--ok-muted); line-height: 1.7; border-top: 1px solid var(--ok-border); background: var(--ok-light); }
  .faq-a.open { display: block; }
  .faq-a strong { color: var(--ok-text); }

  /* ‚îÄ‚îÄ CONTACT SECTION ‚îÄ‚îÄ */
  .contact-section { max-width: 1200px; margin: 0 auto 60px; padding: 0 16px; }
  .contact-section h2 { font-family: 'Source Serif 4', serif; font-size: 22px; font-weight: 400; color: var(--ok-blue); margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid var(--ok-blue); }
  .contact-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 16px; }
  .contact-card { background: white; border: 1px solid var(--ok-border); border-radius: 10px; padding: 20px; }
  .contact-card h4 { font-size: 14px; font-weight: 600; color: var(--ok-blue); margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
  .contact-card p { font-size: 13px; color: var(--ok-muted); line-height: 1.6; margin-bottom: 6px; }
  .contact-card a { color: var(--ok-blue); font-size: 13px; font-weight: 500; }

  /* ‚îÄ‚îÄ STATISTICS DASHBOARD ‚îÄ‚îÄ */
  .stats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 14px; margin-bottom: 28px; }
  .stat-card { background: var(--ok-accent); border-radius: 10px; padding: 16px 18px; text-align: center; }
  .stat-card .sc-num { font-size: 32px; font-weight: 700; color: var(--ok-blue); line-height: 1; }
  .stat-card .sc-label { font-size: 12px; color: var(--ok-muted); margin-top: 4px; text-transform: uppercase; letter-spacing: .5px; }
  .stat-card.green { background: #e0f4ec; } .stat-card.green .sc-num { color: var(--ok-green); }
  .stat-card.red   { background: #fde8ec; } .stat-card.red .sc-num   { color: var(--ok-red); }

  /* ‚îÄ‚îÄ CHANGE LOG ‚îÄ‚îÄ */
  .changelog-table { width: 100%; border-collapse: collapse; font-size: 13px; }
  .changelog-table th { background: var(--ok-light); padding: 9px 12px; text-align: left; font-weight: 500; border-bottom: 2px solid var(--ok-border); }
  .changelog-table td { padding: 9px 12px; border-bottom: 1px solid var(--ok-border); vertical-align: middle; }
  .changelog-table tr:hover td { background: var(--ok-accent); }

  /* ‚îÄ‚îÄ ARTICLE ENHANCEMENTS ‚îÄ‚îÄ */
  .article-toolbar { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 20px; align-items: center; }
  .article-tool-btn { background: white; border: 1px solid var(--ok-border); border-radius: 6px; padding: 6px 14px; font-size: 12.5px; cursor: pointer; font-family: 'DM Sans', sans-serif; color: var(--ok-text); transition: all .15s; display: flex; align-items: center; gap: 5px; }
  .article-tool-btn:hover { background: var(--ok-accent); border-color: var(--ok-blue); }
  .article-tool-btn.fav-active { background: #fff3c0; border-color: #c8a000; color: #7a5200; }
  .reading-time { font-size: 12px; color: var(--ok-muted); margin-left: auto; }

  /* ‚îÄ‚îÄ FEEDBACK WIDGET ‚îÄ‚îÄ */
  .feedback-box { background: var(--ok-accent); border-radius: 10px; padding: 18px 22px; margin-top: 32px; text-align: center; }
  .feedback-box p { font-size: 14px; color: var(--ok-text); margin-bottom: 12px; font-weight: 500; }
  .feedback-btns { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
  .feedback-btn { background: white; border: 1px solid var(--ok-border); border-radius: 8px; padding: 8px 20px; font-size: 14px; cursor: pointer; font-family: 'DM Sans', sans-serif; transition: all .15s; }
  .feedback-btn:hover { border-color: var(--ok-blue); background: white; }
  .feedback-btn.selected-yes { background: #e0f4ec; border-color: var(--ok-green); color: var(--ok-green); font-weight: 600; }
  .feedback-btn.selected-no  { background: #fde8ec; border-color: var(--ok-red);  color: var(--ok-red);  font-weight: 600; }

  /* ‚îÄ‚îÄ RELATED ARTICLES ‚îÄ‚îÄ */
  .related-section { margin-top: 36px; border-top: 1px solid var(--ok-border); padding-top: 24px; }
  .related-section h4 { font-size: 14px; font-weight: 600; color: var(--ok-blue); margin-bottom: 12px; }
  .related-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 10px; }
  .related-item { background: white; border: 1px solid var(--ok-border); border-radius: 8px; padding: 12px 14px; cursor: pointer; transition: border-color .15s; }
  .related-item:hover { border-color: var(--ok-blue); }
  .related-item h5 { font-size: 13px; font-weight: 500; color: var(--ok-blue); margin-bottom: 4px; }
  .related-item p { font-size: 11.5px; color: var(--ok-muted); }

  /* ‚îÄ‚îÄ BADGES ‚îÄ‚îÄ */
  .badge-new { background: var(--ok-green); color: white; font-size: 9.5px; font-weight: 700; padding: 2px 6px; border-radius: 10px; text-transform: uppercase; letter-spacing: .5px; vertical-align: middle; margin-left: 6px; }
  .status-badge { font-size: 11px; padding: 2px 8px; border-radius: 10px; font-weight: 600; }
  .status-active   { background: #e0f4ec; color: var(--ok-green); }
  .status-draft    { background: #fef3d8; color: #7a5200; }
  .status-archived { background: #eee; color: #888; }

  /* ‚îÄ‚îÄ SESSION TIMEOUT ‚îÄ‚îÄ */
  #session-warning { display: none; position: fixed; top: 80px; right: 20px; z-index: 3000; background: white; border: 2px solid var(--ok-yellow); border-radius: 10px; padding: 16px 20px; box-shadow: 0 8px 32px rgba(0,0,0,.15); max-width: 300px; }
  #session-warning h4 { font-size: 14px; color: #7a5200; margin-bottom: 6px; }
  #session-warning p  { font-size: 12.5px; color: var(--ok-muted); margin-bottom: 10px; }

  /* ‚îÄ‚îÄ SEARCH FILTERS ‚îÄ‚îÄ */
  .search-filters { display: flex; gap: 10px; margin-bottom: 18px; flex-wrap: wrap; align-items: center; }
  .filter-select { border: 1px solid var(--ok-border); border-radius: 6px; padding: 6px 10px; font-size: 13px; font-family: 'DM Sans', sans-serif; background: white; cursor: pointer; outline: none; }
  .filter-select:focus { border-color: var(--ok-blue); }
  .filter-clear { background: none; border: none; color: var(--ok-muted); font-size: 12.5px; cursor: pointer; padding: 6px 10px; border-radius: 6px; }
  .filter-clear:hover { color: var(--ok-red); background: #fde8ec; }

  @media print {
    .topbar, header, .quick-tags, .announcements-panel, .admin-wrap, .article-toolbar,
    .feedback-box, footer, #last-updated-bar, #master-edit-hint, .toast, #session-warning,
    .related-section, .mobile-menu-btn, .mobile-nav-overlay, .skip-link, .faq-section, .contact-section { display: none !important; }
    .article-wrap { max-width: 100%; padding: 0; }
    .article-header h2 { font-size: 22px; }
    body { font-size: 13px; }
    .info-box, .warn-box { border: 1px solid #ccc; background: #f9f9f9 !important; }
  }

  @media (max-width: 900px) {
    .home-layout { grid-template-columns: 1fr; }
    .announcements-panel { position: static; }
    .mobile-menu-btn { display: block; }
    .desktop-nav-item { display: none; }
  }
  @media (max-width: 680px) {
    .admin-grid { grid-template-columns: 1fr; }
    .header-inner { flex-wrap: wrap; gap: 10px; }
    .hero h2 { font-size: 24px; }
    .calc-grid { grid-template-columns: 1fr; }
    .related-list, .contact-grid { grid-template-columns: 1fr; }
    .stats-grid { grid-template-columns: repeat(2, 1fr); }
  }

  /* ‚îÄ‚îÄ MASTER INLINE EDITING ‚îÄ‚îÄ */
  .master-hint-bar { display:none; background:linear-gradient(90deg,#003087,#1a5cbf); color:white; font-size:12.5px; padding:8px 20px; display:none; align-items:center; gap:12px; }
  .master-hint-bar.visible { display:flex; }
  .master-editable, .master-editable-section { transition:outline .15s; }
  body.master-mode .master-editable {
    outline: 1.5px dashed rgba(0,48,135,.35) !important;
    border-radius: 3px;
    cursor: pointer !important;
  }
  body.master-mode .master-editable:hover {
    outline: 2px solid var(--ok-blue) !important;
    background: rgba(0,48,135,.04) !important;
  }
  body.master-mode .master-editable-section {
    outline: 1.5px dashed rgba(0,48,135,.3) !important;
    border-radius: 4px;
    cursor: pointer !important;
  }
  body.master-mode .master-editable-section:hover {
    outline: 2px solid var(--ok-blue) !important;
    background: rgba(0,48,135,.04) !important;
  }

  /* Edit modal */
  #inline-edit-modal { display:none; position:fixed; inset:0; z-index:5000; align-items:center; justify-content:center; }
  #inline-edit-modal.open { display:flex; }
  #inline-edit-modal .ie-backdrop { position:absolute; inset:0; background:rgba(0,0,0,.45); }
  #inline-edit-modal .ie-box { position:relative; background:white; border-radius:12px; padding:28px 32px; width:min(640px,92vw); box-shadow:0 20px 60px rgba(0,0,0,.25); max-height:90vh; overflow-y:auto; }
  #inline-edit-modal h3 { font-size:15px; font-weight:600; color:var(--ok-blue); margin-bottom:18px; }
  #inline-edit-modal label { font-size:12px; font-weight:600; color:var(--ok-muted); text-transform:uppercase; letter-spacing:.5px; display:block; margin-bottom:5px; margin-top:14px; }
  #inline-edit-modal input, #inline-edit-modal textarea, #inline-edit-modal select { width:100%; font-family:'DM Sans',sans-serif; font-size:13.5px; padding:9px 12px; border:1px solid var(--ok-border); border-radius:7px; outline:none; box-sizing:border-box; }
  #inline-edit-modal input:focus, #inline-edit-modal textarea:focus { border-color:var(--ok-blue); }
  #inline-edit-modal textarea { min-height:100px; resize:vertical; }
  #inline-edit-modal .ie-actions { display:flex; gap:10px; margin-top:20px; }
  #inline-edit-modal .ie-close { position:absolute; top:14px; right:16px; background:none; border:none; font-size:22px; cursor:pointer; color:var(--ok-muted); line-height:1; }
  #inline-edit-modal .ie-close:hover { color:var(--ok-text); }

  /* Contact card master actions */
  body.master-mode .contact-card { position:relative; }
  .contact-card-actions { display:none; position:absolute; top:8px; right:8px; gap:4px; }
  body.master-mode .contact-card:hover .contact-card-actions { display:flex; }
  .cc-btn { background:var(--ok-blue); color:white; border:none; border-radius:5px; padding:4px 8px; font-size:11px; cursor:pointer; font-family:'DM Sans',sans-serif; }
  .cc-btn.danger { background:var(--ok-red); }

  /* FAQ master actions */
  body.master-mode .faq-item { position:relative; }
  .faq-item-actions { display:none; position:absolute; top:10px; right:50px; gap:4px; z-index:10; }
  body.master-mode .faq-item:hover .faq-item-actions { display:flex; }

  /* Section add buttons - shown only in master mode */
  .master-add-btn { display:none; margin-top:14px; }
  body.master-mode .master-add-btn { display:inline-flex; align-items:center; gap:6px; background:white; border:1.5px dashed var(--ok-blue); color:var(--ok-blue); border-radius:8px; padding:8px 18px; font-size:13px; cursor:pointer; font-family:'DM Sans',sans-serif; }
  body.master-mode .master-add-btn:hover { background:var(--ok-accent); }

</style>
</head>

<!-- MASTER HINT BAR -->
<div class="master-hint-bar" id="master-hint-bar">
  <span>‚úèÔ∏è <strong>Master-modus:</strong> Klikk p√• tekst med stiplet ramme for √• redigere direkte.</span>
  <span style="margin-left:auto;opacity:.7;font-size:11.5px">Endringer lagres automatisk</span>
</div>

<!-- UNIVERSAL INLINE EDIT MODAL -->
<div id="inline-edit-modal">
  <div class="ie-backdrop" onclick="closeInlineModal()"></div>
  <div class="ie-box">
    <button class="ie-close" onclick="closeInlineModal()">√ó</button>
    <h3 id="ie-modal-title">Rediger</h3>
    <div id="ie-modal-fields"></div>
    <div class="ie-actions">
      <button class="btn-primary" onclick="saveInlineModal()">üíæ Lagre</button>
      <button class="btn-secondary" onclick="closeInlineModal()">Avbryt</button>
      <button class="btn-danger" id="ie-modal-delete" style="display:none;margin-left:auto" onclick="deleteInlineItem()">üóë Slett</button>
    </div>
  </div>
</div>

<body>
<a href="#main-content" class="skip-link">Hopp til innhold</a>

<!-- TOP BAR -->
<div class="topbar">
  <span>Oslo kommune ‚Äì Internt HR-verkt√∏y</span>
  <span id="topbar-status">üìã Ferieportalen v1.0 ¬∑ Basert p√• Dok 25 (2024‚Äì2026) og ferieloven</span>
</div>
<!-- MASTER INLINE EDIT HINT -->
<div id="master-edit-hint">‚úèÔ∏è Master-modus: Klikk p√• tekst med stiplet ramme for √• redigere direkte. <a onclick="adminTab('site', document.getElementById('tab-btn-site')); showPage('admin');">√Öpne nettstedinnstillinger ‚Üí</a></div>

<!-- HEADER -->
<header>
  <div class="header-inner">
    <div class="logo-area">
      <div class="logo-shield">
        <svg viewBox="0 0 60 60" width="44" height="44" xmlns="http://www.w3.org/2000/svg" aria-label="Oslo Kommune">
          <!-- Blue shield background -->
          <path d="M30 2 L54 12 L54 34 C54 46 42 56 30 58 C18 56 6 46 6 34 L6 12 Z" fill="#003087"/>
          <!-- White horizontal bars (Oslo's coat of arms simplified) -->
          <rect x="14" y="20" width="32" height="5" rx="1" fill="white"/>
          <rect x="14" y="29" width="32" height="5" rx="1" fill="white"/>
          <rect x="14" y="38" width="32" height="5" rx="1" fill="white"/>
        </svg>
      </div>
      <div class="logo-text">
        <h1>Ferieportalen</h1>
        <span>Oslo Kommune ¬∑ HR & L√∏nn</span>
      </div>
    </div>
    <nav>
      <button onclick="showPage('home')" class="desktop-nav-item">Hjem</button>
      <button onclick="showPage('home');setTimeout(()=>document.getElementById('faq-section').scrollIntoView({behavior:'smooth'}),100)" class="desktop-nav-item" style="font-size:13px">‚ùì FAQ</button>
      <button onclick="showPage('home');setTimeout(()=>document.getElementById('contact-section').scrollIntoView({behavior:'smooth'}),100)" class="desktop-nav-item" style="font-size:13px">üìû Kontakt</button>
      <button onclick="showPage('home'); setTimeout(()=>document.getElementById('search-input').focus(),100)" class="desktop-nav-item">S√∏k</button>
      <button onclick="showFavorites()" id="fav-nav-btn" title="Mine favoritter" style="font-size:16px;padding:7px 10px">‚≠ê</button>
      <button id="admin-nav-btn" class="admin-btn" onclick="openLoginModal()">Logg inn</button>
      <button class="mobile-menu-btn" onclick="openMobileNav()" aria-label="Meny">‚ò∞</button>
      <button id="header-profile-btn" class="btn-secondary" style="display:none;font-size:12px;padding:6px 14px" onclick="openProfileModal()">üë§ Min profil</button>
      <button id="admin-panel-btn" class="admin-btn" style="display:none" onclick="showPage('admin'); adminTab('list', document.getElementById('tab-btn-list'))">‚öôÔ∏è Panel</button>
      <button id="header-logout-btn" class="logout-btn" style="display:none" onclick="logout()">Logg ut</button>
    </nav>
  </div>
</header>


<!-- MOBILE NAV PANEL -->
<div class="mobile-nav-overlay" id="mobile-overlay" onclick="closeMobileNav()"></div>
<div class="mobile-nav-panel" id="mobile-nav-panel" aria-label="Mobilmeny">
  <div class="mobile-nav-header">
    <span style="font-weight:600">Ferieportalen</span>
    <button class="mobile-nav-close" onclick="closeMobileNav()" aria-label="Lukk meny">√ó</button>
  </div>
  <div class="mobile-nav-item" onclick="closeMobileNav();showPage('home')">üè† Hjem</div>
  <div class="mobile-nav-item" onclick="closeMobileNav();showPage('home');setTimeout(()=>document.getElementById('search-input').focus(),200)">üîç S√∏k</div>
  <div class="mobile-nav-item" id="mob-faq" onclick="closeMobileNav();showPage('home');setTimeout(()=>document.getElementById('faq-section').scrollIntoView({behavior:'smooth'}),200)">‚ùì Vanlige sp√∏rsm√•l</div>
  <div class="mobile-nav-item" id="mob-contact" onclick="closeMobileNav();showPage('home');setTimeout(()=>document.getElementById('contact-section').scrollIntoView({behavior:'smooth'}),200)">üìû Kontakt & hjelp</div>
  <div class="mobile-nav-item" id="mob-favs" onclick="closeMobileNav();showFavorites()">‚≠ê Mine favoritter</div>
  <div class="mobile-nav-item" id="mob-login" onclick="closeMobileNav();openLoginModal()">üîë Logg inn</div>
  <div class="mobile-nav-item" id="mob-admin" style="display:none" onclick="closeMobileNav();showPage('admin')">‚öôÔ∏è Administrasjon</div>
  <div class="mobile-nav-item" id="mob-logout" style="display:none;color:var(--ok-red)" onclick="closeMobileNav();logout()">üö™ Logg ut</div>
</div>

<!-- SESSION TIMEOUT WARNING -->
<div id="session-warning">
  <h4>‚è∞ Sesjon utl√∏per snart</h4>
  <p>Du har v√¶rt inaktiv i 25 minutter. Du logges ut automatisk om <strong id="session-countdown">5:00</strong>.</p>
  <button class="btn-primary" style="font-size:12px;padding:6px 14px" onclick="resetSessionTimer()">Fortsett sesjon</button>
</div>

<!-- HOME PAGE -->
<main id="page-home" class="page active page-content" aria-label="Ferieportalens startside">
  <div class="hero">
    <h2>Finn svar om ferie i Oslo kommune</h2>
    <p>S√∏k i reglement, Dok 25, ferieloven og interne retningslinjer for HR, ledere og l√∏nnstjenesten.</p>
    <div class="search-box">
      <input id="search-input" type="text" aria-label="S√∏k i ferieportalen" placeholder="S√∏k f.eks. ¬´feriepenger¬ª, ¬´ekstraferie 60 √•r¬ª, ¬´sykdom under ferie¬ª ‚Ä¶" onkeydown="if(event.key==='Enter')doSearch()">
      <button onclick="doSearch()">S√∏k</button>
    </div>
    <div class="quick-tags">
      <button onclick="quickSearch('Feriedager antall')">Antall feriedager</button>
      <button onclick="quickSearch('Feriepenger')">Feriepenger</button>
      <button onclick="quickSearch('Sykdom under ferie')">Sykdom under ferie</button>
      <button onclick="quickSearch('Ekstraferie over 60')">Ekstraferie 60+</button>
      <button onclick="quickSearch('Overf√∏ring ferie')">Overf√∏ring av ferie</button>
      <button onclick="quickSearch('Fastsettelse ferie')">Fastsettelse av ferie</button>
      <button onclick="quickSearch('Ny ansatt ferie')">Ny ansatt</button>
      <button onclick="quickSearch('Feriepenger utbetaling')">Utbetaling juni</button>
    </div>
  </div>

  <div class="home-layout">
    <!-- LEFT: categories -->
    <div>
      <div class="categories">
        <p class="section-title">Fremhevede artikler</p>
        <div class="card-grid" id="card-grid">
          <!-- rendered by JS from categories[] -->
        </div>
      </div>
    </div>

    <!-- RIGHT: announcements + recent articles -->
    <div>
      <div class="announcements-panel">
        <div class="ann-header">
          üì¢ Viktige beskjeder
          <span id="ann-count-label"></span>
        </div>
        <div class="ann-list" id="ann-list">
          <!-- filled by JS -->
        </div>
        <button class="ann-admin-btn" id="ann-admin-btn" style="display:none" onclick="adminTab('announcements', document.getElementById('admin-ann-tab')); showPage('admin');">+ Legg til beskjed</button>
      </div>

      <!-- Recent articles -->
      <div class="announcements-panel" style="margin-top:16px">
        <div class="ann-header" style="background:#1a7a4a">
          üìÑ Sist publiserte artikler
        </div>
        <div id="recent-articles-list"></div>
      </div>
    </div>
  </div>


  <!-- FAQ SECTION -->
  <section id="faq-section" class="faq-section" aria-labelledby="faq-heading">
    <h2 id="faq-heading" class="master-editable-section" data-section-key="faqTitle"></h2>
    <div id="faq-list"></div>
  </section>

  <!-- CONTACT SECTION -->
  <section id="contact-section" class="contact-section" aria-labelledby="contact-heading">
    <h2 id="contact-heading" class="master-editable-section" data-section-key="contactTitle"></h2>
    <p id="contact-intro" class="master-editable-section" data-section-key="contactIntro" style="font-size:14px;color:var(--ok-muted);margin-bottom:20px"></p>
    <div class="contact-grid" id="contact-grid"></div>
  </section>


</main>

<!-- SEARCH RESULTS PAGE -->
<div id="page-results" class="page page-content">
  <div class="results-wrap">
    <div style="max-width:700px;margin:0 auto 30px;">
      <div class="search-box">
        <input id="search-input2" type="text" placeholder="S√∏k p√• nytt ‚Ä¶" onkeydown="if(event.key==='Enter')doSearch2()">
        <button onclick="doSearch2()">S√∏k</button>
      </div>
    </div>
    <div class="search-filters">
      <select class="filter-select" id="filter-sort" onchange="applySearchFilters()">
        <option value="relevance">Sorter etter relevans</option>
        <option value="newest">Nyeste f√∏rst</option>
        <option value="oldest">Eldste f√∏rst</option>
        <option value="az">Tittel A‚Äì√Ö</option>
      </select>
      <select class="filter-select" id="filter-status" onchange="applySearchFilters()">
        <option value="all">Alle statuser</option>
        <option value="active">Kun aktive</option>
        <option value="draft">Utkast</option>
      </select>
      <button class="filter-clear" onclick="clearFilters()">‚úï Nullstill filtre</button>
    </div>
    <div class="results-header">
      <h3 id="results-heading">S√∏keresultater</h3>
      <span id="results-count"></span>
    </div>
    <div id="results-list"></div>
  </div>
</div>

<!-- ARTICLE PAGE -->
<div id="page-article" class="page page-content">
  <div class="article-wrap">
    <div class="breadcrumb">
      <a onclick="showPage('home')">Hjem</a> ‚Ä∫ <span id="article-breadcrumb">Artikkel</span>
    </div>
    <div id="article-content"></div>
  </div>
</div>

<!-- ADMIN PAGE -->
<div id="page-admin" class="page page-content">
  <div class="admin-wrap">
    <div class="admin-header">
      <div>
        <h2>‚öôÔ∏è Administrasjonspanel</h2>
        <div id="admin-role-badge" style="margin-top:4px;font-size:12.5px;color:var(--ok-muted)"></div>
      </div>
      <div style="display:flex;gap:10px;align-items:center">
        <span id="admin-user-label" style="font-size:13px;color:var(--ok-muted)"></span>
        <button class="btn-secondary" style="font-size:12px;padding:6px 14px" onclick="openProfileModal()">üë§ Min profil</button>
        <button class="btn-secondary" style="font-size:12px;padding:6px 14px" onclick="logout()">Logg ut</button>
      </div>
    </div>
    <div class="admin-grid">
      <div class="admin-sidebar">
        <div class="admin-sidebar-section">Oversikt</div>
        <div class="admin-sidebar-item" id="tab-btn-dashboard" onclick="adminTab('dashboard',this)">üìä Dashboard</div>
        <div class="admin-sidebar-section">Innhold</div>
        <div class="admin-sidebar-item active" id="tab-btn-list" onclick="adminTab('list',this)">üìÑ Alle artikler</div>
        <div class="admin-sidebar-item" id="tab-btn-new" onclick="adminTab('new',this)">‚ûï Ny artikkel</div>
        <div class="admin-sidebar-item" id="tab-btn-edit" onclick="adminTab('edit',this)" id="admin-edit-tab" style="display:none">‚úèÔ∏è Rediger artikkel</div>
        <div class="admin-sidebar-item" id="tab-btn-categories" onclick="adminTab('categories',this)">‚≠ê Fremhevede artikler</div>
        <div class="admin-sidebar-section">Kommunikasjon</div>
        <div class="admin-sidebar-item" id="tab-btn-announcements" onclick="adminTab('announcements',this)">üì¢ Beskjeder</div>
        <div class="admin-sidebar-section">Historikk</div>
        <div class="admin-sidebar-item" id="tab-btn-changelog" onclick="adminTab('changelog',this)">üìã Endringslogg</div>
        <div class="admin-sidebar-section" id="master-section" style="display:none">Master</div>
        <div class="admin-sidebar-item" id="tab-btn-site" onclick="adminTab('site',this)" style="display:none">üé® Nettstedinnstillinger</div>
        <div class="admin-sidebar-item" id="tab-btn-users" onclick="adminTab('users',this)" style="display:none">üë• Brukere</div>
      </div>
      <div class="admin-main">

        <!-- DASHBOARD -->
        <div id="admin-dashboard" style="display:none">
          <h3 style="font-size:16px;margin-bottom:6px;">üìä Dashboard</h3>
          <p style="font-size:13px;color:var(--ok-muted);margin-bottom:22px">Oversikt over portalens innhold og aktivitet.</p>

          <div class="stats-grid" id="dash-stats"></div>

          <div class="dash-section">
            <h4>üïê Siste aktivitet</h4>
            <div id="dash-activity-log" style="font-size:13px;color:var(--ok-muted)">Ingen aktivitet registrert enn√•.</div>
          </div>

          <div class="dash-section" style="margin-top:24px">
            <h4>üì¢ Aktive beskjeder</h4>
            <div id="dash-announcements-preview"></div>
          </div>

          <div class="dash-section" style="margin-top:24px">
            <h4>üìÑ Nyeste artikler</h4>
            <div id="dash-recent-articles-preview"></div>
          </div>
        </div>

        <!-- CHANGELOG -->
        <div id="admin-changelog" style="display:none">
          <h3 style="font-size:16px;margin-bottom:6px;">üìã Endringslogg</h3>
          <p style="font-size:13px;color:var(--ok-muted);margin-bottom:20px">Alle registrerte endringer i portalen. Logg lagres i nettleseren (localStorage).</p>
          <div id="changelog-table-wrap">
            <table class="changelog-table">
              <thead><tr><th>Tidspunkt</th><th>Bruker</th><th>Handling</th></tr></thead>
              <tbody id="changelog-tbody"></tbody>
            </table>
          </div>
          <div style="margin-top:14px;display:flex;gap:10px">
            <button class="btn-secondary" style="font-size:12.5px" onclick="exportChangelog()">‚¨á Eksporter som CSV</button>
            <button class="btn-danger" style="font-size:12.5px" onclick="clearChangelog()">üóë T√∏m logg</button>
          </div>
        </div>

        <!-- LIST -->
        <div id="admin-list">
          <h3 style="font-size:16px;margin-bottom:16px;">Eksisterende artikler</h3>
          <table class="articles-table">
            <thead><tr><th>Tittel</th><th>Kategori</th><th>Status</th><th>Sist endret</th><th></th></tr></thead>
            <tbody id="articles-tbody"></tbody>
          </table>
        </div>
        <!-- NEW ARTICLE -->
        <div id="admin-new" style="display:none">
          <h3 style="font-size:16px;margin-bottom:18px;">Ny artikkel</h3>
          <div class="form-group">
            <label>Tittel</label>
            <input id="new-title" type="text" placeholder="F.eks. Feriedager for deltidsansatte">
          </div>
          <div class="form-group">
            <label>Kategori / emneord (kommaseparert)</label>
            <input id="new-tags" type="text" placeholder="ferie, deltid, feriedager">
          </div>
          <div class="form-group">
            <label>Innhold</label>
            <div class="rte-wrap">
              <div class="rte-toolbar" id="rte-new-toolbar">
                <button class="rte-btn" onclick="rteCmd('new','bold')" title="Fet"><b>B</b></button>
                <button class="rte-btn" onclick="rteCmd('new','italic')" title="Kursiv"><i>I</i></button>
                <button class="rte-btn" onclick="rteCmd('new','underline')" title="Understrek"><u>U</u></button>
                <span class="rte-sep"></span>
                <button class="rte-btn" onclick="rteHeading('new')" title="Overskrift">H3</button>
                <button class="rte-btn" onclick="rteCmd('new','insertUnorderedList')" title="Liste">‚Ä¢ Liste</button>
                <button class="rte-btn" onclick="rteCmd('new','insertOrderedList')" title="Nummerert">1. Liste</button>
                <span class="rte-sep"></span>
                <button class="rte-btn" onclick="rteInsertBox('new','info')" title="Inforamme">‚ÑπÔ∏è Info</button>
                <button class="rte-btn" onclick="rteInsertBox('new','warn')" title="Advarsel">‚ö†Ô∏è Advarsel</button>
                <span class="rte-sep"></span>
                <button class="rte-btn" onclick="rteCmd('new','removeFormat')" title="Fjern formatering">‚úï Format</button>
                <span class="rte-sep"></span>
                <button class="rte-btn" id="block-panel-btn-new" onclick="toggleBlockPanel('new')" title="Omorganiser avsnitt">‚áÖ Organiser avsnitt</button>
              </div>
              <div class="block-panel" id="block-panel-new" style="display:none"></div>
              <div class="rte-editor" id="rte-new" contenteditable="true" spellcheck="true"></div>
            </div>
          </div>
          <div class="form-group">
            <label>Status</label>
            <select id="new-status">
              <option value="active">‚úÖ Aktiv ‚Äì synlig for alle</option>
              <option value="draft">üìù Utkast ‚Äì ikke synlig</option>
              <option value="archived">üì¶ Arkivert</option>
            </select>
          </div>
          <div class="form-group">
            <label>Kilder / referanser</label>
            <input id="new-sources" type="text" placeholder="Dok 25 ¬ß 3.1, Ferieloven ¬ß 5">
          </div>
          <button class="btn-primary" onclick="saveNewArticle()">Lagre artikkel</button>
          <button class="btn-secondary" onclick="adminTab('list', document.getElementById('tab-btn-list'))">Avbryt</button>
        </div>
        <!-- ANNOUNCEMENTS ADMIN -->
        <div id="admin-announcements" style="display:none">
          <h3 style="font-size:16px;margin-bottom:18px;">Viktige beskjeder</h3>
          <div id="ann-admin-list" style="margin-bottom:20px;"></div>
          <hr style="border:none;border-top:1px solid var(--ok-border);margin-bottom:20px">
          <h4 style="font-size:14px;margin-bottom:14px;font-weight:500;">Ny beskjed</h4>
          <div class="form-group">
            <label>Tittel</label>
            <input id="ann-new-title" type="text" placeholder="F.eks. Frist for ferie√∏nsker 2025">
          </div>
          <div class="form-group">
            <label>Innhold</label>
            <textarea id="ann-new-body" style="min-height:90px" placeholder="Skriv beskjeden her‚Ä¶"></textarea>
          </div>
          <div class="form-group">
            <label>Type</label>
            <select id="ann-new-type">
              <option value="info">‚ÑπÔ∏è Info (bl√•)</option>
              <option value="viktig">üî¥ Viktig (r√∏d)</option>
              <option value="ok">‚úÖ Bekreftet (gr√∏nn)</option>
              <option value="advarsel">‚ö†Ô∏è Advarsel (gul)</option>
            </select>
          </div>
          <div class="form-group">
            <label>Signert av (avdeling)</label>
            <input id="ann-new-author" type="text" placeholder="F.eks. HR-avdelingen">
          </div>
          <div class="form-group">
            <label>Utl√∏psdato (valgfritt) <span style="font-size:11.5px;color:var(--ok-muted);font-weight:400">‚Äî beskjed fjernes automatisk etter denne datoen</span></label>
            <input id="ann-new-expires" type="date">
          </div>
          <button class="btn-primary" onclick="saveAnnouncement()">Publiser beskjed</button>
        </div>
        <!-- EDIT ARTICLE -->
        <div id="admin-edit" style="display:none">
          <h3 style="font-size:16px;margin-bottom:18px;">Rediger artikkel</h3>
          <input type="hidden" id="edit-id">
          <div class="form-group">
            <label>Tittel</label>
            <input id="edit-title" type="text">
          </div>
          <div class="form-group">
            <label>Kategori / emneord</label>
            <input id="edit-tags" type="text">
          </div>
          <div class="form-group">
            <label>Innhold</label>
            <div class="rte-wrap">
              <div class="rte-toolbar">
                <button class="rte-btn" onclick="rteCmd('edit','bold')" title="Fet"><b>B</b></button>
                <button class="rte-btn" onclick="rteCmd('edit','italic')" title="Kursiv"><i>I</i></button>
                <button class="rte-btn" onclick="rteCmd('edit','underline')" title="Understrek"><u>U</u></button>
                <span class="rte-sep"></span>
                <button class="rte-btn" onclick="rteHeading('edit')" title="Overskrift">H3</button>
                <button class="rte-btn" onclick="rteCmd('edit','insertUnorderedList')" title="Liste">‚Ä¢ Liste</button>
                <button class="rte-btn" onclick="rteCmd('edit','insertOrderedList')" title="Nummerert">1. Liste</button>
                <span class="rte-sep"></span>
                <button class="rte-btn" onclick="rteInsertBox('edit','info')" title="Inforamme">‚ÑπÔ∏è Info</button>
                <button class="rte-btn" onclick="rteInsertBox('edit','warn')" title="Advarsel">‚ö†Ô∏è Advarsel</button>
                <span class="rte-sep"></span>
                <button class="rte-btn" onclick="rteCmd('edit','removeFormat')" title="Fjern formatering">‚úï Format</button>
                <span class="rte-sep"></span>
                <button class="rte-btn" id="block-panel-btn-edit" onclick="toggleBlockPanel('edit')" title="Omorganiser avsnitt">‚áÖ Organiser avsnitt</button>
              </div>
              <div class="block-panel" id="block-panel-edit" style="display:none"></div>
              <div class="rte-editor" id="rte-edit" contenteditable="true" spellcheck="true"></div>
            </div>
          </div>
          <div class="form-group">
            <label>Status</label>
            <select id="edit-status">
              <option value="active">‚úÖ Aktiv ‚Äì synlig for alle</option>
              <option value="draft">üìù Utkast ‚Äì ikke synlig</option>
              <option value="archived">üì¶ Arkivert</option>
            </select>
          </div>
          <div class="form-group">
            <label>Kilder / referanser</label>
            <input id="edit-sources" type="text">
          </div>
          <button class="btn-primary" onclick="saveEditArticle()">Lagre endringer</button>
          <button class="btn-danger" onclick="deleteArticle()">Slett artikkel</button>
          <button class="btn-secondary" onclick="adminTab('list', document.getElementById('tab-btn-list'))" style="margin-left:8px">Avbryt</button>
        </div>
        <!-- SITE SETTINGS (master only) -->
        <div id="admin-site" style="display:none">
          <h3 style="font-size:16px;margin-bottom:6px;">üé® Nettstedinnstillinger</h3>
          <p style="font-size:13px;color:var(--ok-muted);margin-bottom:22px">Rediger alle tekster, farger og seksjoner. Endringer er synlige umiddelbart etter lagring.</p>

          <!-- Colors -->
          <div style="background:var(--ok-accent);border-radius:8px;padding:16px 18px;margin-bottom:22px">
            <p style="font-size:12.5px;font-weight:600;color:var(--ok-blue);margin-bottom:12px">üé® Farger</p>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
              <div class="form-group" style="margin-bottom:0">
                <label>Prim√¶rfarge (bl√•)</label>
                <div style="display:flex;gap:8px;align-items:center">
                  <input id="site-color-blue" type="color" style="width:44px;height:34px;border:1px solid var(--ok-border);border-radius:5px;padding:2px;cursor:pointer">
                  <input id="site-color-blue-hex" type="text" style="flex:1" placeholder="#003087" oninput="syncColor('blue')">
                </div>
              </div>
              <div class="form-group" style="margin-bottom:0">
                <label>Sekund√¶rfarge (r√∏d)</label>
                <div style="display:flex;gap:8px;align-items:center">
                  <input id="site-color-red" type="color" style="width:44px;height:34px;border:1px solid var(--ok-border);border-radius:5px;padding:2px;cursor:pointer">
                  <input id="site-color-red-hex" type="text" style="flex:1" placeholder="#C8102E" oninput="syncColor('red')">
                </div>
              </div>
              <div class="form-group" style="margin-bottom:0">
                <label>Gr√∏nn (bekreftet/artikler)</label>
                <div style="display:flex;gap:8px;align-items:center">
                  <input id="site-color-green" type="color" style="width:44px;height:34px;border:1px solid var(--ok-border);border-radius:5px;padding:2px;cursor:pointer">
                  <input id="site-color-green-hex" type="text" style="flex:1" placeholder="#1a7a4a" oninput="syncColor('green')">
                </div>
              </div>
              <div class="form-group" style="margin-bottom:0">
                <label>Aksentfarge (bakgrunner)</label>
                <div style="display:flex;gap:8px;align-items:center">
                  <input id="site-color-accent" type="color" style="width:44px;height:34px;border:1px solid var(--ok-border);border-radius:5px;padding:2px;cursor:pointer">
                  <input id="site-color-accent-hex" type="text" style="flex:1" placeholder="#e8ecf7" oninput="syncColor('accent')">
                </div>
              </div>
            </div>
          </div>

          <!-- Topbar -->
          <div style="background:var(--ok-accent);border-radius:8px;padding:16px 18px;margin-bottom:22px">
            <p style="font-size:12.5px;font-weight:600;color:var(--ok-blue);margin-bottom:2px">üîµ Topptekst (bl√• linje √∏verst)</p>
            <div class="form-group" style="margin-top:10px;margin-bottom:0">
              <label>Venstre tekst</label>
              <input id="site-topbar-left" type="text">
            </div>
            <div class="form-group" style="margin-bottom:0;margin-top:10px">
              <label>H√∏yre tekst</label>
              <input id="site-topbar-right" type="text">
            </div>
          </div>

          <!-- Header/Logo -->
          <div style="background:var(--ok-accent);border-radius:8px;padding:16px 18px;margin-bottom:22px">
            <p style="font-size:12.5px;font-weight:600;color:var(--ok-blue);margin-bottom:2px">üèõ Header / Logo</p>
            <div class="form-group" style="margin-top:10px;margin-bottom:0">
              <label>Portalnavn (stor tittel)</label>
              <input id="site-portal-name" type="text">
            </div>
            <div class="form-group" style="margin-top:10px;margin-bottom:0">
              <label>Undertittel (liten tekst under navn)</label>
              <input id="site-portal-sub" type="text">
            </div>
          </div>

          <!-- Hero section -->
          <div style="background:var(--ok-accent);border-radius:8px;padding:16px 18px;margin-bottom:22px">
            <p style="font-size:12.5px;font-weight:600;color:var(--ok-blue);margin-bottom:2px">üîç Forsiden ‚Äì s√∏k</p>
            <div class="form-group" style="margin-top:10px;margin-bottom:0">
              <label>S√∏keboks-tittel</label>
              <input id="site-hero-title" type="text">
            </div>
            <div class="form-group" style="margin-top:10px;margin-bottom:0">
              <label>S√∏keboks-undertekst</label>
              <input id="site-hero-sub" type="text">
            </div>
            <div class="form-group" style="margin-top:10px;margin-bottom:0">
              <label>Hurtigs√∏k-knapper <span style="font-size:11.5px;color:var(--ok-muted);font-weight:400">(√©n per linje, format: Visningsnavn|S√∏keord)</span></label>
              <textarea id="site-quick-tags" style="min-height:130px;font-family:monospace;font-size:12px" placeholder="Antall feriedager|Feriedager antall&#10;Feriepenger|Feriepenger"></textarea>
            </div>
          </div>

          <!-- Home sections -->
          <div style="background:var(--ok-accent);border-radius:8px;padding:16px 18px;margin-bottom:22px">
            <p style="font-size:12.5px;font-weight:600;color:var(--ok-blue);margin-bottom:2px">üè† Forsidebokser</p>
            <div class="form-group" style="margin-top:10px;margin-bottom:0">
              <label>Tittel over fremhevede artikler</label>
              <input id="site-featured-title" type="text">
            </div>
            <div class="form-group" style="margin-top:10px;margin-bottom:0">
              <label>Tittel: Viktige beskjeder</label>
              <input id="site-ann-header" type="text">
            </div>
            <div class="form-group" style="margin-top:10px;margin-bottom:0">
              <label>Tittel: Sist publiserte artikler</label>
              <input id="site-recent-header" type="text">
            </div>
          </div>

          <!-- Footer -->
          <div style="background:var(--ok-accent);border-radius:8px;padding:16px 18px;margin-bottom:22px">
            <p style="font-size:12.5px;font-weight:600;color:var(--ok-blue);margin-bottom:2px">üìÑ Bunntekst (footer)</p>
            <div class="form-group" style="margin-top:10px;margin-bottom:0">
              <label>Linje 1</label>
              <input id="site-footer1" type="text">
            </div>
            <div class="form-group" style="margin-top:10px;margin-bottom:0">
              <label>Linje 2</label>
              <input id="site-footer2" type="text">
            </div>
          </div>

          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <button class="btn-primary" onclick="saveSiteSettings()">üíæ Lagre alle endringer</button>
            <button class="btn-secondary" onclick="loadSiteSettingsToForm()">‚Ü© Tilbakestill skjema</button>
            <button class="btn-danger" onclick="resetStorage()" style="margin-left:auto">üóë Slett alle lagrede endringer</button>
          </div>
        </div>

        <!-- USER MANAGEMENT (master only) -->
        <div id="admin-users" style="display:none">
          <h3 style="font-size:16px;margin-bottom:6px;">üë• Brukere og roller</h3>
          <p style="font-size:13px;color:var(--ok-muted);margin-bottom:20px">Administrer innloggingsbrukere og tilgangsniv√•.</p>
          <table class="articles-table" id="users-table">
            <thead><tr><th>Brukernavn</th><th>Tilganger</th><th>Handlinger</th></tr></thead>
            <tbody id="users-tbody"></tbody>
          </table>
          <hr style="border:none;border-top:1px solid var(--ok-border);margin:20px 0">
          <h4 style="font-size:14px;margin-bottom:14px;font-weight:500;">Legg til / endre bruker</h4>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:14px">
            <div class="form-group" style="margin-bottom:0">
              <label>Brukernavn</label>
              <input id="user-new-name" type="text" placeholder="F.eks. lise.hansen">
            </div>
            <div class="form-group" style="margin-bottom:0">
              <label>Passord</label>
              <input id="user-new-pass" type="text" placeholder="Midlertidig passord">
            </div>
          </div>
          <div class="form-group" style="margin-bottom:0">
            <label style="margin-bottom:10px;display:block">Tilganger <span style="font-size:11.5px;color:var(--ok-muted);font-weight:400">(ingenting valgt = kun portalbruk)</span></label>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
              <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer;background:var(--ok-light);padding:8px 12px;border-radius:6px;border:1px solid var(--ok-border)">
                <input type="checkbox" id="cap-articles" style="width:15px;height:15px"> üìÑ Artikler
              </label>
              <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer;background:var(--ok-light);padding:8px 12px;border-radius:6px;border:1px solid var(--ok-border)">
                <input type="checkbox" id="cap-announcements" style="width:15px;height:15px"> üì¢ Beskjeder
              </label>
              <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer;background:var(--ok-light);padding:8px 12px;border-radius:6px;border:1px solid var(--ok-border)">
                <input type="checkbox" id="cap-categories" style="width:15px;height:15px"> ‚≠ê Fremhevede artikler
              </label>
              <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer;background:var(--ok-light);padding:8px 12px;border-radius:6px;border:1px solid var(--ok-border)">
                <input type="checkbox" id="cap-site" style="width:15px;height:15px"> üé® Nettstedinnstillinger
              </label>
              <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer;background:var(--ok-light);padding:8px 12px;border-radius:6px;border:1px solid var(--ok-border)">
                <input type="checkbox" id="cap-users" style="width:15px;height:15px"> üë• Brukeradministrasjon
              </label>
            </div>
          </div>
          <button class="btn-primary" style="margin-top:16px" onclick="saveUser()">Lagre bruker</button>
        </div>

        <!-- CATEGORIES MANAGER -->
        <div id="admin-categories" style="display:none">
          <h3 style="font-size:16px;margin-bottom:6px;">‚≠ê Fremhevede artikler</h3>
          <p style="font-size:13px;color:var(--ok-muted);margin-bottom:18px">Disse artiklene vises som kort p√• forsiden. Dra og slipp for √• endre rekkef√∏lge.</p>
          <div class="cat-list" id="cat-list"></div>
          <hr style="border:none;border-top:1px solid var(--ok-border);margin:20px 0">
          <h4 style="font-size:14px;font-weight:500;margin-bottom:14px">Fremhev en artikkel</h4>

          <!-- Article search -->
          <div class="form-group">
            <label>S√∏k etter artikkel</label>
            <div style="position:relative">
              <input id="feat-search" type="text" placeholder="Skriv for √• s√∏ke blant artikler‚Ä¶" oninput="featSearch()" autocomplete="off" style="padding-right:36px">
              <span style="position:absolute;right:12px;top:50%;transform:translateY(-50%);color:var(--ok-muted);pointer-events:none">üîç</span>
            </div>
            <div id="feat-search-results" style="display:none;border:1px solid var(--ok-border);border-top:none;border-radius:0 0 6px 6px;background:white;max-height:200px;overflow-y:auto;margin-top:-1px"></div>
            <div id="feat-selected-article" style="display:none;margin-top:10px;padding:10px 14px;background:var(--ok-accent);border-radius:6px;border:1px solid var(--ok-blue);display:none">
              <div style="font-size:12px;color:var(--ok-blue);font-weight:600;margin-bottom:2px">Valgt artikkel:</div>
              <div id="feat-selected-label" style="font-size:13.5px;font-weight:500"></div>
            </div>
            <input type="hidden" id="feat-selected-id">
          </div>

          <!-- Icon and color pickers -->
          <div class="form-group">
            <label>Ikon</label>
            <div class="icon-picker" id="cat-new-icon-picker"></div>
            <input id="cat-new-icon-val" type="hidden" value="üìÑ">
          </div>
          <div class="form-group">
            <label>Ikonfarge (bakgrunn)</label>
            <div class="color-picker-row" id="cat-new-color-picker"></div>
            <input id="cat-new-color-val" type="hidden" value="#e0e8f7">
          </div>

          <button class="btn-primary" onclick="addFeatured()">‚≠ê Fremhev artikkel</button>
        </div>

      </div>
    </div>
  </div>
</div>

<!-- ANNOUNCEMENT EDIT MODAL -->
<div class="inline-modal-overlay" id="ann-edit-modal">
  <div class="inline-modal">
    <button class="inline-modal-close" onclick="closeAnnEditModal()">√ó</button>
    <h3>Rediger beskjed</h3>
    <input type="hidden" id="ann-edit-id">
    <div class="form-group">
      <label>Tittel</label>
      <input id="ann-edit-title" type="text">
    </div>
    <div class="form-group">
      <label>Innhold</label>
      <textarea id="ann-edit-body" style="min-height:90px"></textarea>
    </div>
    <div class="form-group">
      <label>Type</label>
      <select id="ann-edit-type">
        <option value="info">‚ÑπÔ∏è Info (bl√•)</option>
        <option value="viktig">üî¥ Viktig (r√∏d)</option>
        <option value="ok">‚úÖ Bekreftet (gr√∏nn)</option>
        <option value="advarsel">‚ö†Ô∏è Advarsel (gul)</option>
      </select>
    </div>
    <div class="form-group">
      <label>Signert av (avdeling)</label>
      <input id="ann-edit-author" type="text">
    </div>
    <div style="display:flex;gap:10px;margin-top:4px">
      <button class="btn-primary" onclick="saveAnnEdit()">Lagre endringer</button>
      <button class="btn-secondary" onclick="closeAnnEditModal()">Avbryt</button>
    </div>
  </div>
</div>


<!-- FAVORITES MODAL -->
<div class="inline-modal-overlay" id="favs-modal">
  <div class="inline-modal" style="max-width:500px">
    <button class="inline-modal-close" onclick="document.getElementById('favs-modal').classList.remove('show')">√ó</button>
    <h3>‚≠ê Mine favorittartikler</h3>
    <p style="font-size:13px;color:var(--ok-muted);margin-bottom:16px">Artiklene du har lagret som favoritter. Klikk for √• √•pne.</p>
    <div id="favs-list"></div>
  </div>
</div>

<!-- FEATURED ARTICLE EDIT MODAL -->
<div class="inline-modal-overlay" id="cat-edit-modal">
  <div class="inline-modal">
    <button class="inline-modal-close" onclick="closeCatEditModal()">√ó</button>
    <h3>Rediger fremhevet artikkel</h3>
    <input type="hidden" id="cat-edit-id">
    <div style="margin-bottom:14px;padding:10px 14px;background:var(--ok-accent);border-radius:6px;border-left:3px solid var(--ok-blue)">
      <div style="font-size:11.5px;color:var(--ok-blue);font-weight:600;margin-bottom:2px">Koblet artikkel</div>
      <div id="cat-edit-article-label" style="font-size:13.5px;font-weight:500;color:var(--ok-text)"></div>
    </div>
    <div class="form-group">
      <label>Ikon</label>
      <div class="icon-picker" id="cat-edit-icon-picker"></div>
      <input id="cat-edit-icon-val" type="hidden">
    </div>
    <div class="form-group">
      <label>Ikonfarge (bakgrunn)</label>
      <div class="color-picker-row" id="cat-edit-color-picker"></div>
      <input id="cat-edit-color-val" type="hidden">
    </div>
    <div style="display:flex;gap:10px;margin-top:4px">
      <button class="btn-primary" onclick="saveCatEdit()">Lagre</button>
      <button class="btn-secondary" onclick="closeCatEditModal()">Avbryt</button>
    </div>
  </div>
</div>
<!-- USER EDIT MODAL -->
<div class="inline-modal-overlay" id="user-edit-modal">
  <div class="inline-modal" style="max-width:420px">
    <button class="inline-modal-close" onclick="closeUserEditModal()">√ó</button>
    <h3>Rediger bruker: <span id="uedit-username" style="color:var(--ok-blue)"></span></h3>
    <input type="hidden" id="uedit-name">
    <div class="form-group">
      <label>Nytt passord (la st√• tomt for √• beholde)</label>
      <input id="uedit-pass" type="text" placeholder="Nytt passord (valgfritt)">
    </div>
    <div class="form-group" style="margin-bottom:0">
      <label style="margin-bottom:10px;display:block">Tilganger</label>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer;background:var(--ok-light);padding:8px 12px;border-radius:6px;border:1px solid var(--ok-border)">
          <input type="checkbox" id="uedit-cap-articles" style="width:15px;height:15px"> üìÑ Artikler
        </label>
        <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer;background:var(--ok-light);padding:8px 12px;border-radius:6px;border:1px solid var(--ok-border)">
          <input type="checkbox" id="uedit-cap-announcements" style="width:15px;height:15px"> üì¢ Beskjeder
        </label>
        <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer;background:var(--ok-light);padding:8px 12px;border-radius:6px;border:1px solid var(--ok-border)">
          <input type="checkbox" id="uedit-cap-categories" style="width:15px;height:15px"> üóÇ Kategorier
        </label>
        <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer;background:var(--ok-light);padding:8px 12px;border-radius:6px;border:1px solid var(--ok-border)">
          <input type="checkbox" id="uedit-cap-site" style="width:15px;height:15px"> üé® Nettstedinnstillinger
        </label>
        <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer;background:var(--ok-light);padding:8px 12px;border-radius:6px;border:1px solid var(--ok-border)">
          <input type="checkbox" id="uedit-cap-users" style="width:15px;height:15px"> üë• Brukeradministrasjon
        </label>
      </div>
    </div>
    <div style="display:flex;gap:10px;margin-top:18px">
      <button class="btn-primary" onclick="saveUserEdit()">Lagre endringer</button>
      <button class="btn-secondary" onclick="closeUserEditModal()">Avbryt</button>
    </div>
  </div>
</div>

<!-- PROFILE MODAL -->
<div class="inline-modal-overlay" id="profile-modal">
  <div class="inline-modal" style="max-width:420px">
    <button class="inline-modal-close" onclick="closeProfileModal()">√ó</button>
    <h3>üë§ Min profil</h3>
    <div style="background:var(--ok-accent);border-radius:8px;padding:12px 16px;margin-bottom:18px">
      <p style="font-size:12px;color:var(--ok-muted);margin-bottom:2px">Innlogget som</p>
      <p id="profile-username-display" style="font-size:15px;font-weight:600;color:var(--ok-blue)"></p>
      <div id="profile-caps-display" style="margin-top:8px;display:flex;flex-wrap:wrap;gap:5px"></div>
    </div>
    <div class="form-group">
      <label>Nytt passord</label>
      <input id="profile-new-pass" type="password" placeholder="Skriv nytt passord" autocomplete="new-password">
    </div>
    <div class="form-group">
      <label>Bekreft nytt passord</label>
      <input id="profile-confirm-pass" type="password" placeholder="Gjenta nytt passord" autocomplete="new-password">
    </div>
    <div id="profile-msg" style="font-size:13px;padding:8px 12px;border-radius:6px;margin-bottom:10px;display:none"></div>
    <div style="display:flex;gap:10px">
      <button class="btn-primary" onclick="saveProfilePassword()">Lagre nytt passord</button>
      <button class="btn-secondary" onclick="closeProfileModal()">Avbryt</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="login-modal">
  <div class="modal" style="position:relative;width:420px">
    <button class="modal-close" onclick="closeModal()">√ó</button>
    <h3>Innlogging</h3>
    <p>Ferieportalen ‚Äì Oslo Kommune administrasjon</p>
    <input id="login-user" type="text" placeholder="Brukernavn" autocomplete="username">
    <input id="login-pass" type="password" placeholder="Passord" autocomplete="current-password" onkeydown="if(event.key==='Enter')doLogin()">
    <div class="modal-err" id="login-err" style="display:none">Feil brukernavn eller passord.</div>
    <div class="modal-actions">
      <button class="btn-primary" onclick="doLogin()">Logg inn</button>
      <button class="btn-secondary" onclick="closeModal()">Avbryt</button>
    </div>
    <div style="margin-top:16px;padding-top:14px;border-top:1px solid var(--ok-border);font-size:11.5px;color:var(--ok-muted);line-height:1.7">
      <strong style="color:var(--ok-text)">Demo-brukere:</strong><br>
      OKF L√∏nn: <code>okf</code> / <code>okf2024</code><br>
      HR: <code>hr</code> / <code>hr2024</code><br>
      Master: <code>master</code> / <code>master2024</code>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<!-- FOOTER -->
<div id="last-updated-bar" style="background:#1a1d2e;color:rgba(255,255,255,0.75);font-size:12px;padding:7px 24px;display:none;justify-content:space-between;align-items:center">
  <span id="last-updated-text">üïê Sist oppdatert: ‚Äì</span>
  <span id="last-updated-who" style="color:rgba(255,255,255,0.45)"></span>
</div>
<footer>
  <p id="footer-line1">Ferieportalen ¬∑ Oslo Kommune ¬∑ HR og L√∏nn ¬∑ Basert p√• Dok 25 (2024‚Äì2026), Ferieloven og Oslo kommunes Personalh√•ndbok 2025</p>
  <p style="margin-top:6px"><a href="https://www.oslo.kommune.no" target="_blank">oslo.kommune.no</a> ¬∑ <span id="footer-line2">Innhold er veiledende ‚Äì kontakt l√∏nnstjenesten ved tvil</span></p>
</footer>

<script>
// ============================================================
//  DATA ‚Äì artikler (utfyllende innhold basert p√• Dok 25 + ferieloven)
// ============================================================
let articles = [
  {
    id: 'feriedager',
    title: 'Antall feriedager i Oslo kommune',
    tags: ['feriedager', 'ferie', 'virkedager', 'dok 25', 'femte ferieuke', 'avtalefestet'],
    sources: 'Ferieloven ¬ß 5 nr. 1‚Äì3 ¬∑ Dok 25 kap. 3 ¬∑ Oslo kommunes Personalh√•ndbok 2025 kap. 6',
    modified: '09.04.2025',
    body: `
      <h3>Oversikt over ferierettigheter</h3>
      <p>Alle ansatte i Oslo kommune har rett til <strong>25 virkedagers ferie</strong> per ferie√•r etter ferieloven ¬ß 5 nr. 1. Merk at virkedager inkluderer l√∏rdager, slik at 25 virkedager tilsvarer 4 uker og 1 dag.</p>
      <div class="info-box">üìå <strong>I Oslo kommune er det avtalt en femte ferieuke</strong> gjennom tariffoppgj√∏ret fra 2000/2001 (jf. Dok 25 kap. 3). Dette gir totalt <strong>30 virkedager</strong> (5 uker) ferierett. Men: <strong>kun de dagene det er opptjent feriepenger for, avvikles med l√∏nn.</strong> Rett til ferie og rett til betalt ferie er to separate sp√∏rsm√•l.</div>
      <h3>Betalt ferie ‚Äì avhenger av fjor√•rets opptjening</h3>
      <p>Feriepenger opptjenes i <strong>opptjenings√•ret</strong> (foreg√•ende kalender√•r) og utbetales i ferie√•ret. Antall betalte feriedager bestemmes av opptjeningsgrunnlaget:</p>
      <ul>
        <li>Full opptjening (hele opptjenings√•ret i Oslo kommune): 25 betalte virkedager (+ 5 avtalefestede)</li>
        <li>Delvis opptjening (f.eks. tiltredelse i april fjor√•ret): proporsjonal andel betalte dager</li>
        <li>Ingen opptjening (ny ansatt i innev√¶rende ferie√•r, ingen fjor√•rsopptjening i Oslo kommune): 0 betalte feriedager ‚Äì arbeidstaker kan nekte √• avvikle denne ferien</li>
      </ul>
      <div class="warn-box">‚ö†Ô∏è En ansatt som starter i Oslo kommune i <strong>innev√¶rende ferie√•r</strong> har rett til √• avvikle ferie, men arbeidsgiver kan ikke p√•legge ferieavvikling uten l√∏nn for de dagene det ikke er opptjent feriepenger (jf. ferieloven ¬ß 5 nr. 5).</div>
      <h3>Ferieuke nummer 5 ‚Äì avtalefestet ferie</h3>
      <p>Den femte ferieuken (5 virkedager) er en avtalefestet ordning etter Dok 25 kap. 3. Arbeidsgiver fastsetter tidspunktet etter dr√∏ftinger med tillitsvalgte eller den enkelte arbeidstaker, og dette skjer samtidig med fastsettingen av ordin√¶r ferie.</p>
      <h3>Deltidsansatte</h3>
      <p>Deltidsansatte har rett til samme antall virkedager ferie som fulltidsansatte. Antall faktiske arbeidsdager i ferien reduseres proporsjonalt etter stillingsbr√∏k, men ferie avvikles etter virkedager slik ferieloven fastsetter.</p>
      <div class="warn-box">‚ö†Ô∏è <strong>Merk:</strong> Ferieloven ¬ß 10 (3) 2. ledd kommer ikke til anvendelse i Oslo kommune, jf. Dok 25 kap. 3.</div>

      <div class="calc-box">
        <h3>üßÆ Feriekalkulator for ledere</h3>
        <p style="font-size:13px;color:var(--ok-muted);margin-bottom:16px;margin-top:-8px">
          Beregner ferierett, betalte feriedager og teknisk l√∏nnstrekk i juni basert p√• junil√∏nn.
        </p>
        <div class="calc-grid">
          <div class="calc-field">
            <label>Alder i ferie√•ret (√•r)</label>
            <input id="kalk-alder" type="number" value="35" min="16" max="75" placeholder="35">
          </div>
          <div class="calc-field">
            <label>Brutto m√•nedsl√∏nn i juni (kr)</label>
            <input id="kalk-lonn" type="number" placeholder="F.eks. 52 000" min="0">
          </div>
          <div class="calc-field">
            <label>Faste tillegg i juni (kr, valgfritt)</label>
            <input id="kalk-tillegg" type="number" placeholder="F.eks. 3 000" min="0" value="0">
          </div>
          <div class="calc-field">
            <label>Feriepengeopptjening fjor√•r (kr)</label>
            <input id="kalk-fpopptj" type="number" placeholder="F.eks. 62 400" min="0" title="Totale opptjente feriepenger fra opptjenings√•ret (fjor√•ret) ‚Äì fra l√∏nnssystemet">
          </div>
        </div>
        <button class="calc-run-btn" onclick="runKalkulator()">Beregn</button>
        <div class="calc-result" id="kalk-result"></div>
      </div>
    `
  },
  {
    id: 'feriepenger',
    title: 'Feriepenger ‚Äì beregning og utbetaling',
    tags: ['feriepenger', 'beregning', 'prosent', 'juni', 'utbetaling', 'l√∏nnstrekk', '12 prosent', '14.3 prosent'],
    sources: 'Ferieloven ¬ß¬ß 10‚Äì11 ¬∑ Dok 25 ¬ß 3.1 ¬∑ Oslo kommunes Personalh√•ndbok 2025',
    modified: '09.04.2025',
    body: `
      <h3>Prosentsatser for feriepenger</h3>
      <p>Feriepenger beregnes av feriepengegrunnlaget (l√∏nn utbetalt i opptjenings√•ret) og utgj√∏r:</p>
      <ul>
        <li><strong>12,0 %</strong> for ansatte som er omfattet av avtalefestet ferie (de fleste ansatte i Oslo kommune)</li>
        <li><strong>14,3 %</strong> for ansatte som fyller <strong>60 √•r</strong> i l√∏pet av ferie√•ret</li>
      </ul>
      <div class="info-box">üìå Disse satsene er h√∏yere enn lovens minstesatser (10,2 % / 12,5 %) nettopp fordi Oslo kommune har avtalefestet den femte ferieuken.</div>
      <h3>Utbetaling i juni</h3>
      <p>I Oslo kommune er det praksis at feriepenger utbetales i <strong>juni m√•ned</strong> i ferie√•ret. Dette er avtalt mellom partene og inneb√¶rer at feriel√∏nntillegget (den del av feriepengene som overstiger l√∏nn for vanlig arbeidstid) utbetales samlet med l√∏nnen for juni.</p>
      <h3>Teknisk l√∏nnstrekk</h3>
      <p>N√•r ferie avvikles gjennomf√∏res et teknisk l√∏nnstrekk i juni tilsvarende antall feriedager dividert p√• 26 l√∏nnsuker. For ansatte i Oslo kommune med full ferierett (25 lovfestede + 5 avtalefestede = 30 virkedager) beregnes trekket slik:</p>
      <ul>
        <li>Ansatte med avtalefestet ferie (30 virkedager totalt): trekk = <strong>30/26 av m√•nedsl√∏nn</strong></li>
        <li>Ansatte med kun lovfestet ferie (25 virkedager): trekk = <strong>25/26 av m√•nedsl√∏nn</strong></li>
      </ul>
      <p>Trekket gjennomf√∏res i junil√∏nnen, samme m√•ned som feriepengene utbetales. Netto effekt er at ansatte mottar feriepengene (12 % av fjor√•rets l√∏nn) minus ferietrekket ‚Äì dette gir et positivt ferietillegg i juni for de fleste.</p>
      <h3>Opptjenings√•r ‚Äì det avgj√∏rende prinsippet</h3>
      <p>Feriepenger opptjenes utelukkende i <strong>opptjenings√•ret</strong> (foreg√•ende kalender√•r) og baseres kun p√• l√∏nn utbetalt fra Oslo kommune i dette √•ret. Opptjening starter den dagen ansettelsen tiltrer ‚Äì ikke fra ansettelsesdatoen dersom disse er ulike.</p>
      <ul>
        <li>Ny ansatt 1. mars fjor√•ret: opptjener feriepenger for 10 m√•neder (mars‚Äìdesember)</li>
        <li>Ny ansatt 1. januar i ferie√•ret: har <em>ingen</em> opptjening i Oslo kommune ‚Äì ferietrekket i juni dekkes ikke av opptjente feriepenger</li>
      </ul>
    `
  },
  {
    id: 'fastsettelse',
    title: 'Fastsettelse og planlegging av ferie',
    tags: ['fastsettelse', 'planlegging', 'varsling', 'sommerferie', 'dr√∏fting', 'tillitsvalgt', 'to m√•neder'],
    sources: 'Ferieloven ¬ß¬ß 6‚Äì7 ¬∑ Dok 25 kap. 3 ¬∑ Oslo kommunes Personalh√•ndbok 2025',
    modified: '09.04.2025',
    body: `
      <h3>Hvem bestemmer n√•r ferie tas?</h3>
      <p>Arbeidsgiver fastsetter tidspunktet for ferie etter dr√∏ftinger med de tillitsvalgte eller den enkelte arbeidstaker. Den ansatte kan ikke fritt velge ferietidspunkt uten arbeidsgivers godkjenning, men arbeidsgiver skal ta hensyn til den ansattes √∏nsker og virksomhetens behov.</p>
      <h3>Varslingsfrister</h3>
      <ul>
        <li><strong>Arbeidsgiver</strong> skal varsle om ferietidspunkt <strong>tidligst mulig</strong> og senest <strong>2 m√•neder</strong> f√∏r ferien starter.</li>
        <li><strong>Arbeidstaker</strong> kan kreve √• f√• vite tidspunktet for ferien senest 2 m√•neder i forveien dersom de har konkrete planer.</li>
      </ul>
      <div class="info-box">üìå Jf. ferieloven ¬ß 6 nr. 2 kan arbeidstaker kreve √• bli varslet om feriefastsettingen senest 2 m√•neder f√∏r ferien starter.</div>
      <h3>Rett til 3 uker sammenhengende sommerferie</h3>
      <p>Arbeidstaker har rett til √• avvikle <strong>18 virkedager (3 uker) sammenhengende</strong> i perioden 1. juni‚Äì30. september (ferieloven ¬ß 7 nr. 1). Arbeidsgiver kan ikke avsl√• dette uten s√¶rlig grunn knyttet til driftsforhold.</p>
      <h3>Restferie</h3>
      <p>De resterende 7 virkedagene (+ 5 avtalefestede) kan arbeidstaker kreve avviklet samlet i l√∏pet av ferie√•ret (ferieloven ¬ß 7 nr. 2).</p>
      <h3>Avtalefestet ferie i Oslo kommune</h3>
      <p>Jf. Dok 25 kap. 3 fastsetter arbeidsgiver tidspunktet for den avtalefestede ferien etter dr√∏ftinger med tillitsvalgte eller den enkelte arbeidstaker ‚Äì dette skjer <em>samtidig</em> med fastsettelsen av den ordin√¶re ferien.</p>
      <h3>L√¶rere i Oslo kommune</h3>
      <p>For undervisningspersonell i Oslo kommune avvikles ferie med avslutning siste virkedag i juli. Avtalefestede feriedager anses for √• v√¶re avviklet i de deler av √•ret der det ikke er arbeidsplikt (jf. Dok 25 punkt 3.1.2.1).</p>
    `
  },
  {
    id: 'sykdom',
    title: 'Sykdom under ferie',
    tags: ['sykdom', 'sykemeldt', 'erstatningsferie', 'utsettelse', 'legeerkl√¶ring', 'sykdom ferie'],
    sources: 'Ferieloven ¬ß 9 ¬∑ Dok 25 kap. 3 ¬∑ Oslo kommunes Personalh√•ndbok 2025',
    modified: '09.04.2025',
    body: `
      <h3>Rett til erstatningsferie ved sykdom</h3>
      <p>Dersom en ansatt er <strong>100 % arbeidsuf√∏r</strong> (dvs. sykmeldt i fullt omfang) under ferie, har vedkommende rett til √• kreve tilsvarende feriedager erstattet etter ferien (ferieloven ¬ß 9 nr. 1).</p>
      <div class="warn-box">‚ö†Ô∏è Krav om utsettelse av ferie p√• grunn av sykdom <strong>m√• fremsettes senest f√∏rste arbeidsdag</strong> etter at arbeidstakeren er tilbake fra sykefrav√¶ret. Fristen er absolutt.</div>
      <h3>Dokumentasjonskrav</h3>
      <ul>
        <li>Arbeidstaker m√• fremlegge <strong>legeerkl√¶ring</strong> som dokumenterer arbeidsuf√∏rheten.</li>
        <li>Egenmeldingen gjelder ikke som grunnlag for krav om erstatningsferie.</li>
        <li>Legeerkl√¶ringen m√• dekke hele perioden som kreves erstattet.</li>
      </ul>
      <h3>Delvis sykmelding</h3>
      <p>Arbeidstaker som er gradert sykmeldt (f.eks. 50 %) under ferie har <em>ikke</em> rett til erstatningsferie. Retten forutsetter full arbeidsuf√∏rhet i hele ferieperioden.</p>
      <h3>Tilbakekalling fra ferie</h3>
      <p>Arbeidsgiver har <strong>ikke hjemmel i ferieloven</strong> til √• tilbakekalle en ansatt fra ferie. Dersom arbeidsforholdet krever dette i en n√∏dssituasjon, m√• dette avtales separat, og arbeidsgiver plikter da √• dekke alle merutgifter samt kompensere for velferdstapet.</p>
      <h3>Sykdom f√∏r feriestart</h3>
      <p>Dersom arbeidstaker er syk og sykmeldt <em>f√∏r</em> ferien starter, kan vedkommende kreve ferien utsatt til senere i ferie√•ret. Kravet m√• fremsettes senest siste arbeidsdag f√∏r feriestart (ferieloven ¬ß 9 nr. 2).</p>
    `
  },
  {
    id: 'overfoering',
    title: 'Overf√∏ring av ferie til neste √•r',
    tags: ['overf√∏ring', 'restferie', 'neste √•r', 'avtale', 'fremf√∏ring'],
    sources: 'Ferieloven ¬ß 7 nr. 3 og ¬ß 11 nr. 2 ¬∑ Dok 25 kap. 3 ¬∑ Personalh√•ndboken 2025',
    modified: '09.04.2025',
    body: `
      <h3>Utgangspunkt: plikt til √• avvikle ferie</h3>
      <p>Arbeidstaker har b√•de rett og <strong>plikt</strong> til √• avvikle ferien hvert ferie√•r. Arbeidsgiver har tilsvarende plikt til √• s√∏rge for at ansatte faktisk avvikler ferien sin (ferieloven ¬ß 5 nr. 3).</p>
      <h3>Lovfestet adgang til overf√∏ring</h3>
      <p>Inntil <strong>12 virkedager</strong> (2 uker) av den lovfestede ferien kan overf√∏res til neste ferie√•r ved skriftlig avtale mellom arbeidstaker og arbeidsgiver (ferieloven ¬ß 7 nr. 3).</p>
      <div class="info-box">üìå Overf√∏ring <strong>krever skriftlig avtale</strong>. Arbeidsgiver kan ikke ensidig bestemme at ferie skal overf√∏res, og arbeidstaker kan heller ikke alene kreve overf√∏ring utover grensene.</div>
      <h3>Overf√∏ring av avtalefestet ferie (Dok 25)</h3>
      <p>Den avtalefestede ferien (den femte ferieuken) f√∏lger tilsvarende regler. Dersom virksomhetsforhold hindret avvikling, b√∏r dette dokumenteres skriftlig og overf√∏ring avtales i god tid.</p>
      <h3>Manglende avvikling ‚Äì arbeidsgivers ansvar</h3>
      <p>Dersom arbeidsgiver ikke legger til rette for at ferien kan avvikles i ferie√•ret, har arbeidstaker krav p√• erstatning for det √∏konomiske tapet (feriepengene som ikke ble ¬´brukt¬ª). Arbeidsgiver kan ikke fraskrive seg ansvaret for manglende tilrettelegging.</p>
      <h3>Overf√∏ring ved sykdom eller permisjon</h3>
      <p>Ferie som ikke ble avviklet fordi arbeidstaker var sykmeldt eller i foreldrepermisjon gjennom hele ferie√•ret, kan overf√∏res til neste ferie√•r uten begrensning (ferieloven ¬ß 9 nr. 2).</p>
    `
  },
  {
    id: 'ekstraferie',
    title: 'Ekstraferie for arbeidstakere over 60 √•r',
    tags: ['ekstraferie', '60 √•r', 'senior', 'eldre', 'ekstra feriedager', '6 virkedager'],
    sources: 'Ferieloven ¬ß 5 nr. 2 ¬∑ Dok 25 kap. 3 ¬∑ Personalh√•ndboken 2025',
    modified: '09.04.2025',
    body: `
      <h3>Rett til 6 ekstra virkedager</h3>
      <p>Arbeidstaker som <strong>fyller 60 √•r i l√∏pet av ferie√•ret</strong> har krav p√• <strong>6 ekstra virkedager</strong> ferie (ferieloven ¬ß 5 nr. 2). Dette tilsvarer √©n ekstra uke. Retten gjelder fra og med det kalender√•ret arbeidstakeren fyller 60 √•r.</p>
      <p>Dok 25 kap. 3 opprettholder denne retten eksplisitt for ansatte i Oslo kommune.</p>
      <h3>Varslingsfrist</h3>
      <p>Arbeidstaker bestemmer selv n√•r ekstraferien skal tas. Arbeidsgiver <strong>m√• varsles minst 2 uker</strong> i forveien. Ekstraferien kan tas samlet eller en eller flere dager av gangen (jf. ferieloven ¬ß 6 nr. 2).</p>
      <div class="info-box">üìå Arbeidstaker kan alts√• ta ekstraferien uten at arbeidsgiver kan nekte, s√• lenge varslingsfristen p√• 2 uker overholdes.</div>
      <h3>Feriepenger for ekstraferien</h3>
      <p>Feriepengeprosenten √∏kes til <strong>14,3 %</strong> (mot 12 % for √∏vrige ansatte) for arbeidstakere over 60 √•r. Dette for √• dekke den ekstra uka.</p>
      <h3>Deling av ekstraferien</h3>
      <p>Deles ekstraferien opp, kan arbeidstaker bare kreve √• f√• fri s√• mange arbeidsdager som vedkommende normalt har i l√∏pet av en uke. En deltidsansatt som jobber 3 dager i uka kan alts√• bare kreve 3 dager fri dersom ekstraferien deles.</p>
    `
  },
  {
    id: 'nyansatt',
    title: 'Ferie for nye ansatte og ved sluttdato',
    tags: ['ny ansatt', 'tiltredelse', 'sluttdato', 'oppsigelse', 'ikke opptjent', 'f√∏rste √•r'],
    sources: 'Ferieloven ¬ß¬ß 5, 10, 11 ¬∑ Dok 25 kap. 3 ¬∑ Personalh√•ndboken 2025',
    modified: '09.04.2025',
    body: `
      <h3>Ny ansatt ‚Äì feriedager</h3>
      <p>Alle ansatte har rett til <strong>full ferie (25 / 30 virkedager)</strong> fra og med tiltredelsesdatoen, uavhengig av om de har opptjent feriepenger fra Oslo kommune.</p>
      <div class="warn-box">‚ö†Ô∏è Selv om retten til feriedager er til stede, er retten til <strong>feriepenger</strong> avhengig av opptjening. En ansatt som begynner 1. januar har ikke opptjent feriepenger i opptjenings√•ret og kan motta redusert eller ingen feriel√∏nn f√∏rste √•r. Arbeidstaker kan da <em>nekte</em> √• avvikle den del av ferien det ikke er opptjent feriepenger for (ferieloven ¬ß 5 nr. 5).</div>
      <h3>Tiltredelsestidspunktet</h3>
      <p>Etter Dok 25 er tiltredelsestidspunktet den dag ansettelsen gjelder fra og vedkommende kunne ha tiltr√•dt. Det er en forutsetning for rettigheter at arbeidstakeren har tiltr√•dt stillingen.</p>
      <h3>Ansatt fra annen arbeidsgiver</h3>
      <p>Feriepenger opptjent hos tidligere arbeidsgiver utbetales direkte fra den tidligere arbeidsgiveren og gjelder ferie√•rets avvikling hos Oslo kommune. Ansatte b√∏r s√∏rge for at feriepengeattest fra forrige arbeidsgiver er registrert.</p>
      <h3>Avslutning av arbeidsforhold</h3>
      <p>Ved fratreden skal opptjente og ikke-avviklede feriepenger utbetales. Dersom arbeidstaker har avviklet mer ferie enn opptjente feriepenger tilsier, kan arbeidsgiver trekke differansen i siste l√∏nnsutbetaling (ferieloven ¬ß 11 nr. 3).</p>
      <p>Restsaldo av avviklet ferie ved oppsigelse m√• alltid avklares mellom HR, leder og l√∏nnstjenesten.</p>
    `
  },
  {
    id: 'lonntrekk',
    title: 'L√∏nnstrekk og ferietrekkordningen',
    tags: ['l√∏nnstrekk', 'ferietrekk', 'l√∏nn under ferie', 'teknisk trekk', '30/26', 'juni utbetaling'],
    sources: 'Dok 25 ¬ß 3.1 ¬∑ Ferieloven ¬ß 10 ¬∑ Personalh√•ndboken 2025 kap. 6',
    modified: '09.04.2025',
    body: `
      <h3>Prinsippet bak trekkordningen</h3>
      <p>I Oslo kommune benyttes en trekkordningsmodell der vanlig l√∏nn utbetales under ferieavvikling, og det gjennomf√∏res et teknisk l√∏nnstrekk for √• balansere mot feriepengeutbetalingen i juni.</p>
      <h3>Teknisk l√∏nnstrekk</h3>
      <ul>
        <li>For ansatte med <strong>avtalefestet ferie (30 virkedager)</strong>: trekk = <strong>30/26 av m√•nedsl√∏nn</strong></li>
        <li>For ansatte med kun <strong>lovfestet ferie (25 virkedager)</strong>: trekk = <strong>25/26 av m√•nedsl√∏nn</strong></li>
      </ul>
      <div class="info-box">üìå Trekket gj√∏res i den m√•neden feriepengene utbetales (juni). Det tekniske trekket og feriepengeutbetalingen gjennomf√∏res samlet i junil√∏nnen. Ansatte mottar da feriepengene, men f√•r ogs√• trekket, slik at netto betalingen reflekterer normalt l√∏nnsniv√•.</div>
      <h3>Feriel√∏nntillegget</h3>
      <p>Den del av feriepengene som overstiger l√∏nn for vanlig arbeidstid (feriel√∏nnstillegget) utbetales separat i juni. For de fleste vil dette si at junil√∏nnen er noe h√∏yere enn normalt, ettersom feriepengeprosenten (12 %) er h√∏yere enn hva som dekker bare ordin√¶r l√∏nn.</p>
      <h3>Praktisk eksempel</h3>
      <p>En ansatt med m√•nedsl√∏nn p√• 50 000 kr:</p>
      <ul>
        <li>Feriepengegrunnlag (√•rsl√∏nn fra fjor√•ret): 600 000 kr √ó 12 % = 72 000 kr i feriepenger</li>
        <li>Teknisk l√∏nnstrekk i juni: 50 000 √ó (30/26) ‚âà 57 692 kr</li>
        <li>Netto ferietillegg i juni: 72 000 ‚àí 57 692 ‚âà 14 308 kr ekstra</li>
      </ul>
      <p>I tillegg mottar vedkommende vanlig l√∏nn gjennom √•ret, inkludert i feriem√•nedene.</p>
      <h3>Sp√∏rsm√•l til l√∏nnstjenesten</h3>
      <p>Dersom ansatte har sp√∏rsm√•l om konkrete trekk eller utbetalinger, skal dette rettes til <strong>Oslo kommunes l√∏nnstjeneste</strong> via Personalportalen eller leder.</p>
    `
  }
];

// ============================================================
//  STATE
// ============================================================
let currentUser = null;
let currentArticleId = null;

// ‚îÄ‚îÄ Available icons and colours for category picker ‚îÄ‚îÄ
const ICONS = ['üìÖ','üí∞','üìã','üè•','üîÑ','üéÇ','üë§','üìä','üìÅ','‚öñÔ∏è','üóì','üíº','üèñ','üìù','üîî','‚úÖ','‚ÑπÔ∏è','üìå','üîë','üèõ','üë•','üí°','üì£','üïê','üö®','üìÉ','üßÆ','üì§'];
const COLORS = ['#e0e8f7','#e0f4ec','#fef3d8','#fde8ec','#ede0f7','#e0f0f7','#f7ede0','#e8f7e0','#f0e0f7','#d8f0fe'];

// ‚îÄ‚îÄ Categories data (drives the card grid on home page) ‚îÄ‚îÄ
let categories = [
  { id: 'cat1', icon: 'üìÖ', color: '#e0e8f7', title: 'Antall feriedager',    desc: 'Lovfestet og avtalefestet ferie ‚Äì hvem har krav p√• hva etter Dok 25 og ferieloven?', link: 'feriedager' },
  { id: 'cat2', icon: 'üí∞', color: '#e0f4ec', title: 'Feriepenger',           desc: 'Beregning, prosentsatser, trekkordning og utbetaling i juni.',                         link: 'feriepenger' },
  { id: 'cat3', icon: 'üìã', color: '#fef3d8', title: 'Fastsettelse av ferie', desc: 'Regler om hvem som bestemmer, frister og dr√∏ftingskrav.',                              link: 'fastsettelse' },
  { id: 'cat4', icon: 'üè•', color: '#fde8ec', title: 'Sykdom under ferie',   desc: 'Rett til ny ferie ved sykdom, dokumentasjonskrav og prosedyre.',                       link: 'sykdom' },
  { id: 'cat5', icon: 'üîÑ', color: '#e0e8f7', title: 'Overf√∏ring av ferie',  desc: 'N√•r kan ferie overf√∏res til neste √•r? Avtalte og lovbestemte grenser.',                link: 'overfoering' },
  { id: 'cat6', icon: 'üéÇ', color: '#e0f4ec', title: 'Ekstraferie 60 √•r+',   desc: 'Rett til 6 ekstra virkedager, varslingsfrist og fleksibilitet.',                       link: 'ekstraferie' },
  { id: 'cat7', icon: 'üë§', color: '#fef3d8', title: 'Ny ansatt / slutt',    desc: 'Ferierettigheter ved tiltredelse, oppsigelse og √•rstall-overganger.',                  link: 'nyansatt' },
  { id: 'cat8', icon: 'üìä', color: '#fde8ec', title: 'L√∏nnstrekk og l√∏nn',   desc: 'Teknisk l√∏nnstrekk, ferietrekk og sammenhengen med feriepenger.',                      link: 'lonntrekk' },
];

// ‚îÄ‚îÄ User database (demo ‚Äì replace with server auth in production) ‚îÄ‚îÄ
let users = [
  { username: 'okf',    password: 'okf2024',    role: 'okf',    label: 'OKF L√∏nn',     caps: { articles: true,  announcements: true,  categories: true,  site: false, users: false } },
  { username: 'hr',     password: 'hr2024',     role: 'hr',     label: 'HR-avdelingen', caps: { articles: true,  announcements: true,  categories: true,  site: false, users: false } },
  { username: 'master', password: 'master2024', role: 'master', label: 'Master',         caps: { articles: true,  announcements: true,  categories: true,  site: true,  users: true  } },
];

// Role capabilities
const roleCapabilities = {
  okf:    { articles: true,  announcements: true,  site: false, users: false, label: 'OKF (L√∏nn)',    badge: 'role-okf' },
  hr:     { articles: true,  announcements: true,  site: false, users: false, label: 'HR',            badge: 'role-hr'  },
  master: { articles: true,  announcements: true,  site: true,  users: true,  label: 'Master',        badge: 'role-master' },
};

let announcements = [
  { id: 'ann1', title: 'Frist for ferie√∏nsker 2025', body: 'Alle ansatte m√• levere ferie√∏nsker til n√¶rmeste leder innen 1. mars 2025. Bruk Personalportalen.', type: 'viktig', date: '05.02.2025', author: 'HR-avdelingen' },
  { id: 'ann2', title: 'Ny veileder for l√¶rere',     body: 'Oppdatert veileder for ferieavvikling i skolen er n√• tilgjengelig. Se artikkel om fastsettelse.',   type: 'info',   date: '10.01.2025', author: 'L√∏nnstjenesten' }
];

// Site settings (editable by master)
let siteSettings = {
  topbarLeft:       'Oslo kommune ‚Äì Internt HR-verkt√∏y',
  topbarRight:      'üìã Ferieportalen v1.0 ¬∑ Basert p√• Dok 25 (2024‚Äì2026) og ferieloven',
  portalName:       'Ferieportalen',
  portalSub:        'Oslo Kommune ¬∑ HR & L√∏nn',
  logoLetter:       'O',
  heroTitle:        'Finn svar om ferie i Oslo kommune',
  heroSub:          'S√∏k i reglement, Dok 25, ferieloven og interne retningslinjer for HR, ledere og l√∏nnstjenesten.',
  featuredTitle:    'Fremhevede artikler',
  annHeader:        'üì¢ Viktige beskjeder',
  recentHeader:     'üìÑ Sist publiserte artikler',
  footer1:          'Ferieportalen ¬∑ Oslo Kommune ¬∑ HR og L√∏nn ¬∑ Basert p√• Dok 25 (2024‚Äì2026), Ferieloven og Oslo kommunes Personalh√•ndbok 2025',
  footer2:          'oslo.kommune.no ¬∑ Innhold er veiledende ‚Äì kontakt l√∏nnstjenesten ved tvil',
  colorBlue:        '#003087',
  colorRed:         '#C8102E',
  colorGreen:       '#1a7a4a',
  colorAccent:      '#e8ecf7',
  colorLight:       '#f5f6fa',
  quickTags: [
    { label: 'Antall feriedager',   query: 'Feriedager antall' },
    { label: 'Feriepenger',         query: 'Feriepenger' },
    { label: 'Sykdom under ferie',  query: 'Sykdom under ferie' },
    { label: 'Ekstraferie 60+',     query: 'Ekstraferie over 60' },
    { label: 'Overf√∏ring av ferie', query: 'Overf√∏ring ferie' },
    { label: 'Fastsettelse',        query: 'Fastsettelse ferie' },
    { label: 'Ny ansatt',           query: 'Ny ansatt ferie' },
    { label: 'Utbetaling juni',     query: 'Feriepenger utbetaling' },
  ],
  contactTitle:  'üìû Kontakt og hjelp',
  contactIntro:  'Usikker p√• hvem du skal kontakte? Her er oversikten over hvem som hjelper med hva.',
  contacts: [
    { id:'c1', icon:'üè¶', title:'L√∏nnstjenesten (OKF)',  body:'Sp√∏rsm√•l om feriepenger, l√∏nnstrekk, utbetalinger og feil i l√∏nn.', phone:'02 180 (sentralbord)', email:'', web:'Personalportalen|https://www.oslo.kommune.no', note:'√Öpningstid: 08:00‚Äì15:30 mandag‚Äìfredag' },
    { id:'c2', icon:'üë•', title:'HR-avdelingen',          body:'Sp√∏rsm√•l om rettigheter, regelverk, fastsettelse og konflikter rundt ferieavvikling.', phone:'Ring din n√¶rmeste HR-partner', email:'hr@oslo.kommune.no', web:'', note:'Finn din HR-partner i Personalportalen' },
    { id:'c3', icon:'ü§ù', title:'Tillitsvalgt',            body:'Bistand ved uenighet med leder, tolkning av tariffavtale (Dok 25) og brudd p√• rettigheter.', phone:'', email:'', web:'oslo.kommune.no/fagforeninger|https://www.oslo.kommune.no', note:'Fagforeninger: LO Stat, Unio, YS, Akademikerne' },
    { id:'c4', icon:'üë§', title:'N√¶rmeste leder',          body:'Ferie√∏nsker, fastsettelse av ferietidspunkt, praktisk tilrettelegging og l√∏pende dialog.', phone:'', email:'', web:'', note:'Leder er din f√∏rste kontakt for feriesaker' },
    { id:'c5', icon:'‚öñÔ∏è', title:'Arbeidstilsynet',         body:'Tilsyn med etterlevelse av ferieloven. Kontakt ved alvorlige brudd p√• lovfestede rettigheter.', phone:'73 19 97 00', email:'', web:'arbeidstilsynet.no|https://www.arbeidstilsynet.no', note:'Siste utvei ‚Äî pr√∏v intern dialog f√∏rst' },
    { id:'c6', icon:'üìö', title:'Nyttige lenker', body:'', phone:'', email:'', web:'Ferieloven p√• Lovdata|https://lovdata.no/dokument/NL/lov/1988-04-29-21\nPersonalportalen|https://www.oslo.kommune.no\nDok 25 tariffavtale|https://www.oslo.kommune.no\nPersonalh√•ndboken 2025|https://www.oslo.kommune.no', note:'' },
  ],
  faqTitle: '‚ùì Vanlige sp√∏rsm√•l',
  faqs: [
    { id:'f1', q:'Kan arbeidsgiver tvinge meg til √• ta ferie i en bestemt periode?', a:'<strong>Ja, innenfor lovens rammer.</strong> Arbeidsgiver fastsetter ferietidspunktet etter dr√∏fting med den ansatte eller tillitsvalgte, men har siste ord. Arbeidsgiver plikter √• varsle minst <strong>2 m√•neder</strong> i forveien (ferieloven ¬ß 6 nr. 2). Du har rett til minst 18 virkedager (3 uker) sammenhengende sommerferie mellom 1. juni og 30. september.' },
    { id:'f2', q:'Hva skjer med ferie jeg ikke rakk √• ta?', a:'Ferie som ikke er avviklet kan overf√∏res til neste ferie√•r etter avtale ‚Äî opptil <strong>10 virkedager</strong> (lovbestemt del) og ytterligere dager dersom det er avtalt. Restferie som ikke overf√∏res og som skyldes arbeidsgivers forhold, skal utbetales i l√∏nn ved √•rets slutt.' },
    { id:'f3', q:'Jeg ble syk under ferien ‚Äî har jeg rett til ny ferie?', a:'<strong>Ja.</strong> Dersom du er syk i minst √©n dag under avviklet ferie og dokumenterer dette med legeattest, har du rett til erstatningsferie for de dagene du var syk. Du m√• fremlegge dokumentasjonen uten ugrunnet opphold n√•r du er tilbake p√• jobb.' },
    { id:'f4', q:'Hva er forskjellen mellom ¬´feriedager¬ª og ¬´virkedager¬ª?', a:'Ferieloven opererer med <strong>virkedager</strong>, som inkluderer <em>alle ukedager unntatt s√∏ndager og helligdager</em> ‚Äî alts√• ogs√• l√∏rdager. 25 virkedager tilsvarer 4 uker og 1 dag. Oslo kommunes 5. ferieuke gir totalt 30 virkedager.' },
    { id:'f5', q:'Hvordan beregnes feriepenger for deltidsansatte?', a:'Deltidsansatte opptjener feriepenger av den faktiske l√∏nnen utbetalt i opptjenings√•ret, akkurat som fulltidsansatte. Prosentsatsene (12 % / 14,3 % for over 60 √•r) er de samme. En 60 %-stilling gir feriepenger av 60 %-l√∏nnen.' },
    { id:'f6', q:'Kan jeg ta igjen tapt ferie fra foreldrepermisjon?', a:'<strong>Ferierettigheter opptjenes under foreldrepermisjon</strong>, men feriepenger opptjenes kun for de f√∏rste 13 uker av permisjonen (jf. ferieloven ¬ß 10 nr. 4). Ansatte som ikke fikk avviklet ferie pga. foreldrepermisjon har rett til √• overf√∏re disse dagene til neste ferie√•r.' },
    { id:'f7', q:'Hva betyr ¬´teknisk l√∏nnstrekk¬ª i junil√∏nnen?', a:'I Oslo kommune utbetales feriepenger i juni. Samtidig gjennomf√∏res et <strong>teknisk l√∏nnstrekk</strong> tilsvarende antall feriedager √ó dagsats. Netto effekt er vanligvis et lite positivt tillegg i juni. Bruk kalkulatoren i artikkelen ¬´Antall feriedager¬ª for eksakt beregning.' },
    { id:'f8', q:'Jeg slutter ‚Äî hva skjer med opptjente feriepenger?', a:'Ved opph√∏r av arbeidsforhold skal alle <strong>opptjente feriepenger utbetales</strong> i siste l√∏nnsoppgj√∏r. Dersom du har tatt ut mer ferie enn du har opptjent rett til l√∏nn for, kan arbeidsgiver i visse tilfeller trekke i l√∏nn.' },
  ],
};

// ============================================================
//  PAGES
// ============================================================
function showPage(name) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById('page-' + name).classList.add('active');
}

// ============================================================
//  SEARCH
// ============================================================
function doSearch() {
  const q = document.getElementById('search-input').value.trim();
  if (!q) return;
  document.getElementById('search-input2').value = q;
  runSearch(q);
}
function doSearch2() {
  const q = document.getElementById('search-input2').value.trim();
  if (!q) return;
  document.getElementById('search-input').value = q;
  runSearch(q);
}
function quickSearch(q) {
  document.getElementById('search-input').value = q;
  document.getElementById('search-input2').value = q;
  runSearch(q);
}

// Synonym map ‚Äî maps search words to related terms
const SYNONYMS = {
  'ferie':       ['ferie', 'feriedager', 'feriepenger', 'avspasering', 'fri'],
  'penger':      ['penger', 'feriepenger', 'l√∏nn', 'utbetaling', 'trekk', 'inntekt'],
  'syk':         ['syk', 'sykdom', 'sykmelding', 'sykemelding', 'sykefrav√¶r'],
  'overf√∏ring':  ['overf√∏ring', 'overf√∏re', 'restferie', 'neste √•r'],
  'ny ansatt':   ['ny ansatt', 'nyansatt', 'tiltredelse', 'begynte'],
  'slutt':       ['slutt', 'oppsigelse', 'slutter', 'avslutning'],
  'gammel':      ['gammel', 'senior', 'ekstraferie', '60', 'eldre'],
  'fastsettelse':['fastsettelse', 'fastsette', 'planlegge', 'plan', 'dr√∏fting'],
  'trekk':       ['trekk', 'l√∏nnstrekk', 'ferietrekk', 'trekkordning', 'juni'],
  'beregning':   ['beregning', 'beregne', 'kalkulator', 'kalkulere', 'regne'],
  'permisjon':   ['permisjon', 'foreldrepermisjon', 'f√∏dselspermisjon'],
  'delvis':      ['delvis', 'gradert', 'deltid', 'redusert'],
};

function expandQuery(q) {
  const terms = q.toLowerCase().split(/\s+/).filter(Boolean);
  const expanded = new Set(terms);
  terms.forEach(term => {
    Object.entries(SYNONYMS).forEach(([key, vals]) => {
      if (key.includes(term) || term.includes(key) || vals.some(v => v.includes(term))) {
        vals.forEach(v => expanded.add(v));
      }
    });
  });
  return { original: terms, expanded: [...expanded] };
}

function scoreArticle(a, terms, expanded) {
  const titleLow = a.title.toLowerCase();
  const tagsLow  = a.tags.join(' ').toLowerCase();
  const bodyLow  = stripTags(a.body).toLowerCase();
  let score = 0;
  let matchedTerms = 0;

  terms.forEach(term => {
    if (titleLow.includes(term)) { score += 10; matchedTerms++; }
    else if (tagsLow.includes(term)) { score += 5; matchedTerms++; }
    else if (bodyLow.includes(term)) { score += 2; matchedTerms++; }
  });
  // Bonus for synonym/expanded matches (softer)
  expanded.forEach(term => {
    if (!terms.includes(term)) {
      if (titleLow.includes(term)) score += 3;
      else if (tagsLow.includes(term)) score += 2;
      else if (bodyLow.includes(term)) score += 1;
    }
  });
  return { score, matchedTerms };
}

function runSearch(q) {
  const { original, expanded } = expandQuery(q);
  const results = articles
    .map(a => ({ a, ...scoreArticle(a, original, expanded) }))
    .filter(r => r.score > 0)
    .sort((x, y) => y.score - x.score);

  lastSearchResults = results;
  lastSearchQuery   = q;

  document.getElementById('results-heading').textContent = 'Resultater for \u00ab' + q + '\u00bb';

  renderSearchResults(results, q);
  showPage('results');
  announceToSR(results.length + ' treff for ' + q);
}

function stripTags(html) {
  return html.replace(/<[^>]+>/g, ' ').replace(/\s+/g, ' ').trim();
}

// ============================================================
//  ARTICLE
// ============================================================
function openArticle(id) {
  const a = articles.find(x => x.id === id);
  if (!a) return;
  currentArticleId = id;

  const caps = currentUser ? getUserCaps(currentUser) : {};
  if (a.status === 'draft' && !caps.articles) { showToast('\u26a0\ufe0f Denne artikkelen er ikke publisert enn\u00e5'); return; }

  document.getElementById('article-breadcrumb').textContent = a.title;
  const canEdit  = currentUser && caps.articles;
  const favActive = isFavorite(id);
  const readTime  = calcReadingTime(a.body);
  const newBadge  = isNew(a.modified) ? '<span class="badge-new">Ny</span>' : '';

  const toolbar = '<div class="article-toolbar">' +
    '<button class="article-tool-btn" onclick="history.back()">‚Üê Tilbake</button>' +
    '<button class="article-tool-btn' + (favActive ? ' fav-active' : '') + '" id="fav-btn-' + id + '" onclick="handleFavToggle(\'' + id + '\')">' +
      (favActive ? '‚≠ê Lagret' : '‚òÜ Favoritt') + '</button>' +
    '<button class="article-tool-btn" onclick="printArticle()">üñ® Skriv ut / PDF</button>' +
    (canEdit ? '<button class="article-tool-btn" onclick="editArticleFromView(\'' + id + '\')">‚úè Rediger</button>' : '') +
    '<span class="reading-time">üïê ' + readTime + '</span>' +
    '</div>';

  const related = getRelatedArticles(a, 3);
  const relatedHtml = related.length > 0
    ? '<div class="related-section"><h4>üìé Relaterte artikler</h4><div class="related-list">' +
      related.map(r => '<div class="related-item" onclick="openArticle(\'' + r.id + '\')" tabindex="0" role="link"><h5>' + r.title + '</h5><p>' + r.tags.slice(0,3).join(' ¬∑ ') + '</p></div>').join('') +
      '</div></div>'
    : '';

  const feedbackHtml = '<div class="feedback-box"><p>Var denne artikkelen nyttig?</p>' +
    '<div class="feedback-btns">' +
    '<button class="feedback-btn" onclick="submitFeedback(\'' + id + '\',true)">üëç Ja, nyttig</button>' +
    '<button class="feedback-btn" onclick="submitFeedback(\'' + id + '\',false)">üëé Mangler informasjon</button>' +
    '</div><div id="feedback-msg" style="display:none;margin-top:10px;font-size:13px"></div></div>';

  const statusBadge = (a.status === 'draft') ? '<span class="status-badge status-draft" style="margin-left:8px">Utkast</span>' :
    (a.status === 'archived') ? '<span class="status-badge status-archived" style="margin-left:8px">Arkivert</span>' : '';

  document.getElementById('article-content').innerHTML =
    toolbar +
    '<div class="article-header">' +
    '<h2>' + a.title + ' ' + newBadge + statusBadge + '</h2>' +
    '<div class="article-meta">' +
    '<span>üìÖ Sist oppdatert: ' + a.modified + '</span>' +
    '<span>üè∑ ' + a.tags.slice(0,5).join(', ') + '</span>' +
    '</div></div>' +
    '<div class="article-body">' + a.body + '</div>' +
    '<div class="source-box"><strong>Kilder og hjemler:</strong> ' + (a.sources || 'Ikke oppgitt') + '</div>' +
    '<p style="margin-top:14px;font-size:12.5px;color:var(--ok-muted)">Innholdet er veiledende. Kontakt l\u00f8nnstjenesten eller HR ved juridisk usikkerhet.</p>' +
    relatedHtml + feedbackHtml;

  showPage('article');
  announceToSR('Artikkel \u00e5pnet: ' + a.title);
}

function handleFavToggle(id) {
  const isNowFav = toggleFavorite(id);
  const btn = document.getElementById('fav-btn-' + id);
  if (btn) {
    btn.innerHTML = isNowFav ? '‚≠ê Lagret' : '‚òÜ Favoritt';
    btn.classList.toggle('fav-active', isNowFav);
  }
}

function editArticleFromView(id) {
  showPage('admin');
  editArticle(id);
}

// ============================================================
//  ANNOUNCEMENTS
// ============================================================
const annBadgeMap = {
  viktig: ['ann-badge-red', 'üî¥ Viktig'],
  info:   ['ann-badge-blue', '‚ÑπÔ∏è Info'],
  ok:     ['ann-badge-green', '‚úÖ Bekreftet'],
  advarsel:['ann-badge-yellow','‚ö†Ô∏è Advarsel']
};

function renderRecentArticles() {
  const el = document.getElementById('recent-articles-list');
  if (!el) return;
  // Sort by modified date descending ‚Äî use articles array order as fallback (newest custom articles last)
  const sorted = [...articles].sort((a, b) => {
    // Parse Norwegian date format dd.mm.yyyy
    const parse = d => {
      const p = (d || '').split('.');
      if (p.length === 3) return new Date(p[2], p[1]-1, p[0]);
      return new Date(0);
    };
    return parse(b.modified) - parse(a.modified);
  }).slice(0, 6);

  el.innerHTML = sorted.map(a => `
    <div class="ann-item" onclick="openArticle('${a.id}')" style="cursor:pointer;transition:background .1s"
         onmouseover="this.style.background='var(--ok-light)'" onmouseout="this.style.background=''">
      <div class="ann-item-title" style="gap:0;flex-direction:column;align-items:flex-start">
        <span style="font-weight:500;color:var(--ok-blue)">${a.title}</span>
      </div>
      <div class="ann-item-body" style="margin-top:3px">${stripTags(a.body).substring(0, 80)}‚Ä¶</div>
      <div class="ann-item-meta" style="display:flex;justify-content:space-between;align-items:center">
        <span>${a.tags.slice(0,2).map(t => `<span style="background:var(--ok-accent);padding:1px 6px;border-radius:8px;font-size:10.5px;color:var(--ok-blue)">${t}</span>`).join(' ')}</span>
        <span>üìÖ ${a.modified}</span>
      </div>
    </div>`).join('');
}

function renderAnnouncements() {
  const list = document.getElementById('ann-list');
  const countLabel = document.getElementById('ann-count-label');
  if (!list) return;
  // Filter expired announcements
  const today = new Date(); today.setHours(0,0,0,0);
  const active = announcements.filter(a => {
    if (!a.expires) return true;
    const exp = new Date(a.expires);
    return exp >= today;
  });
  if (active.length === 0) {
    list.innerHTML = '<div class="ann-empty">Ingen aktive beskjeder</div>';
    if (countLabel) countLabel.textContent = '';
    return;
  }
  if (countLabel) countLabel.textContent = active.length + ' aktiv' + (active.length !== 1 ? 'e' : '');
  list.innerHTML = active.map(a => {
    const [badgeClass, badgeLabel] = annBadgeMap[a.type] || annBadgeMap.info;
    const expiresLabel = a.expires ? '<span style="font-size:10.5px;color:var(--ok-muted)"> ¬∑ Utl\u00f8per ' + new Date(a.expires).toLocaleDateString('nb-NO') + '</span>' : '';
    return '<div class="ann-item">' +
      '<div class="ann-item-title"><span class="ann-badge ' + badgeClass + '">' + badgeLabel + '</span><span>' + a.title + '</span></div>' +
      '<div class="ann-item-body">' + a.body + '</div>' +
      '<div class="ann-item-meta">' + a.author + ' ¬∑ ' + a.date + expiresLabel + '</div>' +
      '</div>';
  }).join('');
}

function renderAnnAdminList() {
  const el = document.getElementById('ann-admin-list');
  if (!el) return;
  if (announcements.length === 0) {
    el.innerHTML = '<p style="font-size:13px;color:var(--ok-muted)">Ingen beskjeder lagt til enn√•.</p>';
    return;
  }
  el.innerHTML = announcements.map(a => {
    const [badgeClass, badgeLabel] = annBadgeMap[a.type] || annBadgeMap.info;
    return `
      <div style="display:flex;justify-content:space-between;align-items:flex-start;padding:12px 0;border-bottom:1px solid var(--ok-border)">
        <div>
          <span class="ann-badge ${badgeClass}" style="margin-right:6px">${badgeLabel}</span>
          <strong style="font-size:13.5px">${a.title}</strong>
          <div style="font-size:12.5px;color:var(--ok-muted);margin-top:3px">${a.body}</div>
          <div style="font-size:11px;color:#aab0c0;margin-top:2px">${a.author} ¬∑ ${a.date}</div>
        </div>
        <span class="edit-link" onclick="openAnnEdit('${a.id}')" style="margin-left:0">Rediger</span>
        <span class="delete-link" onclick="deleteAnnouncement('${a.id}')" style="margin-left:10px">Slett</span>
      </div>`;
  }).join('');
}

function saveAnnouncement() {
  const title = document.getElementById('ann-new-title').value.trim();
  const body = document.getElementById('ann-new-body').value.trim();
  if (!title || !body) { alert('Tittel og innhold er p√•krevd'); return; }
  const authorInput = document.getElementById('ann-new-author').value.trim();
  const expiresVal = document.getElementById('ann-new-expires')?.value || '';
  announcements.unshift({
    id: 'ann_' + Date.now(),
    title, body,
    type: document.getElementById('ann-new-type').value,
    date: new Date().toLocaleDateString('nb-NO'),
    expires: expiresVal || null,
    author: authorInput || (currentUser ? (roleCapabilities[currentUser.role]?.label || currentUser.username) : 'Administrator')
  });
  document.getElementById('ann-new-title').value = '';
  document.getElementById('ann-new-body').value = '';
  document.getElementById('ann-new-author').value = '';
  renderAnnouncements();
  renderAnnAdminList();
  recordActivity(`publiserte beskjed ¬´${title}¬ª`);
  showToast('üì¢ Beskjed publisert p√• forsiden');
  logActivity('Ny beskjed publisert: ' + title);
}

function deleteAnnouncement(id) {
  if (confirm('Slett denne beskjeden?')) {
    announcements = announcements.filter(a => a.id !== id);
    renderAnnouncements();
    renderAnnAdminList();
    logActivity('Beskjed slettet');
    showToast('üóë Beskjed slettet');
  }
}

// ============================================================
//  FERIEKALKULATOR
// ============================================================
function runKalkulator() {
  const alder    = parseInt(document.getElementById('kalk-alder').value) || 35;
  const lonn     = parseFloat(document.getElementById('kalk-lonn').value) || 0;
  const tillegg  = parseFloat(document.getElementById('kalk-tillegg').value) || 0;
  const fpOpptj  = parseFloat(document.getElementById('kalk-fpopptj').value) || 0;

  if (!lonn) {
    document.getElementById('kalk-result').classList.add('show');
    document.getElementById('kalk-result').innerHTML = '<div class="warn-box">‚ö†Ô∏è Fyll inn brutto m√•nedsl√∏nn i juni for √• beregne.</div>';
    return;
  }

  // ‚îÄ‚îÄ Ferierett (formell) ‚îÄ‚îÄ
  const ferierettDager = alder >= 60 ? 30 : 25;
  const fepieProsent   = alder >= 60 ? 14.3 : 12.0;
  const seniorLabel    = alder >= 60 ? '30 virkedager (over 60 √•r)' : '25 virkedager (under 60 √•r)';

  // ‚îÄ‚îÄ Dagsats: (m√•nedsl√∏nn + faste tillegg) / 22 arbeidsdager ‚îÄ‚îÄ
  const grunnlag  = lonn + tillegg;
  const dagsats   = grunnlag / 22;

  // ‚îÄ‚îÄ Teknisk l√∏nnstrekk: dagsats √ó ferierettdager ‚îÄ‚îÄ
  const trekkBeloep = dagsats * ferierettDager;

  // ‚îÄ‚îÄ Betalte feriedager: feriepenger / dagsats ‚îÄ‚îÄ
  // Antall dager ferieopptjeningen dekker
  let betalteDager = null;
  let betaltLabel  = '';
  if (fpOpptj > 0) {
    betalteDager = Math.min(Math.round((fpOpptj / dagsats) * 10) / 10, ferierettDager);
    betaltLabel  = betalteDager >= ferierettDager
      ? `${betalteDager} dager (full l√∏nn under all ferie)`
      : `${betalteDager} av ${ferierettDager} dager dekket av opptjente feriepenger`;
  }

  // ‚îÄ‚îÄ Render ‚îÄ‚îÄ
  const res = document.getElementById('kalk-result');
  res.classList.add('show');
  res.innerHTML = `
    <div class="calc-result-grid">
      <div class="calc-stat">
        <div class="cs-label">Ferierett (formell)</div>
        <div class="cs-value">${ferierettDager}</div>
        <div class="cs-sub">${seniorLabel}</div>
      </div>

      ${betalteDager !== null ? `
      <div class="calc-stat" style="background:#e0f4ec">
        <div class="cs-label">Betalte feriedager</div>
        <div class="cs-value" style="color:var(--ok-green)">${betalteDager}</div>
        <div class="cs-sub">${betaltLabel}</div>
      </div>` : ''}

      <div class="calc-stat">
        <div class="cs-label">Feriepengeprosent</div>
        <div class="cs-value">${fepieProsent} %</div>
        <div class="cs-sub">${alder >= 60 ? 'Senior (60+ √•r)' : 'Standard (under 60 √•r)'}</div>
      </div>

      <div class="calc-stat" style="background:#fde8ec">
        <div class="cs-label">Teknisk l√∏nnstrekk juni</div>
        <div class="cs-value" style="color:var(--ok-red)">‚àí ${Math.round(trekkBeloep).toLocaleString('nb-NO')}</div>
        <div class="cs-sub">kr  ¬∑  dagsats ${Math.round(dagsats).toLocaleString('nb-NO')} kr √ó ${ferierettDager} dager</div>
      </div>
    </div>

    <div class="calc-note" style="margin-top:14px">
      <strong>Slik er trekket beregnet:</strong><br>
      Grunnlag juni: ${grunnlag.toLocaleString('nb-NO')} kr
      ${tillegg > 0 ? ` (l√∏nn ${lonn.toLocaleString('nb-NO')} + tillegg ${tillegg.toLocaleString('nb-NO')})` : ''}  √∑ 
      22 arbeidsdager = <strong>${Math.round(dagsats).toLocaleString('nb-NO')} kr/dag</strong>
       √ó  ${ferierettDager} feriedager = <strong>${Math.round(trekkBeloep).toLocaleString('nb-NO')} kr trekk</strong>.
      ${fpOpptj > 0 ? ` Feriepengeopptjening: ${fpOpptj.toLocaleString('nb-NO')} kr dekker ${betalteDager} dager.` : ''}
      <br>Kilde: Ferieloven ¬ß¬ß 5 og 10, Dok 25 kap. 3. Alle tall er veiledende.
    </div>
  `;
}

// ============================================================
//  ADMIN TAB
// ============================================================
function adminTab(tab, el) {
  document.querySelectorAll('.admin-sidebar-item').forEach(i => i.classList.remove('active'));
  if (el) el.classList.add('active');
  ['admin-list','admin-new','admin-edit','admin-announcements','admin-site','admin-users','admin-categories','admin-dashboard','admin-changelog'].forEach(id => {
    const el2 = document.getElementById(id);
    if (el2) el2.style.display = 'none';
  });
  const panel = document.getElementById('admin-' + tab);
  if (panel) panel.style.display = 'block';
  if (tab === 'list') renderArticlesTable();
  if (tab === 'announcements') renderAnnAdminList();
  if (tab === 'site') loadSiteSettingsToForm();
  if (tab === 'users') renderUsersTable();
  if (tab === 'categories') renderCatAdmin();
  if (tab === 'dashboard') renderDashboard();
  if (tab === 'changelog') renderChangelog();
}

function renderArticlesTable() {
  const tbody = document.getElementById('articles-tbody');
  tbody.innerHTML = articles.map(a => {
    const status = a.status || 'active';
    const statusBadge = '<span class="status-badge status-' + status + '">' + status + '</span>';
    const newBadge = isNew(a.modified) ? '<span class="badge-new">Ny</span>' : '';
    return '<tr>' +
      '<td><strong>' + a.title + '</strong> ' + newBadge + '</td>' +
      '<td><span class="tag tag-blue">' + (a.tags[0]||'') + '</span></td>' +
      '<td>' + statusBadge + '</td>' +
      '<td>' + a.modified + '</td>' +
      '<td><span class="edit-link" onclick="editArticle(\'' + a.id + '\')">Rediger</span><span class="delete-link" onclick="confirmDelete(\'' + a.id + '\')">Slett</span></td>' +
      '</tr>';
  }).join('');
}

function editArticle(id) {
  const a = articles.find(x => x.id === id);
  if (!a) return;
  document.getElementById('edit-id').value = a.id;
  document.getElementById('edit-title').value = a.title;
  document.getElementById('edit-tags').value = a.tags.join(', ');
  document.getElementById('rte-edit').innerHTML = a.body;
  document.getElementById('edit-sources').value = a.sources;
  const editStatusEl = document.getElementById('edit-status');
  if (editStatusEl) editStatusEl.value = a.status || 'active';
  const editTabBtn = document.getElementById('tab-btn-edit');
  editTabBtn.style.display = 'flex';
  adminTab('edit', editTabBtn);
}

function saveEditArticle() {
  const id = document.getElementById('edit-id').value;
  const a = articles.find(x => x.id === id);
  if (!a) return;
  a.title    = document.getElementById('edit-title').value;
  a.tags     = document.getElementById('edit-tags').value.split(',').map(t => t.trim());
  a.body     = document.getElementById('rte-edit').innerHTML;
  a.sources  = document.getElementById('edit-sources').value;
  a.status   = document.getElementById('edit-status')?.value || 'active';
  a.modified = new Date().toLocaleDateString('nb-NO');
  recordActivity(`redigerte artikkelen ¬´${a.title}¬ª`);
  showToast('‚úÖ Artikkelen er oppdatert');
  renderRecentArticles();
  logActivity('Artikkel redigert: ' + a.title);
  document.getElementById('tab-btn-edit').style.display = 'none';
  adminTab('list', document.getElementById('tab-btn-list'));
}

function saveNewArticle() {
  const title = document.getElementById('new-title').value.trim();
  if (!title) { alert('Tittel er p√•krevd'); return; }
  const newStatus = document.getElementById('new-status')?.value || 'active';
  articles.push({
    id: 'custom_' + Date.now(),
    title,
    tags:     document.getElementById('new-tags').value.split(',').map(t => t.trim()),
    body:     document.getElementById('rte-new').innerHTML,
    sources:  document.getElementById('new-sources').value,
    status:   newStatus,
    modified: new Date().toLocaleDateString('nb-NO')
  });
  document.getElementById('new-title').value = '';
  document.getElementById('new-tags').value  = '';
  document.getElementById('rte-new').innerHTML = '';
  document.getElementById('new-sources').value = '';
  showToast('‚úÖ Ny artikkel er lagt til');
  logActivity('Ny artikkel: ' + title);
  recordActivity(`la til ny artikkel ¬´${title}¬ª`);
  renderRecentArticles();
  adminTab('list', document.getElementById('tab-btn-list'));
}

function confirmDelete(id) {
  if (confirm('Er du sikker p√• at du vil slette denne artikkelen?')) {
    articles = articles.filter(a => a.id !== id);
    renderArticlesTable();
    renderRecentArticles();
    showToast('üóë Artikkelen er slettet');
  }
}

function deleteArticle() {
  const id = document.getElementById('edit-id').value;
  confirmDelete(id);
  document.getElementById('tab-btn-edit').style.display = 'none';
  adminTab('list', document.getElementById('tab-btn-list'));
}

// ============================================================
//  SITE SETTINGS
// ============================================================
function loadSiteSettingsToForm() {
  const s = siteSettings;
  document.getElementById('site-topbar-left').value   = s.topbarLeft;
  document.getElementById('site-topbar-right').value  = s.topbarRight;
  document.getElementById('site-portal-name').value   = s.portalName;
  document.getElementById('site-portal-sub').value    = s.portalSub;
  document.getElementById('site-hero-title').value    = s.heroTitle;
  document.getElementById('site-hero-sub').value      = s.heroSub;
  document.getElementById('site-featured-title').value = s.featuredTitle;
  document.getElementById('site-ann-header').value    = s.annHeader;
  document.getElementById('site-recent-header').value = s.recentHeader;
  document.getElementById('site-footer1').value       = s.footer1;
  document.getElementById('site-footer2').value       = s.footer2;
  // Color pickers + hex fields
  const colors = { blue: s.colorBlue, red: s.colorRed, green: s.colorGreen, accent: s.colorAccent };
  Object.entries(colors).forEach(([name, val]) => {
    const pick = document.getElementById('site-color-' + name);
    const hex  = document.getElementById('site-color-' + name + '-hex');
    if (pick) pick.value = val;
    if (hex)  hex.value  = val;
  });
  // Quick tags as pipe-separated lines
  document.getElementById('site-quick-tags').value    = (s.quickTags || []).map(t => `${t.label}|${t.query}`).join('\n');
}

function saveSiteSettings() {
  const s = siteSettings;
  s.topbarLeft     = document.getElementById('site-topbar-left').value;
  s.topbarRight    = document.getElementById('site-topbar-right').value;
  s.portalName     = document.getElementById('site-portal-name').value;
  s.portalSub      = document.getElementById('site-portal-sub').value;
  s.heroTitle      = document.getElementById('site-hero-title').value;
  s.heroSub        = document.getElementById('site-hero-sub').value;
  s.featuredTitle  = document.getElementById('site-featured-title').value;
  s.annHeader      = document.getElementById('site-ann-header').value;
  s.recentHeader   = document.getElementById('site-recent-header').value;
  s.footer1        = document.getElementById('site-footer1').value;
  s.footer2        = document.getElementById('site-footer2').value;
  s.colorBlue      = document.getElementById('site-color-blue').value;
  s.colorRed       = document.getElementById('site-color-red').value;
  s.colorGreen     = document.getElementById('site-color-green').value;
  s.colorAccent    = document.getElementById('site-color-accent').value;
  // Parse quick tags
  const rawTags = document.getElementById('site-quick-tags').value;
  s.quickTags = rawTags.split('\n').map(line => {
    const [label, ...rest] = line.split('|');
    return { label: label.trim(), query: rest.join('|').trim() || label.trim() };
  }).filter(t => t.label);
  applySiteSettings();
  recordActivity('oppdaterte nettstedinnstillinger');
  showToast('‚úÖ Nettstedinnstillinger lagret og aktivert');
  logActivity('Nettstedinnstillinger oppdatert');
}

function applySiteSettings() {
  const s = siteSettings;

  // CSS variables (colors)
  const root = document.documentElement.style;
  root.setProperty('--ok-blue',   s.colorBlue);
  root.setProperty('--ok-red',    s.colorRed);
  root.setProperty('--ok-green',  s.colorGreen);
  root.setProperty('--ok-accent', s.colorAccent);
  root.setProperty('--ok-light',  s.colorLight);

  // Topbar
  const tbChildren = document.querySelector('.topbar').children;
  if (tbChildren[0]) tbChildren[0].textContent = s.topbarLeft;
  if (tbChildren[1]) tbChildren[1].textContent = s.topbarRight;

  // Logo
  document.querySelector('.logo-text h1').textContent = s.portalName;
  document.querySelector('.logo-text span').textContent = s.portalSub;

  // Hero
  document.querySelector('.hero h2').textContent = s.heroTitle;
  document.querySelector('.hero > p').textContent = s.heroSub;

  // Quick tags
  const qt = document.querySelector('.quick-tags');
  if (qt && s.quickTags) {
    qt.innerHTML = s.quickTags.map(t =>
      `<button onclick="quickSearch('${t.query.replace(/'/g,"\\'")}')"> ${t.label}</button>`
    ).join('');
  }

  // Section titles
  const featTitle = document.querySelector('.categories .section-title');
  if (featTitle) featTitle.textContent = s.featuredTitle;

  // Announcements + recent headers (only first child text node)
  const annHeader = document.querySelector('#ann-list')?.closest('.announcements-panel')?.querySelector('.ann-header');
  if (annHeader) {
    const countSpan = annHeader.querySelector('span');
    annHeader.childNodes.forEach(n => { if (n.nodeType === 3) n.textContent = s.annHeader + ' '; });
  }
  const recentHeader = document.querySelector('#recent-articles-list')?.closest('.announcements-panel')?.querySelector('.ann-header');
  if (recentHeader) recentHeader.textContent = s.recentHeader;

  // Footer
  const f1 = document.getElementById('footer-line1');
  const f2 = document.getElementById('footer-line2');
  if (f1) f1.textContent = s.footer1;
  if (f2) f2.textContent = s.footer2;

  // Page title
  document.title = s.portalName + ' ‚Äì Oslo Kommune';

  // Refresh inline editables if master is viewing
  if (currentUser && getUserCaps(currentUser).site) renderInlineEditors();
}

// Sync color picker ‚Üî hex input
function syncColor(name) {
  const hex  = document.getElementById('site-color-' + name + '-hex');
  const pick = document.getElementById('site-color-' + name);
  if (!hex || !pick) return;
  const val = hex.value.trim();
  if (/^#[0-9a-fA-F]{6}$/.test(val)) pick.value = val;
}

// When color picker changes, update hex field
document.addEventListener('input', e => {
  const m = e.target?.id?.match(/^site-color-(blue|red|green|accent)$/);
  if (m) {
    const hex = document.getElementById('site-color-' + m[1] + '-hex');
    if (hex) hex.value = e.target.value;
  }
});

// ‚îÄ‚îÄ Load color hex fields when opening site settings ‚îÄ‚îÄ
const _origLoadSettings = loadSiteSettingsToForm;
// (already defined inline ‚Äî hex sync happens inside loadSiteSettingsToForm)

// ‚îÄ‚îÄ Inline editing for master users ‚îÄ‚îÄ
// Add .site-editable wrappers to key elements so master can click-to-edit
const INLINE_EDITABLE = [
  { selector: '.topbar > span:first-child',  key: 'topbarLeft' },
  { selector: '#topbar-status',              key: 'topbarRight' },
  { selector: '.logo-text h1',               key: 'portalName' },
  { selector: '.logo-text span',             key: 'portalSub' },
  { selector: '.hero h2',                    key: 'heroTitle' },
  { selector: '.hero > p',                   key: 'heroSub' },
  { selector: '.categories .section-title',  key: 'featuredTitle' },
];

function renderInlineEditors() {
  const isMaster = currentUser && getUserCaps(currentUser).site;
  const hint = document.getElementById('master-edit-hint');
  if (hint) hint.style.display = isMaster ? 'block' : 'none';
  setMasterMode(isMaster);
  INLINE_EDITABLE.forEach(({ selector, key }) => {
    const el = document.querySelector(selector);
    if (!el) return;
    if (isMaster) {
      el.title = '‚úèÔ∏è Klikk for √• redigere';
      el.classList.add('master-editable');
      el.style.cursor = 'pointer';
      el.style.outline = '1.5px dashed rgba(255,255,255,.45)';
      el.style.borderRadius = '3px';
      el.onclick = (e) => { e.stopPropagation(); startInlineEdit(el, key); };
    } else {
      el.classList.remove('master-editable');
      el.title = '';
      el.style.cursor = '';
      el.style.outline = '';
      el.onclick = null;
    }
  });
  // Init dynamic sections
  renderFaqSection();
  renderContactSection();
  initSectionEditables();
}

function startInlineEdit(el, key) {
  if (el.dataset.editing) return;
  el.dataset.editing = '1';
  const original = el.textContent;
  const input = document.createElement('input');
  input.value = original;
  input.style.cssText = `font:inherit;color:inherit;background:rgba(255,255,255,.15);border:none;
    border-bottom:2px solid white;outline:none;padding:2px 4px;width:max(160px,${original.length}ch);
    max-width:100%;border-radius:3px 3px 0 0`;
  el.textContent = '';
  el.appendChild(input);
  input.focus(); input.select();
  const commit = () => {
    const val = input.value.trim() || original;
    siteSettings[key] = val;
    delete el.dataset.editing;
    el.removeChild(input);
    el.textContent = val;
    applySiteSettings();
    showToast(`‚úÖ ¬´${key}¬ª oppdatert`);
  };
  input.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); commit(); } if (e.key === 'Escape') { delete el.dataset.editing; el.removeChild(input); el.textContent = original; } });
  input.addEventListener('blur', commit);
}
// ============================================================
function formatCaps(u) {
  const capNames = {
    articles: 'Artikler', announcements: 'Beskjeder',
    categories: 'Kategorier', site: 'Nettsted', users: 'Brukere'
  };
  if (!u.caps) return roleCapabilities[u.role]?.label || u.role;
  const active = Object.entries(u.caps).filter(([,v]) => v).map(([k]) => capNames[k] || k);
  return active.length ? active.join(' ¬∑ ') : 'Ingen tilganger';
}

function getUserCaps(u) {
  // Explicitly set caps always win
  if (u.caps) return u.caps;
  // Built-in named roles keep their capabilities
  if (u.role === 'master') return roleCapabilities.master;
  if (u.role === 'okf')    return roleCapabilities.okf;
  if (u.role === 'hr')     return roleCapabilities.hr;
  // No caps set and no named role = portal-only
  return { articles: false, announcements: false, categories: false, site: false, users: false };
}

function renderUsersTable() {
  const tbody = document.getElementById('users-tbody');
  tbody.innerHTML = users.map(u => {
    const caps = getUserCaps(u);
    const isMasterProtected = u.username === 'master';
    const capBadges = [
      caps.articles      ? 'üìÑ Artikler' : null,
      caps.announcements ? 'üì¢ Beskjeder' : null,
      caps.categories    ? 'üóÇ Kategorier' : null,
      caps.site          ? 'üé® Nettsted' : null,
      caps.users         ? 'üë• Brukere' : null,
    ].filter(Boolean).map(t => `<span class="tag tag-blue" style="font-size:11px">${t}</span>`).join(' ');

    return `
    <tr id="user-row-${u.username}">
      <td><strong>${u.username}</strong></td>
      <td style="font-size:12px">${capBadges || '<span style="color:var(--ok-muted)">Ingen</span>'}</td>
      <td style="display:flex;gap:6px;align-items:center;flex-wrap:wrap">
        ${!isMasterProtected ? `
          <button class="cat-action-btn" onclick="openUserEdit('${u.username}')">Rediger</button>
          <span class="delete-link" onclick="deleteUser('${u.username}')">Slett</span>
        ` : '<span style="font-size:12px;color:var(--ok-muted)">Beskyttet</span>'}
      </td>
    </tr>`;
  }).join('');
}

function saveUser() {
  const name = document.getElementById('user-new-name').value.trim();
  const pass = document.getElementById('user-new-pass').value.trim();
  if (!name || !pass) { alert('Brukernavn og passord er p√•krevd'); return; }
  const caps = {
    articles:      document.getElementById('cap-articles').checked,
    announcements: document.getElementById('cap-announcements').checked,
    categories:    document.getElementById('cap-categories').checked,
    site:          document.getElementById('cap-site').checked,
    users:         document.getElementById('cap-users').checked,
  };
  const existing = users.findIndex(u => u.username === name);
  if (existing >= 0) {
    users[existing].password = pass;
    users[existing].caps     = caps;
    users[existing].role     = caps.users ? 'master' : 'okf';
    showToast(`‚úÖ Bruker ¬´${name}¬ª oppdatert`);
  } else {
    users.push({ username: name, password: pass, caps, role: caps.users ? 'master' : 'okf', label: name });
    showToast(`‚úÖ Bruker ¬´${name}¬ª opprettet`);
  }
  document.getElementById('user-new-name').value = '';
  document.getElementById('user-new-pass').value = '';
  // Default: no capabilities (portal-only user)
  document.getElementById('cap-articles').checked      = false;
  document.getElementById('cap-announcements').checked = false;
  document.getElementById('cap-categories').checked    = false;
  document.getElementById('cap-site').checked          = false;
  document.getElementById('cap-users').checked         = false;
  renderUsersTable();
}

function openUserEdit(username) {
  const u = users.find(x => x.username === username);
  if (!u) return;
  const caps = getUserCaps(u);
  document.getElementById('uedit-username').textContent = username;
  document.getElementById('uedit-name').value  = username;
  document.getElementById('uedit-pass').value  = '';
  document.getElementById('uedit-cap-articles').checked      = !!caps.articles;
  document.getElementById('uedit-cap-announcements').checked = !!caps.announcements;
  document.getElementById('uedit-cap-categories').checked    = !!caps.categories;
  document.getElementById('uedit-cap-site').checked          = !!caps.site;
  document.getElementById('uedit-cap-users').checked         = !!caps.users;
  document.getElementById('user-edit-modal').classList.add('show');
}
function closeUserEditModal() { document.getElementById('user-edit-modal').classList.remove('show'); }
function saveUserEdit() {
  const oldName = document.getElementById('uedit-name').value;
  const u = users.find(x => x.username === oldName);
  if (!u) return;
  const newPass = document.getElementById('uedit-pass').value.trim();
  if (newPass) u.password = newPass;
  u.caps = {
    articles:      document.getElementById('uedit-cap-articles').checked,
    announcements: document.getElementById('uedit-cap-announcements').checked,
    categories:    document.getElementById('uedit-cap-categories').checked,
    site:          document.getElementById('uedit-cap-site').checked,
    users:         document.getElementById('uedit-cap-users').checked,
  };
  u.role = u.caps.users ? 'master' : 'okf';
  closeUserEditModal();
  renderUsersTable();
  showToast(`‚úÖ Bruker ¬´${oldName}¬ª oppdatert`);
}

function previewRoleChange(username) {} // stub kept for compatibility
function saveInlineRole(username) {}    // stub kept for compatibility

// Profile modal
function openProfileModal() {
  if (!currentUser) return;
  document.getElementById('profile-username-display').textContent = currentUser.username;
  const caps = getUserCaps(currentUser);
  const capNames = { articles: 'üìÑ Artikler', announcements: 'üì¢ Beskjeder', categories: 'üóÇ Kategorier', site: 'üé® Nettsted', users: 'üë• Brukere' };
  document.getElementById('profile-caps-display').innerHTML = Object.entries(caps)
    .filter(([,v]) => v)
    .map(([k]) => `<span class="tag tag-blue" style="font-size:11px">${capNames[k]||k}</span>`)
    .join('');
  document.getElementById('profile-new-pass').value     = '';
  document.getElementById('profile-confirm-pass').value = '';
  const msg = document.getElementById('profile-msg');
  msg.style.display = 'none';
  document.getElementById('profile-modal').classList.add('show');
}
function closeProfileModal() { document.getElementById('profile-modal').classList.remove('show'); }
function saveProfilePassword() {
  const np = document.getElementById('profile-new-pass').value;
  const cp = document.getElementById('profile-confirm-pass').value;
  const msg = document.getElementById('profile-msg');
  if (!np) { showMsg(msg, 'Skriv inn et nytt passord.', 'warn'); return; }
  if (np !== cp) { showMsg(msg, 'Passordene stemmer ikke overens.', 'warn'); return; }
  if (np.length < 6) { showMsg(msg, 'Passordet m√• v√¶re minst 6 tegn.', 'warn'); return; }
  const u = users.find(x => x.username === currentUser.username);
  if (u) u.password = np;
  showMsg(msg, '‚úÖ Passord endret.', 'ok');
  document.getElementById('profile-new-pass').value     = '';
  document.getElementById('profile-confirm-pass').value = '';
}
function showMsg(el, text, type) {
  el.textContent = text;
  el.style.display = 'block';
  el.style.background = type === 'ok' ? '#e0f4ec' : '#fde8ec';
  el.style.color      = type === 'ok' ? 'var(--ok-green)' : 'var(--ok-red)';
}

function deleteUser(username) {
  if (username === currentUser?.username) { alert('Du kan ikke slette din egen bruker.'); return; }
  if (confirm(`Slett bruker ¬´${username}¬ª?`)) {
    users = users.filter(u => u.username !== username);
    renderUsersTable();
    logActivity('Bruker slettet: ' + username);
    showToast('üóë Bruker slettet');
  }
}

// ============================================================
//  AUTH
// ============================================================
function openLoginModal() {
  if (currentUser) { showPage('admin'); renderArticlesTable(); return; }
  document.getElementById('login-modal').classList.add('show');
  setTimeout(() => document.getElementById('login-user').focus(), 100);
}

function closeModal() {
  document.getElementById('login-modal').classList.remove('show');
  document.getElementById('login-err').style.display = 'none';
}

function doLogin() {
  const u = document.getElementById('login-user').value.trim().toLowerCase();
  const p = document.getElementById('login-pass').value;
  const found = users.find(x => x.username === u && x.password === p);
  if (found) {
    currentUser = found;
    const caps = getUserCaps(found);
    closeModal();

    const hasAnyAdminCap = caps.articles || caps.announcements || caps.categories || caps.site || caps.users;

    // Always show profile + logout in header
    document.getElementById('admin-nav-btn').style.display       = 'none';
    document.getElementById('header-profile-btn').style.display  = '';
    document.getElementById('header-logout-btn').style.display   = '';

    // Only show ‚öôÔ∏è Panel button if the user has at least one admin capability
    document.getElementById('admin-panel-btn').style.display = hasAnyAdminCap ? '' : 'none';

    // Announcements shortcut on home page
    document.getElementById('ann-admin-btn').style.display = caps.announcements ? 'block' : 'none';

    // Show/hide sidebar tabs based on individual caps
    document.getElementById('tab-btn-dashboard').style.display      = 'flex';
    document.getElementById('tab-btn-list').style.display          = caps.articles      ? 'flex' : 'none';
    document.getElementById('tab-btn-new').style.display           = caps.articles      ? 'flex' : 'none';
    document.getElementById('tab-btn-categories').style.display    = caps.categories    ? 'flex' : 'none';
    document.getElementById('tab-btn-announcements').style.display = caps.announcements ? 'flex' : 'none';
    document.getElementById('tab-btn-changelog').style.display      = 'flex';
    document.getElementById('tab-btn-site').style.display          = caps.site          ? 'flex' : 'none';
    document.getElementById('tab-btn-users').style.display         = caps.users         ? 'flex' : 'none';

    // Section headers
    const contentSection = document.querySelector('.admin-sidebar-section');
    if (contentSection) contentSection.style.display = (caps.articles || caps.categories) ? 'block' : 'none';
    document.getElementById('master-section').style.display = (caps.site || caps.users) ? 'block' : 'none';

    // Update admin header identity
    document.getElementById('admin-user-label').textContent = `Innlogget som: ${found.username}`;
    const roleCap = roleCapabilities[found.role];
    document.getElementById('admin-role-badge').innerHTML =
      `<span class="role-badge ${roleCap?.badge || 'role-okf'}">${found.label || found.username}</span>`;

    renderActivityFooter();
    renderInlineEditors();

    if (hasAnyAdminCap) {
      // Send to admin panel, land on dashboard
      showPage('admin');
      adminTab('dashboard', document.getElementById('tab-btn-dashboard'));
    } else {
      // Portal-only user ‚Äî stay on home page
      showPage('home');
      showToast(`‚úÖ Innlogget som ${found.username}`);
    }

    if (hasAnyAdminCap) showToast('\u2705 Innlogget som ' + found.username);
    // Start session timer
    startSessionTimer();
    // Update mobile nav
    const mobLogin = document.getElementById('mob-login'); if(mobLogin) mobLogin.style.display='none';
    const mobAdmin = document.getElementById('mob-admin'); if(mobAdmin) mobAdmin.style.display = hasAnyAdminCap ? 'flex' : 'none';
    const mobLogout = document.getElementById('mob-logout'); if(mobLogout) mobLogout.style.display='flex';
    addToFullLog('Logget inn');
  } else {
    document.getElementById('login-err').style.display = 'block';
  }
}

function logout() {
  currentUser = null;
  // Header nav
  document.getElementById('admin-nav-btn').style.display      = '';
  document.getElementById('header-profile-btn').style.display = 'none';
  document.getElementById('admin-panel-btn').style.display    = 'none';
  document.getElementById('header-logout-btn').style.display  = 'none';
  document.getElementById('ann-admin-btn').style.display      = 'none';
  // Restore all sidebar tabs to default visible state
  ['tab-btn-dashboard','tab-btn-list','tab-btn-new','tab-btn-categories','tab-btn-announcements','tab-btn-changelog'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.style.display = 'flex';
  });
  document.getElementById('tab-btn-edit').style.display   = 'none';
  document.getElementById('tab-btn-site').style.display   = 'none';
  document.getElementById('tab-btn-users').style.display  = 'none';
  document.getElementById('master-section').style.display = 'none';
  const contentSection = document.querySelector('.admin-sidebar-section');
  if (contentSection) contentSection.style.display = 'block';
  renderActivityFooter();
  renderInlineEditors();
  // Clear session timer
  clearTimeout(sessionTimer); clearTimeout(sessionWarningTimer); clearInterval(countdownInterval);
  document.getElementById('session-warning').style.display = 'none';
  // Update mobile nav
  const mobLogin2 = document.getElementById('mob-login'); if(mobLogin2) mobLogin2.style.display='flex';
  const mobAdmin2 = document.getElementById('mob-admin'); if(mobAdmin2) mobAdmin2.style.display='none';
  const mobLogout2 = document.getElementById('mob-logout'); if(mobLogout2) mobLogout2.style.display='none';
  showPage('home');
  showToast('Du er n\u00e5 logget ut');
}

// ============================================================
//  RICH TEXT EDITOR
// ============================================================
function rteCmd(which, cmd) {
  document.getElementById('rte-' + which).focus();
  document.execCommand(cmd, false, null);
}
function rteHeading(which) {
  const editor = document.getElementById('rte-' + which);
  editor.focus();
  const sel = window.getSelection();
  if (sel.rangeCount) {
    const range = sel.getRangeAt(0);
    const h3 = document.createElement('h3');
    h3.appendChild(range.extractContents());
    range.insertNode(h3);
    range.setStartAfter(h3); range.collapse(true);
    sel.removeAllRanges(); sel.addRange(range);
  }
}
function rteInsertBox(which, type) {
  const editor = document.getElementById('rte-' + which);
  editor.focus();
  const cls = type === 'info' ? 'info-box' : 'warn-box';
  const prefix = type === 'info' ? 'üìå ' : '‚ö†Ô∏è ';
  const div = document.createElement('div');
  div.className = cls;
  div.innerHTML = prefix + 'Skriv tekst her...';
  div.contentEditable = 'true';
  const sel = window.getSelection();
  if (sel.rangeCount) {
    const range = sel.getRangeAt(0);
    range.collapse(false);
    range.insertNode(div);
    range.setStartAfter(div); range.collapse(true);
    sel.removeAllRanges(); sel.addRange(range);
  } else {
    editor.appendChild(div);
  }
}

// ============================================================
//  BLOCK PANEL ‚Äì inline avsnittorganisering
// ============================================================
// Assigns each top-level child of the editor a stable data-bid attribute
// so we can track identity across re-renders.
let _bidCounter = 0;
function ensureBids(editor) {
  Array.from(editor.children).forEach(el => {
    if (!el.dataset.bid) el.dataset.bid = ++_bidCounter;
  });
}

function getBlockMeta(el) {
  const tag = el.tagName ? el.tagName.toLowerCase() : '';
  const cls = el.className || '';
  const text = (el.textContent || '').trim().replace(/\s+/g, ' ').substring(0, 55);
  if (cls.includes('calc-box'))     return { icon: 'üßÆ', type: 'Kalkulator', label: 'Feriekalkulator' };
  if (cls.includes('info-box'))     return { icon: '‚ÑπÔ∏è', type: 'Inforamme',  label: text || 'Inforamme' };
  if (cls.includes('warn-box'))     return { icon: '‚ö†Ô∏è', type: 'Advarsel',   label: text || 'Advarselboks' };
  if (tag === 'h3')                 return { icon: 'üî†', type: 'Overskrift', label: text || 'Overskrift' };
  if (tag === 'ul' || tag === 'ol') return { icon: 'üìã', type: 'Liste',      label: text || 'Listeelement' };
  if (tag === 'table')              return { icon: 'üóÉ', type: 'Tabell',     label: text || 'Tabell' };
  return                                   { icon: '¬∂',  type: 'Avsnitt',    label: text || '(tomt avsnitt)' };
}

function toggleBlockPanel(which) {
  const panel  = document.getElementById('block-panel-' + which);
  const btn    = document.getElementById('block-panel-btn-' + which);
  const editor = document.getElementById('rte-' + which);
  if (!panel || !editor) return;

  const isOpen = panel.style.display !== 'none';
  if (isOpen) {
    panel.style.display = 'none';
    btn.style.background = '';
    btn.style.color = '';
  } else {
    renderBlockPanel(which);
    panel.style.display = 'flex';
    btn.style.background = 'var(--ok-blue)';
    btn.style.color = 'white';
  }
}

function renderBlockPanel(which) {
  const panel  = document.getElementById('block-panel-' + which);
  const editor = document.getElementById('rte-' + which);
  if (!panel || !editor) return;

  ensureBids(editor);
  const blocks = Array.from(editor.children).filter(el => el.nodeType === 1);
  if (blocks.length === 0) {
    panel.innerHTML = '<div class="block-panel-header">Ingen avsnitt enn√• ‚Äî skriv noe i editoren f√∏rst.</div>';
    return;
  }

  panel.innerHTML = '<div class="block-panel-header">‚áÖ Klikk ‚Üë ‚Üì for √• flytte et avsnitt opp eller ned. Endringer skjer umiddelbart i editoren.</div>' +
    blocks.map((el, i) => {
      const { icon, type, label } = getBlockMeta(el);
      const safe = label.replace(/</g, '<').replace(/>/g, '>');
      return `
      <div class="block-row" id="brow-${which}-${i}">
        <button class="block-move-btn" onclick="blockPanelMove('${which}',${i},-1)" ${i === 0 ? 'disabled' : ''} title="Flytt opp">‚Üë</button>
        <button class="block-move-btn" onclick="blockPanelMove('${which}',${i},1)"  ${i === blocks.length - 1 ? 'disabled' : ''} title="Flytt ned">‚Üì</button>
        <span class="block-type-tag">${icon} ${type}</span>
        <span class="block-preview">${safe || '<em style="color:var(--ok-muted)">tomt avsnitt</em>'}</span>
      </div>`;
    }).join('');
}

function blockPanelMove(which, idx, dir) {
  const editor = document.getElementById('rte-' + which);
  if (!editor) return;
  const blocks = Array.from(editor.children).filter(el => el.nodeType === 1);
  const newIdx = idx + dir;
  if (newIdx < 0 || newIdx >= blocks.length) return;

  // Swap the two DOM nodes live ‚Äî no need for apply step
  const a = blocks[idx];
  const b = blocks[newIdx];
  if (dir === -1) {
    editor.insertBefore(a, b);   // move a before b
  } else {
    editor.insertBefore(b, a);   // move b before a
  }

  // Re-render the panel to reflect new order
  renderBlockPanel(which);

  // Flash highlight the moved row
  const newRow = document.getElementById('brow-' + which + '-' + idx);
  if (newRow) {
    newRow.classList.add('block-active');
    setTimeout(() => newRow.classList.remove('block-active'), 600);
  }
}

// ============================================================
//  CATEGORIES ‚Äì CARD GRID
// ============================================================
function renderCardGrid() {
  const grid = document.getElementById('card-grid');
  if (!grid) return;
  grid.innerHTML = categories.map(c => `
    <div class="card" onclick="openArticle('${c.link}')">
      <div class="card-icon" style="background:${c.color}">${c.icon}</div>
      <h3>${c.title}</h3>
      <p>${c.desc}</p>
    </div>`).join('');
}

function renderCatAdmin() {
  const list = document.getElementById('cat-list');
  if (!list) return;

  if (categories.length === 0) {
    list.innerHTML = '<p style="font-size:13px;color:var(--ok-muted);padding:8px 0">Ingen fremhevede artikler enn√•. Legg til en nedenfor.</p>';
  } else {
    list.innerHTML = categories.map((c, i) => `
      <div class="cat-item" draggable="true" data-id="${c.id}"
           ondragstart="catDragStart(event,'${c.id}')"
           ondragover="catDragOver(event)"
           ondrop="catDrop(event,'${c.id}')"
           ondragleave="catDragLeave(event)">
        <span class="cat-drag-handle">‚†ø</span>
        <div class="cat-icon-preview" style="background:${c.color}">${c.icon}</div>
        <div class="cat-item-info">
          <strong>${c.title}</strong>
          <span>${c.desc}</span>
        </div>
        <div class="cat-item-actions">
          <button class="cat-action-btn" onclick="openCatEdit('${c.id}')">Endre ikon</button>
          <button class="cat-action-btn danger" onclick="deleteCategory('${c.id}')">Fjern</button>
        </div>
      </div>`).join('');
  }

  // Build icon + color pickers only once
  if (!document.getElementById('cat-new-icon-picker').dataset.built) {
    buildIconPicker('cat-new-icon-picker', 'cat-new-icon-val', 'üìÑ');
    buildColorPicker('cat-new-color-picker', 'cat-new-color-val', '#e0e8f7');
    document.getElementById('cat-new-icon-val').value  = 'üìÑ';
    document.getElementById('cat-new-color-val').value = '#e0e8f7';
    document.getElementById('cat-new-icon-picker').dataset.built = '1';
  }
}

// ‚îÄ‚îÄ Article search for featured panel ‚îÄ‚îÄ
function featSearch() {
  const q = document.getElementById('feat-search').value.trim().toLowerCase();
  const resultsEl = document.getElementById('feat-search-results');
  if (!q) { resultsEl.style.display = 'none'; return; }

  const alreadyFeatured = new Set(categories.map(c => c.link));
  const matches = articles.filter(a => {
    const hay = (a.title + ' ' + a.tags.join(' ')).toLowerCase();
    return hay.includes(q);
  });

  if (matches.length === 0) {
    resultsEl.innerHTML = '<div style="padding:10px 14px;font-size:13px;color:var(--ok-muted)">Ingen artikler funnet</div>';
  } else {
    resultsEl.innerHTML = matches.map(a => {
      const isFeatured = alreadyFeatured.has(a.id);
      return `<div onclick="${isFeatured ? '' : `selectFeatArticle('${a.id}','${a.title.replace(/'/g,"\\'")}','${a.tags[0] || ''}')`}"
        style="padding:10px 14px;cursor:${isFeatured ? 'default' : 'pointer'};border-bottom:1px solid var(--ok-border);
               font-size:13px;display:flex;align-items:center;justify-content:space-between;
               ${isFeatured ? 'opacity:.5' : 'hover:background:var(--ok-accent)'}">
        <span><strong>${a.title}</strong><br><span style="font-size:11.5px;color:var(--ok-muted)">${a.tags.slice(0,3).join(' ¬∑ ')}</span></span>
        ${isFeatured ? '<span style="font-size:11px;color:var(--ok-blue);font-weight:600">Allerede fremhevet</span>' : '<span style="font-size:11px;color:var(--ok-green)">Velg ‚Üí</span>'}
      </div>`;
    }).join('');
  }
  resultsEl.style.display = 'block';
}

function selectFeatArticle(id, title, tag) {
  document.getElementById('feat-search').value = title;
  document.getElementById('feat-selected-id').value = id;
  document.getElementById('feat-selected-label').textContent = title;
  const selBox = document.getElementById('feat-selected-article');
  selBox.style.display = 'block';
  document.getElementById('feat-search-results').style.display = 'none';
}

function addFeatured() {
  const articleId = document.getElementById('feat-selected-id').value.trim();
  if (!articleId) { showToast('‚ö†Ô∏è Velg en artikkel fra s√∏ket f√∏rst'); return; }

  if (categories.find(c => c.link === articleId)) {
    showToast('‚ö†Ô∏è Denne artikkelen er allerede fremhevet'); return;
  }

  const article = articles.find(a => a.id === articleId);
  if (!article) { showToast('Artikkel ikke funnet'); return; }

  categories.push({
    id: 'cat_' + Date.now(),
    icon:  document.getElementById('cat-new-icon-val').value  || 'üìÑ',
    color: document.getElementById('cat-new-color-val').value || '#e0e8f7',
    title: article.title,
    desc:  stripTags(article.body).substring(0, 100) + '‚Ä¶',
    link:  article.id
  });

  // Reset form
  document.getElementById('feat-search').value = '';
  document.getElementById('feat-selected-id').value = '';
  document.getElementById('feat-selected-label').textContent = '';
  document.getElementById('feat-selected-article').style.display = 'none';
  document.getElementById('feat-search-results').style.display = 'none';
  document.getElementById('cat-new-icon-picker').dataset.built = '';
  buildIconPicker('cat-new-icon-picker', 'cat-new-icon-val', 'üìÑ');
  buildColorPicker('cat-new-color-picker', 'cat-new-color-val', '#e0e8f7');
  document.getElementById('cat-new-icon-val').value  = 'üìÑ';
  document.getElementById('cat-new-color-val').value = '#e0e8f7';
  document.getElementById('cat-new-icon-picker').dataset.built = '1';

  renderCardGrid();
  renderCatAdmin();
  recordActivity(`fremhevet artikkel ¬´${article.title}¬ª`);
  showToast(`‚≠ê ¬´${article.title}¬ª er n√• fremhevet p√• forsiden`);
}

function buildIconPicker(pickerId, valId, current) {
  const el = document.getElementById(pickerId);
  if (!el) return;
  el.innerHTML = ICONS.map(ic => `
    <div class="icon-opt${ic === current ? ' selected' : ''}"
         data-val="${ic}" data-picker="${pickerId}" data-target="${valId}"
         onclick="selectIcon(this)">${ic}</div>
  `).join('');
}
function buildColorPicker(pickerId, valId, current) {
  const el = document.getElementById(pickerId);
  if (!el) return;
  el.innerHTML = COLORS.map(cl => `
    <div class="color-opt${cl === current ? ' selected' : ''}"
         style="background:${cl}" data-val="${cl}" data-picker="${pickerId}" data-target="${valId}"
         onclick="selectColor(this)"></div>
  `).join('');
}
function selectIcon(el) {
  const pickerId = el.dataset.picker;
  const valId    = el.dataset.target;
  document.getElementById(valId).value = el.dataset.val;
  document.querySelectorAll('#' + pickerId + ' .icon-opt').forEach(e => e.classList.remove('selected'));
  el.classList.add('selected');
}
function selectColor(el) {
  const pickerId = el.dataset.picker;
  const valId    = el.dataset.target;
  document.getElementById(valId).value = el.dataset.val;
  document.querySelectorAll('#' + pickerId + ' .color-opt').forEach(e => e.classList.remove('selected'));
  el.classList.add('selected');
}

function deleteCategory(id) {
  if (!confirm('Fjerne denne artikkelen fra fremhevede?')) return;
  const c = categories.find(x => x.id === id);
  categories = categories.filter(c => c.id !== id);
  renderCardGrid();
  renderCatAdmin();
  showToast('üóë Artikkel fjernet fra fremhevede');
}

function openCatEdit(id) {
  const c = categories.find(x => x.id === id);
  if (!c) return;
  document.getElementById('cat-edit-id').value = c.id;
  document.getElementById('cat-edit-article-label').textContent = c.title;
  buildIconPicker('cat-edit-icon-picker', 'cat-edit-icon-val', c.icon);
  document.getElementById('cat-edit-icon-val').value  = c.icon;
  buildColorPicker('cat-edit-color-picker', 'cat-edit-color-val', c.color);
  document.getElementById('cat-edit-color-val').value = c.color;
  document.getElementById('cat-edit-modal').classList.add('show');
}
function closeCatEditModal() { document.getElementById('cat-edit-modal').classList.remove('show'); }
function saveCatEdit() {
  const id = document.getElementById('cat-edit-id').value;
  const c = categories.find(x => x.id === id);
  if (!c) return;
  c.icon  = document.getElementById('cat-edit-icon-val').value;
  c.color = document.getElementById('cat-edit-color-val').value;
  closeCatEditModal();
  renderCardGrid();
  renderCatAdmin();
  recordActivity(`endret ikon p√• ¬´${c.title}¬ª`);
  showToast('‚úÖ Ikon oppdatert');
}

// ‚îÄ‚îÄ Drag & drop reorder ‚îÄ‚îÄ
let dragSrcId = null;
function catDragStart(e, id) { dragSrcId = id; e.target.classList.add('dragging'); e.dataTransfer.effectAllowed = 'move'; }
function catDragOver(e) { e.preventDefault(); e.currentTarget.classList.add('drag-over'); return false; }
function catDragLeave(e) { e.currentTarget.classList.remove('drag-over'); }
function catDrop(e, targetId) {
  e.stopPropagation(); e.preventDefault();
  e.currentTarget.classList.remove('drag-over');
  if (dragSrcId === targetId) return;
  const srcIdx = categories.findIndex(c => c.id === dragSrcId);
  const tgtIdx = categories.findIndex(c => c.id === targetId);
  const [moved] = categories.splice(srcIdx, 1);
  categories.splice(tgtIdx, 0, moved);
  renderCardGrid();
  renderCatAdmin();
  saveToStorage();
}

// ============================================================
//  ANNOUNCEMENT EDIT
// ============================================================
function openAnnEdit(id) {
  const a = announcements.find(x => x.id === id);
  if (!a) return;
  document.getElementById('ann-edit-id').value     = a.id;
  document.getElementById('ann-edit-title').value  = a.title;
  document.getElementById('ann-edit-body').value   = a.body;
  document.getElementById('ann-edit-type').value   = a.type;
  document.getElementById('ann-edit-author').value = a.author;
  document.getElementById('ann-edit-modal').classList.add('show');
}
function closeAnnEditModal() { document.getElementById('ann-edit-modal').classList.remove('show'); }
function saveAnnEdit() {
  const id = document.getElementById('ann-edit-id').value;
  const a = announcements.find(x => x.id === id);
  if (!a) return;
  a.title  = document.getElementById('ann-edit-title').value;
  a.body   = document.getElementById('ann-edit-body').value;
  a.type   = document.getElementById('ann-edit-type').value;
  a.author = document.getElementById('ann-edit-author').value;
  closeAnnEditModal();
  renderAnnouncements();
  renderAnnAdminList();
  recordActivity(`redigerte beskjed ¬´${a.title}¬ª`);
  showToast('‚úÖ Beskjed oppdatert');
  logActivity('Beskjed redigert: ' + a.title);
}

// ============================================================
//  ACTIVITY LOG
// ============================================================
let lastActivity = null; // { user, action, time }

function recordActivity(action) {
  const now = new Date();
  const timeStr = now.toLocaleDateString('nb-NO') + ' kl. ' + now.toLocaleTimeString('nb-NO', { hour: '2-digit', minute: '2-digit' });
  lastActivity = { user: currentUser?.username || 'ukjent', action, time: timeStr };
  renderActivityFooter();
  addToFullLog(action);
}

function renderActivityFooter() {
  const el = document.getElementById('footer-activity');
  if (!el || !lastActivity) return;
  const isLoggedIn = !!currentUser;
  if (isLoggedIn) {
    el.textContent = `üïê Sist oppdatert: ${lastActivity.time} av ${lastActivity.user} (${lastActivity.action})`;
  } else {
    el.textContent = `üïê Sist oppdatert: ${lastActivity.time}`;
  }
  el.style.display = 'block';
}

// ============================================================
//  ACTIVITY LOG ‚Äì sist oppdatert
// ============================================================
let activityLog = []; // { time, action, user }

function logActivity(action) {
  if (!currentUser) return;
  const now = new Date();
  const timeStr = now.toLocaleDateString('nb-NO') + ' kl. ' + now.toLocaleTimeString('nb-NO', { hour: '2-digit', minute: '2-digit' });
  const entry = { time: timeStr, action, user: currentUser.username, role: currentUser.role };
  activityLog.unshift(entry);
  if (activityLog.length > 50) activityLog.pop();
  updateLastUpdatedBar();
}

function updateLastUpdatedBar() {
  if (!currentUser || activityLog.length === 0) return;
  const bar = document.getElementById('last-updated-bar');
  const textEl = document.getElementById('last-updated-text');
  const whoEl  = document.getElementById('last-updated-who');
  if (!bar) return;
  const latest = activityLog[0];
  bar.style.display = 'flex';
  textEl.textContent = 'üïê Sist oppdatert: ' + latest.time + ' ‚Äì ' + latest.action;
  // All logged-in roles (okf, hr, master) can see who updated
  whoEl.textContent = 'av ' + latest.user + ' (' + roleCapabilities[latest.role]?.label + ')';
}

// ============================================================
//  TOAST
// ============================================================
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
  // Auto-save on any action that shows a toast (except warnings/login/logout)
  const skip = ['‚ö†Ô∏è', 'Logg', 'Innlogget', 'Passord', 'Allerede'];
  if (!skip.some(s => msg.startsWith(s))) {
    saveToStorage();
  }
}


// ============================================================
//  ENTERPRISE FEATURES
// ============================================================

// ‚îÄ‚îÄ FULL ACTIVITY LOG (persisted) ‚îÄ‚îÄ
let fullLog = []; // [{time, user, action}]

function addToFullLog(action) {
  if (!currentUser) return;
  const now = new Date();
  const entry = {
    time: now.toLocaleDateString('nb-NO') + ' kl. ' + now.toLocaleTimeString('nb-NO', {hour:'2-digit',minute:'2-digit'}),
    user: currentUser.username,
    role: currentUser.role || 'bruker',
    action
  };
  fullLog.unshift(entry);
  if (fullLog.length > 200) fullLog = fullLog.slice(0, 200);
  saveFullLog();
}

function saveFullLog() {
  try { localStorage.setItem('ferieportalen_log', JSON.stringify(fullLog)); } catch(e) {}
}
function loadFullLog() {
  try { const r = localStorage.getItem('ferieportalen_log'); if (r) fullLog = JSON.parse(r); } catch(e) {}
}

// ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ
function renderDashboard() {
  // Stats
  const active = articles.filter(a => !a.status || a.status === 'active').length;
  const draft  = articles.filter(a => a.status === 'draft').length;
  const archiv = articles.filter(a => a.status === 'archived').length;
  const favCount = Object.keys(getFavorites()).length;
  const statsEl = document.getElementById('dash-stats');
  if (statsEl) {
    statsEl.innerHTML = `
      <div class="stat-card"><div class="sc-num">${articles.length}</div><div class="sc-label">Totalt artikler</div></div>
      <div class="stat-card green"><div class="sc-num">${active}</div><div class="sc-label">Aktive artikler</div></div>
      <div class="stat-card"><div class="sc-num">${draft}</div><div class="sc-label">Utkast</div></div>
      <div class="stat-card"><div class="sc-num">${announcements.length}</div><div class="sc-label">Aktive beskjeder</div></div>
      <div class="stat-card green"><div class="sc-num">${categories.length}</div><div class="sc-label">Fremhevede</div></div>
      <div class="stat-card"><div class="sc-num">${users.length}</div><div class="sc-label">Brukere</div></div>
    `;
  }
  // Activity log preview
  const actEl = document.getElementById('dash-activity-log');
  if (actEl) {
    if (fullLog.length === 0) {
      actEl.innerHTML = '<p style="color:var(--ok-muted);font-size:13px">Ingen aktivitet registrert enn√•.</p>';
    } else {
      actEl.innerHTML = fullLog.slice(0, 8).map(e =>
        `<div style="padding:7px 0;border-bottom:1px solid var(--ok-border);font-size:13px;display:flex;gap:10px;align-items:flex-start">
          <span style="color:var(--ok-muted);flex-shrink:0;font-size:11.5px;min-width:140px">${e.time}</span>
          <span><strong style="color:var(--ok-blue)">${e.user}</strong> ‚Äì ${e.action}</span>
        </div>`
      ).join('');
    }
  }
  // Announcements preview
  const annPrev = document.getElementById('dash-announcements-preview');
  if (annPrev) {
    if (announcements.length === 0) {
      annPrev.innerHTML = '<p style="color:var(--ok-muted);font-size:13px">Ingen aktive beskjeder.</p>';
    } else {
      annPrev.innerHTML = announcements.slice(0,3).map(a => {
        const [cls] = annBadgeMap[a.type] || annBadgeMap.info;
        return `<div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--ok-border)">
          <span class="ann-badge ${cls}" style="flex-shrink:0">${a.type}</span>
          <span style="font-size:13px;font-weight:500">${a.title}</span>
          <span style="font-size:11.5px;color:var(--ok-muted);margin-left:auto">${a.date}</span>
        </div>`;
      }).join('');
    }
  }
  // Recent articles preview
  const artPrev = document.getElementById('dash-recent-articles-preview');
  if (artPrev) {
    const sorted = [...articles].sort((a,b) => {
      const p = d => { const x=(d||'').split('.'); return x.length===3?new Date(x[2],x[1]-1,x[0]):new Date(0); };
      return p(b.modified)-p(a.modified);
    }).slice(0,5);
    artPrev.innerHTML = sorted.map(a =>
      `<div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--ok-border);cursor:pointer" onclick="editArticle('${a.id}')">
        <span class="status-badge status-${a.status||'active'}" style="flex-shrink:0">${a.status||'aktiv'}</span>
        <span style="font-size:13px;font-weight:500;color:var(--ok-blue)">${a.title}</span>
        <span style="font-size:11.5px;color:var(--ok-muted);margin-left:auto">${a.modified}</span>
        ${isNew(a.modified) ? '<span class="badge-new">Ny</span>' : ''}
      </div>`
    ).join('');
  }
}

// ‚îÄ‚îÄ CHANGELOG ‚îÄ‚îÄ
function renderChangelog() {
  const tbody = document.getElementById('changelog-tbody');
  if (!tbody) return;
  if (fullLog.length === 0) {
    tbody.innerHTML = '<tr><td colspan="3" style="color:var(--ok-muted);text-align:center;padding:20px">Ingen hendelser registrert enn√•.</td></tr>';
    return;
  }
  tbody.innerHTML = fullLog.map(e =>
    `<tr>
      <td style="white-space:nowrap;color:var(--ok-muted)">${e.time}</td>
      <td><strong>${e.user}</strong> <span style="font-size:11px;color:var(--ok-muted)">(${e.role})</span></td>
      <td>${e.action}</td>
    </tr>`
  ).join('');
}

function exportChangelog() {
  if (fullLog.length === 0) { showToast('‚ö†Ô∏è Ingen logg √• eksportere'); return; }
  const rows = [['Tidspunkt','Bruker','Rolle','Handling'],...fullLog.map(e=>[e.time,e.user,e.role,e.action])];
  const csv = rows.map(r=>r.map(v=>'"'+String(v).replace(/"/g,'""')+'"').join(',')).join('\n');
  const a = document.createElement('a');
  a.href = 'data:text/csv;charset=utf-8,Ôªø' + encodeURIComponent(csv);
  a.download = 'ferieportalen_logg_' + new Date().toLocaleDateString('nb-NO').replace(/\./g,'-') + '.csv';
  a.click();
}

function clearChangelog() {
  if (!confirm('T√∏m hele endringsloggen? Dette kan ikke angres.')) return;
  fullLog = [];
  saveFullLog();
  renderChangelog();
  showToast('üóë Endringslogg t√∏mt');
}

// ‚îÄ‚îÄ FAQ TOGGLE ‚îÄ‚îÄ
function toggleFaq(qEl) {
  const aEl = qEl.nextElementSibling;
  const isOpen = aEl.classList.contains('open');
  // Close all
  document.querySelectorAll('.faq-q').forEach(q => {
    q.classList.remove('open');
    q.setAttribute('aria-expanded','false');
    q.nextElementSibling.classList.remove('open');
  });
  if (!isOpen) {
    qEl.classList.add('open');
    qEl.setAttribute('aria-expanded','true');
    aEl.classList.add('open');
  }
}

// ‚îÄ‚îÄ FAVORITES ‚îÄ‚îÄ
function getFavorites() {
  try { return JSON.parse(localStorage.getItem('fp_favorites') || '{}'); } catch(e) { return {}; }
}
function setFavorites(obj) {
  try { localStorage.setItem('fp_favorites', JSON.stringify(obj)); } catch(e) {}
}
function toggleFavorite(articleId) {
  const favs = getFavorites();
  if (favs[articleId]) {
    delete favs[articleId];
    setFavorites(favs);
    showToast('Fjernet fra favoritter');
    return false;
  } else {
    const a = articles.find(x => x.id === articleId);
    if (a) favs[articleId] = { title: a.title, id: articleId, added: new Date().toLocaleDateString('nb-NO') };
    setFavorites(favs);
    showToast('‚≠ê Lagt til i favoritter');
    return true;
  }
}
function isFavorite(articleId) { return !!getFavorites()[articleId]; }

function showFavorites() {
  const favs = getFavorites();
  const list = document.getElementById('favs-list');
  if (!list) return;
  const keys = Object.keys(favs);
  if (keys.length === 0) {
    list.innerHTML = '<p style="color:var(--ok-muted);font-size:13.5px;text-align:center;padding:20px 0">Du har ingen favorittartikler enn√•.<br>Klikk ‚≠ê i en artikkel for √• lagre den her.</p>';
  } else {
    list.innerHTML = keys.map(id => {
      const f = favs[id];
      return `<div style="display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--ok-border)">
        <span style="font-size:18px">‚≠ê</span>
        <div style="flex:1">
          <div style="font-size:13.5px;font-weight:500;color:var(--ok-blue);cursor:pointer" onclick="document.getElementById('favs-modal').classList.remove('show');openArticle('${id}')">${f.title}</div>
          <div style="font-size:11.5px;color:var(--ok-muted)">Lagret ${f.added}</div>
        </div>
        <button class="cat-action-btn danger" onclick="removeFav('${id}')">Fjern</button>
      </div>`;
    }).join('');
  }
  document.getElementById('favs-modal').classList.add('show');
}

function removeFav(id) {
  const favs = getFavorites();
  delete favs[id];
  setFavorites(favs);
  showFavorites();
}

// ‚îÄ‚îÄ IS NEW (published within 30 days) ‚îÄ‚îÄ
function isNew(dateStr) {
  if (!dateStr) return false;
  const p = dateStr.split('.');
  if (p.length !== 3) return false;
  const d = new Date(p[2], p[1]-1, p[0]);
  return (Date.now() - d.getTime()) < 30 * 24 * 60 * 60 * 1000;
}

// ‚îÄ‚îÄ READING TIME ‚îÄ‚îÄ
function calcReadingTime(html) {
  const words = stripTags(html).split(/\s+/).filter(Boolean).length;
  const mins = Math.max(1, Math.round(words / 200));
  return mins === 1 ? '1 min lesetid' : mins + ' min lesetid';
}

// ‚îÄ‚îÄ RELATED ARTICLES ‚îÄ‚îÄ
function getRelatedArticles(article, count) {
  if (!article) return [];
  const scores = articles
    .filter(a => a.id !== article.id && (!a.status || a.status === 'active'))
    .map(a => {
      let s = 0;
      article.tags.forEach(t => {
        if (a.tags.includes(t)) s += 3;
      });
      // shared words in title
      const titleWords = article.title.toLowerCase().split(/\s+/);
      titleWords.forEach(w => { if (w.length > 3 && a.title.toLowerCase().includes(w)) s += 2; });
      return { a, s };
    })
    .filter(x => x.s > 0)
    .sort((x,y) => y.s - x.s)
    .slice(0, count);
  return scores.map(x => x.a);
}

// ‚îÄ‚îÄ ARTICLE FEEDBACK ‚îÄ‚îÄ
function submitFeedback(articleId, isPositive) {
  const btns = document.querySelectorAll('.feedback-btn');
  btns.forEach(b => b.classList.remove('selected-yes','selected-no'));
  const targetBtn = isPositive ? btns[0] : btns[1];
  if (targetBtn) targetBtn.classList.add(isPositive ? 'selected-yes' : 'selected-no');
  const fbMsg = document.getElementById('feedback-msg');
  if (fbMsg) {
    fbMsg.textContent = isPositive
      ? '‚úÖ Takk for tilbakemeldingen!'
      : 'üìß Takk! Vurder √• kontakte l√∏nnstjenesten dersom du ikke fant svaret.';
    fbMsg.style.display = 'block';
    fbMsg.style.color = isPositive ? 'var(--ok-green)' : 'var(--ok-muted)';
  }
  // Store feedback (anonymous)
  try {
    const key = 'fp_fb_' + articleId;
    const existing = JSON.parse(localStorage.getItem(key) || '{"yes":0,"no":0}');
    existing[isPositive ? 'yes' : 'no']++;
    localStorage.setItem(key, JSON.stringify(existing));
  } catch(e) {}
}

// ‚îÄ‚îÄ MOBILE NAV ‚îÄ‚îÄ
function openMobileNav() {
  document.getElementById('mobile-overlay').classList.add('open');
  document.getElementById('mobile-nav-panel').classList.add('open');
  document.body.style.overflow = 'hidden';
}
function closeMobileNav() {
  document.getElementById('mobile-overlay').classList.remove('open');
  document.getElementById('mobile-nav-panel').classList.remove('open');
  document.body.style.overflow = '';
}

// ‚îÄ‚îÄ SESSION TIMER ‚îÄ‚îÄ
let sessionTimer = null;
let sessionWarningTimer = null;
const SESSION_TIMEOUT = 30 * 60 * 1000;   // 30 min
const SESSION_WARNING  = 25 * 60 * 1000;   // warn at 25 min
let countdownInterval = null;

function startSessionTimer() {
  clearTimeout(sessionTimer);
  clearTimeout(sessionWarningTimer);
  clearInterval(countdownInterval);
  document.getElementById('session-warning').style.display = 'none';
  if (!currentUser) return;
  sessionWarningTimer = setTimeout(() => {
    document.getElementById('session-warning').style.display = 'block';
    let secs = 5 * 60;
    countdownInterval = setInterval(() => {
      secs--;
      const m = Math.floor(secs / 60), s = secs % 60;
      const cd = document.getElementById('session-countdown');
      if (cd) cd.textContent = m + ':' + String(s).padStart(2,'0');
      if (secs <= 0) { clearInterval(countdownInterval); logout(); }
    }, 1000);
  }, SESSION_WARNING);
  sessionTimer = setTimeout(() => { clearInterval(countdownInterval); logout(); }, SESSION_TIMEOUT);
}

function resetSessionTimer() {
  document.getElementById('session-warning').style.display = 'none';
  clearInterval(countdownInterval);
  startSessionTimer();
}

// Reset timer on user interaction
['click','keydown','scroll','mousemove'].forEach(evt => {
  document.addEventListener(evt, () => { if (currentUser) resetSessionTimer(); }, { passive: true });
});

// ‚îÄ‚îÄ SEARCH FILTERS (state) ‚îÄ‚îÄ
let lastSearchResults = [];
let lastSearchQuery   = '';

function applySearchFilters() {
  if (!lastSearchResults.length && !lastSearchQuery) return;
  let results = [...lastSearchResults];
  const sort   = document.getElementById('filter-sort')?.value || 'relevance';
  const status = document.getElementById('filter-status')?.value || 'all';

  if (status !== 'all') results = results.filter(r => (r.a.status || 'active') === status);

  if (sort === 'newest') {
    results.sort((x,y) => {
      const p = d => { const s=(d||'').split('.'); return s.length===3?new Date(s[2],s[1]-1,s[0]):new Date(0); };
      return p(y.a.modified) - p(x.a.modified);
    });
  } else if (sort === 'oldest') {
    results.sort((x,y) => {
      const p = d => { const s=(d||'').split('.'); return s.length===3?new Date(s[2],s[1]-1,s[0]):new Date(0); };
      return p(x.a.modified) - p(y.a.modified);
    });
  } else if (sort === 'az') {
    results.sort((x,y) => x.a.title.localeCompare(y.a.title, 'nb'));
  }

  renderSearchResults(results, lastSearchQuery);
}

function clearFilters() {
  const s = document.getElementById('filter-sort');
  const f = document.getElementById('filter-status');
  if (s) s.value = 'relevance';
  if (f) f.value = 'all';
  applySearchFilters();
}

function renderSearchResults(results, q) {
  document.getElementById('results-count').textContent =
    results.length === 0 ? 'Ingen treff' :
    results.length === 1 ? '1 treff' : results.length + ' treff';
  const original = (q || '').toLowerCase().split(/\s+/).filter(Boolean);
  const list = document.getElementById('results-list');
  if (results.length === 0) {
    list.innerHTML = `<div class="result-item"><h4>Ingen treff for ¬´${q}¬ª</h4><p>Pr√∏v kortere s√∏keord, eller bla gjennom fremhevede artikler p√• forsiden.</p></div>`;
    return;
  }
  list.innerHTML = results.map(({ a }) => {
    let excerpt = stripTags(a.body).substring(0, 200);
    original.forEach(term => {
      const re = new RegExp('(' + term.replace(/[.*+?^${}()|[\]\\]/g,'\\$&') + ')', 'gi');
      excerpt = excerpt.replace(re, '<mark>$1</mark>');
    });
    const newBadge = isNew(a.modified) ? '<span class="badge-new">Ny</span>' : '';
    const statusLabel = a.status && a.status !== 'active' ? `<span class="status-badge status-${a.status}" style="margin-left:4px">${a.status}</span>` : '';
    return `<div class="result-item" onclick="openArticle('${a.id}')">
      <h4>${a.title}${newBadge}${statusLabel}</h4>
      <p>${excerpt}‚Ä¶</p>
      <div class="result-meta">
        ${a.tags.slice(0,4).map(t=>'<span class="tag tag-blue">'+t+'</span>').join('')}
        <span class="tag tag-green">üìÖ ${a.modified}</span>
      </div>
    </div>`;
  }).join('');
}

// ‚îÄ‚îÄ PRINT ARTICLE ‚îÄ‚îÄ
function printArticle() { window.print(); }

// ‚îÄ‚îÄ UPDATE MOBILE NAV state on login/logout ‚îÄ‚îÄ
const _origDoLogin  = doLogin;
const _origLogout   = logout;

// ‚îÄ‚îÄ ANNOUNCE PAGE TRANSITIONS TO SCREENREADERS ‚îÄ‚îÄ
function announceToSR(msg) {
  let el = document.getElementById('sr-announce');
  if (!el) { el = document.createElement('div'); el.id='sr-announce'; el.setAttribute('aria-live','polite'); el.setAttribute('aria-atomic','true'); el.style.cssText='position:absolute;width:1px;height:1px;overflow:hidden;clip:rect(0,0,0,0)'; document.body.appendChild(el); }
  el.textContent = msg;
}


// ============================================================
//  LOCALSTORAGE PERSISTENCE
// ============================================================
const LS_KEY = 'ferieportalen_v1';

function saveToStorage() {
  try {
    localStorage.setItem(LS_KEY, JSON.stringify({
      articles,
      categories,
      users,
      announcements,
      siteSettings,
    }));
  } catch(e) {
    console.warn('localStorage ikke tilgjengelig:', e);
  }
}

function loadFromStorage() {
  try {
    const raw = localStorage.getItem(LS_KEY);
    if (!raw) return false;
    const data = JSON.parse(raw);
    if (data.articles)      articles      = data.articles;
    if (data.categories)    categories    = data.categories;
    if (data.users)         users         = data.users;
    if (data.announcements) announcements = data.announcements;
    if (data.siteSettings)  Object.assign(siteSettings, data.siteSettings);
    return true;
  } catch(e) {
    console.warn('Feil ved lasting fra localStorage:', e);
    return false;
  }
  // Also loads fullLog
}

function resetStorage() {
  if (!confirm('Dette sletter alle dine endringer og tilbakestiller portalen til original innhold. Er du sikker?')) return;
  localStorage.removeItem(LS_KEY);
  location.reload();
}

// ============================================================
//  MASTER INLINE EDITING SYSTEM
// ============================================================

let _ieCurrentType = null;   // 'contact' | 'faq' | 'section' | 'simple'
let _ieCurrentId   = null;   // id of item being edited
let _ieCurrentKey  = null;   // siteSettings key for simple edits

// ‚îÄ‚îÄ Activate / deactivate master mode ‚îÄ‚îÄ
function setMasterMode(on) {
  document.body.classList.toggle('master-mode', on);
  const bar = document.getElementById('master-hint-bar');
  if (bar) bar.classList.toggle('visible', on);
  const oldHint = document.getElementById('master-edit-hint');
  if (oldHint) oldHint.style.display = on ? 'block' : 'none';
}

// ‚îÄ‚îÄ Render FAQ from siteSettings.faqs ‚îÄ‚îÄ
function renderFaqSection() {
  const el = document.getElementById('faq-list');
  if (!el) return;
  const s = siteSettings;
  const h2 = document.getElementById('faq-heading');
  if (h2) { h2.textContent = s.faqTitle || '‚ùì Vanlige sp√∏rsm√•l'; }
  const isMaster = currentUser && getUserCaps(currentUser).site;

  el.innerHTML = (s.faqs || []).map(f => `
    <div class="faq-item" data-faq-id="${f.id}">
      ${isMaster ? `<div class="faq-item-actions">
        <button class="cc-btn" onclick="openFaqEdit('${f.id}')">‚úè</button>
        <button class="cc-btn danger" onclick="deleteFaqItem('${f.id}')">√ó</button>
      </div>` : ''}
      <div class="faq-q" onclick="toggleFaq(this)" role="button" aria-expanded="false">
        ${f.q}
        <span class="faq-arrow">‚ñ∂</span>
      </div>
      <div class="faq-a">${f.a}</div>
    </div>`).join('');

  if (isMaster) {
    const addBtn = el.parentElement.querySelector('.master-add-btn.faq-add');
    if (!addBtn) {
      const btn = document.createElement('button');
      btn.className = 'master-add-btn faq-add';
      btn.innerHTML = 'Ôºã Legg til sp√∏rsm√•l';
      btn.onclick = () => openFaqEdit(null);
      el.parentElement.appendChild(btn);
    }
  }
}

// ‚îÄ‚îÄ Render Contact section from siteSettings.contacts ‚îÄ‚îÄ
function renderContactSection() {
  const grid = document.getElementById('contact-grid');
  const titleEl = document.getElementById('contact-heading');
  const introEl = document.getElementById('contact-intro');
  if (!grid) return;
  const s = siteSettings;
  if (titleEl) titleEl.textContent = s.contactTitle || 'üìû Kontakt og hjelp';
  if (introEl) introEl.textContent = s.contactIntro || '';
  const isMaster = currentUser && getUserCaps(currentUser).site;

  grid.innerHTML = (s.contacts || []).map(c => {
    const links = (c.web || '').split('\n').filter(Boolean).map(w => {
      const [label, url] = w.split('|');
      return url ? `<p><strong>üåê</strong> <a href="${url}" target="_blank">${label}</a></p>` : `<p>${label}</p>`;
    }).join('');
    const phone = c.phone ? `<p><strong>üìû</strong> ${c.phone}</p>` : '';
    const email = c.email ? `<p><strong>üìß</strong> ${c.email}</p>` : '';
    const note  = c.note  ? `<p style="font-size:11.5px;color:var(--ok-muted);margin-top:6px">${c.note}</p>` : '';
    const body  = c.body  ? `<p>${c.body}</p>` : '';
    return `
      <div class="contact-card" data-contact-id="${c.id}">
        ${isMaster ? `<div class="contact-card-actions">
          <button class="cc-btn" onclick="openContactEdit('${c.id}')">‚úè Rediger</button>
          <button class="cc-btn danger" onclick="deleteContactCard('${c.id}')">√ó</button>
        </div>` : ''}
        <h4>${c.icon} ${c.title}</h4>
        ${body}${phone}${email}${links}${note}
      </div>`;
  }).join('');

  if (isMaster) {
    let addBtn = grid.parentElement.querySelector('.master-add-btn.contact-add');
    if (!addBtn) {
      addBtn = document.createElement('button');
      addBtn.className = 'master-add-btn contact-add';
      addBtn.innerHTML = 'Ôºã Legg til kontaktkort';
      addBtn.onclick = () => openContactEdit(null);
      grid.parentElement.appendChild(addBtn);
    }
  }
}

// ‚îÄ‚îÄ Section title inline edit (faqTitle, contactTitle, contactIntro) ‚îÄ‚îÄ
function initSectionEditables() {
  const isMaster = currentUser && getUserCaps(currentUser).site;
  document.querySelectorAll('.master-editable-section[data-section-key]').forEach(el => {
    if (isMaster) {
      el.title = '‚úèÔ∏è Klikk for √• redigere';
      el.onclick = (e) => {
        e.stopPropagation();
        const key = el.dataset.sectionKey;
        openSimpleEdit(key, el.tagName.match(/^H/) ? 'Tittel' : 'Tekst', siteSettings[key] || '');
      };
    } else {
      el.onclick = null;
      el.title = '';
    }
  });
}

// ‚îÄ‚îÄ FAQ edit modal ‚îÄ‚îÄ
function openFaqEdit(id) {
  const isNew = !id;
  const f = id ? (siteSettings.faqs || []).find(x => x.id === id) : { id: 'f_' + Date.now(), q: '', a: '' };
  if (!f) return;
  _ieCurrentType = 'faq';
  _ieCurrentId   = f.id;

  document.getElementById('ie-modal-title').textContent = isNew ? '‚ûï Nytt sp√∏rsm√•l' : '‚úèÔ∏è Rediger sp√∏rsm√•l';
  document.getElementById('ie-modal-delete').style.display = isNew ? 'none' : '';
  document.getElementById('ie-modal-fields').innerHTML = `
    <label>Sp√∏rsm√•l</label>
    <input id="ie-f-q" value="${escHtml(f.q)}" placeholder="Skriv sp√∏rsm√•let her‚Ä¶">
    <label>Svar <span style="font-weight:400;text-transform:none;font-size:12px">(HTML tillatt: &lt;strong&gt;, &lt;em&gt;, &lt;a href=‚Ä¶&gt;)</span></label>
    <textarea id="ie-f-a">${f.a}</textarea>
  `;
  openInlineModal();
}

function openContactEdit(id) {
  const isNew = !id;
  const c = id ? (siteSettings.contacts || []).find(x => x.id === id) : { id: 'c_' + Date.now(), icon: 'üìã', title: '', body: '', phone: '', email: '', web: '', note: '' };
  if (!c) return;
  _ieCurrentType = 'contact';
  _ieCurrentId   = c.id;

  document.getElementById('ie-modal-title').textContent = isNew ? '‚ûï Nytt kontaktkort' : '‚úèÔ∏è Rediger kontaktkort';
  document.getElementById('ie-modal-delete').style.display = isNew ? 'none' : '';
  document.getElementById('ie-modal-fields').innerHTML = `
    <div style="display:grid;grid-template-columns:60px 1fr;gap:10px;align-items:end">
      <div><label>Ikon</label><input id="ie-c-icon" value="${escHtml(c.icon)}" style="text-align:center;font-size:20px"></div>
      <div><label>Tittel</label><input id="ie-c-title" value="${escHtml(c.title)}"></div>
    </div>
    <label>Beskrivelsestekst</label>
    <textarea id="ie-c-body" style="min-height:70px">${escHtml(c.body)}</textarea>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
      <div><label>Telefon</label><input id="ie-c-phone" value="${escHtml(c.phone)}" placeholder="F.eks. 02 180"></div>
      <div><label>E-post</label><input id="ie-c-email" value="${escHtml(c.email)}" placeholder="F.eks. hr@oslo.kommune.no"></div>
    </div>
    <label>Lenker <span style="font-weight:400;text-transform:none;font-size:12px">(√©n per linje: Visningsnavn|https://url.no)</span></label>
    <textarea id="ie-c-web" style="min-height:80px;font-family:monospace;font-size:12px">${escHtml(c.web)}</textarea>
    <label>Notat / √•pningstid</label>
    <input id="ie-c-note" value="${escHtml(c.note)}">
  `;
  openInlineModal();
}

function openSimpleEdit(key, label, currentVal) {
  _ieCurrentType = 'simple';
  _ieCurrentKey  = key;
  document.getElementById('ie-modal-title').textContent = '‚úèÔ∏è Rediger: ' + label;
  document.getElementById('ie-modal-delete').style.display = 'none';
  document.getElementById('ie-modal-fields').innerHTML = `
    <label>${label}</label>
    <input id="ie-simple-val" value="${escHtml(currentVal)}">
  `;
  openInlineModal();
}

function openInlineModal() {
  document.getElementById('inline-edit-modal').classList.add('open');
  setTimeout(() => {
    const first = document.querySelector('#ie-modal-fields input, #ie-modal-fields textarea');
    if (first) { first.focus(); first.select && first.select(); }
  }, 80);
}

function closeInlineModal() {
  document.getElementById('inline-edit-modal').classList.remove('open');
  _ieCurrentType = null; _ieCurrentId = null; _ieCurrentKey = null;
}

function saveInlineModal() {
  if (_ieCurrentType === 'faq') {
    const q = document.getElementById('ie-f-q').value.trim();
    const a = document.getElementById('ie-f-a').value.trim();
    if (!q) { alert('Sp√∏rsm√•l kan ikke v√¶re tomt'); return; }
    if (!siteSettings.faqs) siteSettings.faqs = [];
    const idx = siteSettings.faqs.findIndex(x => x.id === _ieCurrentId);
    if (idx >= 0) { siteSettings.faqs[idx].q = q; siteSettings.faqs[idx].a = a; }
    else siteSettings.faqs.push({ id: _ieCurrentId, q, a });
    renderFaqSection();
    showToast('‚úÖ FAQ oppdatert');
    addToFullLog('Redigerte FAQ: ' + q.substring(0, 50));

  } else if (_ieCurrentType === 'contact') {
    const icon  = document.getElementById('ie-c-icon').value.trim() || 'üìã';
    const title = document.getElementById('ie-c-title').value.trim();
    const body  = document.getElementById('ie-c-body').value.trim();
    const phone = document.getElementById('ie-c-phone').value.trim();
    const email = document.getElementById('ie-c-email').value.trim();
    const web   = document.getElementById('ie-c-web').value.trim();
    const note  = document.getElementById('ie-c-note').value.trim();
    if (!title) { alert('Tittel kan ikke v√¶re tom'); return; }
    if (!siteSettings.contacts) siteSettings.contacts = [];
    const idx = siteSettings.contacts.findIndex(x => x.id === _ieCurrentId);
    const obj = { id: _ieCurrentId, icon, title, body, phone, email, web, note };
    if (idx >= 0) siteSettings.contacts[idx] = obj;
    else siteSettings.contacts.push(obj);
    renderContactSection();
    showToast('‚úÖ Kontaktkort oppdatert');
    addToFullLog('Redigerte kontaktkort: ' + title);

  } else if (_ieCurrentType === 'simple') {
    const val = document.getElementById('ie-simple-val').value.trim();
    siteSettings[_ieCurrentKey] = val;
    applySiteSettings();
    renderFaqSection();
    renderContactSection();
    showToast('‚úÖ Lagret');
    addToFullLog('Redigerte: ' + _ieCurrentKey);
  }

  saveToStorage();
  closeInlineModal();
}

function deleteInlineItem() {
  if (_ieCurrentType === 'faq') {
    if (!confirm('Slett dette sp√∏rsm√•let?')) return;
    siteSettings.faqs = (siteSettings.faqs || []).filter(x => x.id !== _ieCurrentId);
    renderFaqSection();
    showToast('üóë Sp√∏rsm√•l slettet');
  } else if (_ieCurrentType === 'contact') {
    if (!confirm('Slett dette kontaktkortet?')) return;
    siteSettings.contacts = (siteSettings.contacts || []).filter(x => x.id !== _ieCurrentId);
    renderContactSection();
    showToast('üóë Kontaktkort slettet');
  }
  saveToStorage();
  closeInlineModal();
}

function deleteFaqItem(id) {
  if (!confirm('Slett dette sp√∏rsm√•let?')) return;
  siteSettings.faqs = (siteSettings.faqs || []).filter(x => x.id !== id);
  renderFaqSection(); saveToStorage();
  showToast('üóë Sp√∏rsm√•l slettet');
}

function deleteContactCard(id) {
  if (!confirm('Slett dette kontaktkortet?')) return;
  siteSettings.contacts = (siteSettings.contacts || []).filter(x => x.id !== id);
  renderContactSection(); saveToStorage();
  showToast('üóë Kontaktkort slettet');
}

function escHtml(s) {
  return (s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// Enter in modal fields = save
document.addEventListener('keydown', e => {
  if (e.key === 'Enter' && e.target.tagName === 'INPUT' && document.getElementById('inline-edit-modal').classList.contains('open')) {
    e.preventDefault(); saveInlineModal();
  }
  if (e.key === 'Escape' && document.getElementById('inline-edit-modal').classList.contains('open')) {
    closeInlineModal();
  }
});


// ============================================================
//  INIT
// ============================================================
loadFromStorage();
loadFullLog();
applySiteSettings();
renderArticlesTable();
renderAnnouncements();
renderCardGrid();
renderRecentArticles();
renderFaqSection();
renderContactSection();
</script>
</body>
</html>
